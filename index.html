<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>自動車保険 更新手続き（完全版・修正版・保存用）</title>
<!-- Version: full-2025-11-28-apply-1128v2-with-add-screens-and-progress27 -->

<!-- START: styles -->
<style>
  :root {
    --blue-900:#0f3d7a; --blue-800:#1f5fbf; --blue-700:#2b6fd6; --blue-600:#2562c1; --blue-500:#3c7fe6;
    --bg:#f5f7fb; --card:#ffffff; --text:#1a1a1a; --sub:#445066; --border:#d7e0f0;
    --orange:#e86f00; --orange-700:#c95f00; --alert:#b00020; --safe:#0b7a3e; --purple:#6f42c1;
    --curBg:#eef7ff; --newBg:#eef9f1; --deltaBg:#fff7e6; --red:#a00000; --yellow:#ffec99;
    --face:#e0f2ff; --face-border:#90caf9;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    background: linear-gradient(160deg, #f9fbff 0%, #eef3fb 55%, #eaf0fa 100%);
    background-attachment: fixed;
  }
  @media (prefers-color-scheme:dark){
    body{ background: linear-gradient(160deg, #161b23 0%, #1b2330 60%, #1f2a3a 100%); }
  }

  .wrap{max-width:430px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}

  /* ヘッダー2段構成 */
  header{
    position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);
    padding:6px 10px;display:flex;flex-direction:column;gap:6px;z-index:10
  }
  .headerTop{display:flex;align-items:center;justify-content:space-between;gap:6px}
  .toolbar{display:flex;gap:6px;align-items:center}
  header .btn{font-size:13px;color:var(--blue-800);text-decoration:none;padding:4px 6px}
  .toggleLarge{border:1px solid var(--border);border-radius:6px;padding:4px 8px;background:#fff;color:var(--blue-900);cursor:pointer;font-size:13px}
  .aiAgent{display:flex;align-items:center;gap:6px;cursor:pointer}
  .aiRobot{width:28px;height:28px;border-radius:8px;background:
    radial-gradient(circle at 9px 11px,#fff 4px,#3c7fe6 5px,#3c7fe6 9px,transparent 10px),
    radial-gradient(circle at 19px 11px,#fff 4px,#3c7fe6 5px,#3c7fe6 9px,transparent 10px),
    linear-gradient(180deg,#6f42c1,#3c7fe6);
    border:2px solid #d7e0f0}
  .aiLabel{font-size:12px;color:var(--blue-900)}

  .progress{padding:6px 0 2px 0;font-size:12px;color:var(--blue-900);display:grid;gap:4px;background:#fff}
  .bar{height:8px;background:#e8eefb;border-radius:999px;overflow:hidden}
  .bar div{ height:8px;background:var(--blue-800);width:0%;transition:width .25s ease-out;border-radius:999px; }

  main{flex:1;padding-bottom:90px}
  .screen{display:none}.screen.active{display:block}

  :root { --sp-8:8px; --sp-12:12px; --sp-16:16px; }

  .card{
    background:#fff;margin: var(--sp-12) var(--sp-12); padding: var(--sp-12); border-radius:12px;
    box-shadow:0 2px 8px rgba(15,61,122,.08); border:1px solid var(--border)
  }
  .card + .card{ margin-top: var(--sp-16); }

  .h1{ font-size:16px; font-weight:600; color:var(--blue-900); margin-top:0; margin-bottom:var(--sp-8); letter-spacing:.01em; }
  .desc{font-size:13px;color:var(--sub);line-height:1.55; letter-spacing:.01em;}
  .list,.item{font-size:13px;color:#222;line-height:1.55;margin: var(--sp-8) 0; letter-spacing:.005em;}
  .field{margin-top: var(--sp-12)}
  .label{font-size:13px;color:var(--blue-900);margin-bottom: var(--sp-8)}
  .input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
  .input:focus,select:focus,textarea:focus{outline:2px solid var(--blue-500);border-color:var(--blue-500)}
  .btnPrimary{
    display:block;width:100%;padding:12px;border-radius:12px;font-size:15px;font-weight:700;text-align:center;border:none;cursor:pointer;margin-top:10px;background:#e86f00;color:#fff;
    transition:transform .06s ease, box-shadow .12s ease; box-shadow:0 2px 0 rgba(15,61,122,.08);
  }
  .btnPrimary:active{background:#c95f00}
  .link{color:var(--blue-800);text-decoration:none;font-size:13px}
  .blockLink{display:inline-block;margin-top:6px}
  .redNote{color:var(--red);font-size:12px;margin-top:4px}

  .priceTable{width:100%;border-collapse:collapse;margin-top: var(--sp-8)}
  .priceTable th, .priceTable td{border:1px solid var(--border);padding:8px;font-size:13px;text-align:right}
  .priceTable th{background:#f6f8fc;color:var(--blue-900);text-align:center}
  .rowLabel{width:28%;text-align:left;background:#f9fafc;color:var(--blue-900);font-weight:700}
  .rowCurrent{background:var(--curBg)} .rowNew{background:var(--newBg)} .rowDelta{background:var(--deltaBg)}
  .dpos{color:var(--safe);font-weight:700} .dneg{color:var(--alert);font-weight:700}

  .colorRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .colorBtn{display:flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--blue-800);background:#fff;color:var(--blue-800);border-radius:10px;cursor:pointer;flex:1}
  .colorBtn.active{outline:2px solid var(--blue-800);background:#eef4ff}
  .swatch{width:16px;height:16px;border-radius:4px;border:1px solid #ccc}
  .gold{background:#ffd54f} .blue{background:#3c7fe6} .green{background:#0b7a3e}

  .infoRow{display:flex;align-items:center;gap:8px;margin-top:8px}
  :root { --icon:20px; }
  .infoIcon{ width:var(--icon); height:var(--icon); border-radius:50%; background:var(--yellow); color:#1a1a1a;
    display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; border:1px solid #e0c24f; }
  .videoIcon{ width:var(--icon); height:var(--icon); }
  .aiRobot{ border-radius:8px; }
  .videoCta{ line-height:1.35; }

  .foldCard{border:1px solid var(--border);border-radius:12px;padding: var(--sp-12);background:#fff;margin: var(--sp-12) 0;}
  .foldCard .foldHeader{ font-weight:600; color:var(--blue-900); padding-bottom: var(--sp-8); border-bottom:1px solid rgba(215,224,240,0.8); }
  .foldCard .foldBody{ margin-top: var(--sp-8); }
  .foldCard .foldSub{ font-size:12px; color:var(--sub); margin-top: var(--sp-8); line-height:1.55; }
  @media (prefers-color-scheme:dark){ .foldCard .foldHeader{ border-bottom-color: rgba(215,224,240,0.25); } }

  footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:6px 10px;z-index:20}
  .footerRow{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .ghost{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:13px;color:var(--blue-900);line-height:1.2}
  .supportItem{padding:8px;border:1px solid var(--blue-800);color:var(--blue-800);background:#fff;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;font-size:13px;line-height:1.2;min-width:90px}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:12px;padding:12px;width:min(92vw,420px);border:1px solid var(--border)}
  .modal .box .h1{margin-top:0;font-size:16px}

  #toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:rgba(15,61,122,.95);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;display:none;z-index:9999}

  .licenseSheet{border:2px solid #1f5fbf;border-radius:8px;padding:8px;position:relative;background:#fff}
  .licRow{display:flex;gap:8px;align-items:center;margin:6px 0}
  .licBox{border:1px solid #cfd8ea;border-radius:4px;padding:6px 8px;font-size:12px;color:var(--blue-900);background:#fff;flex:1;white-space:nowrap}
  .licBox.wide{flex:2} .licBox.red{border-color:#d32f2f} .licBox.short{max-width:calc(100% - 110px)} .licBox.equal{flex:1}
  .faceBox{position:absolute;right:10px;bottom:10px;width:90px;height:110px;background:#e0f2ff;border:1px solid var(--face-border);border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--blue-900);font-size:12px}

  .otpRow{display:flex;gap:8px;margin-top:8px}
  .otpBox{width:54px;height:54px;border:2px solid var(--blue-500);border-radius:10px;text-align:center;font-size:22px;line-height:1;background:#fff}
  .otpBox:focus{outline:3px solid var(--blue-500);}

  .videoCta{display:flex;align-items:center;gap:10px;background:var(--blue-800);color:#fff;padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:700;font-size:14px;margin-top:8px}
  .videoCta:active{opacity:.9}

  .large .h1{fontサイズ:18px !important}
  .large .desc,.large .list,.large .label,.large .item,.large .link{font-size:17px !important}
  .large .input,.large select,.large .textarea{font-size:18px !important}
  .large .btnPrimary,.large header .btn,.large .toggleLarge,.large .aiLabel,.large .supportItem,.large .ghost{font-size:17px !important}
  .large .priceTable th,.large .priceTable td{font-size:15px !important}
  .large .otpBox{font-size:26px !important}

  .exp-cta .btnPrimary{background:#3c7fe6;color:#fff;}
  .exp-cta .btnPrimary.pressed{ transform:translateY(1px) scale(0.99); box-shadow:0 1px 0 rgba(15,61,122,.08); }
  .exp-cta .videoCta{ padding:12px 14px; border-radius:14px; box-shadow:0 2px 0 rgba(15,61,122,.08); line-height:1.35; background:#3c7fe6; color:#fff;}
  .exp-cta .videoCta.pressed{ transform:translateY(1px) scale(0.99); }
  @media (max-width:360px){
    .exp-cta .btnPrimary{ font-size:17px; padding:16px 14px; }
    .exp-cta .supportItem, .exp-cta .ghost{ font-size:15px; }
  }
  @media (min-resolution:2dppx){ .exp-cta .btnPrimary{ font-weight:700; } }
  @media (prefers-color-scheme:dark){
    .exp-cta .btnPrimary{ background:#3c7fe6; color:#fff; }
    .exp-cta .videoCta{ background:#3c7fe6; color:#fff; }
  }
  .exp-cta footer{ padding-bottom:calc(6px + env(safe-area-inset-bottom)); }
  .exp-cta :focus-visible{ outline:3px solid #3c7fe6; outline-offset:2px; border-radius:8px; }
  .exp-cta *{ -webkit-tap-highlight-color:rgba(31,95,191,0.15); }

  /* 公式案内 先頭行（注意点リンク版） */
  .officialInline{ display:block; padding:10px 12px 0 12px; }
  .officialInline-row{ display:flex; align-items:flex-start; gap:8px; }
  .officialInline-bullet{ width:18px; height:18px; flex:0 0 18px; }
  .officialInline-text{ font-size:12px; color:var(--blue-900); line-height:1.5; }
  .officialInline-text a{ color:var(--blue-800); text-decoration:none; }
  .officialInline-text a:active{ opacity:0.85; }

  /* 動画チップ（淡い塗り） */
  .videoChip {
    display:flex; align-items:center; gap:10px;
    width:100%;
    border:1px solid #c8d6f3;
    background:#eef4ff;
    color:var(--blue-900);
    border-radius:14px; padding:12px 14px; text-decoration:none;
    font-weight:700; font-size:14px; margin-top:8px;
    box-shadow:0 1px 0 rgba(31,95,191,.06);
    transition:background-color .12s ease, border-color .12s ease, transform .06s ease;
  }
  .videoChip:hover, .videoChip:focus-visible { background:#e6f0ff; border-color:#aecdff; }
  .videoChip:active { background:#dfe9ff; border-color:#93b8ff; }
  .videoChip-icon { width:22px; height:22px; flex:0 0 22px; }
  .videoChip-icon rect{ fill:#2b6fd6; transition: fill .12s ease; }
  .videoChip-icon polygon{ fill:#ffffff; transition: transform .12s ease; transform-origin:center; }

  /* 新規：WEBと書面の選択（免許証色UIと同系） */
  .choiceRow{display:flex; gap:6px; margin-top:6px;}
  .choiceToggle{flex:1; display:flex; align-items:center; justify-content:center; gap:6px;
    padding:8px 10px; border-radius:10px; border:1px solid var(--blue-800); background:#fff; color:var(--blue-800); font-weight:700; cursor:pointer;}
  .choiceToggle.active{outline:2px solid var(--blue-800); background:#eef4ff;}

</style>
<!-- END: styles -->

<!-- START: styles-addon -->
<style>
  /* ヘッダー：一行に収める（アイコン縮小・余白圧縮・フォント調整） */
  .headerTop{ display:flex; align-items:center; justify-content:flex-start; gap:4px; flex-wrap:nowrap; }
  .toolbar{ display:flex; gap:4px; align-items:center; flex-wrap:nowrap; flex:0 0 auto; }
  .headerTop .btn{
    display:inline-flex; align-items:center; gap:4px;
    padding:3px 4px; border:none; background:transparent;
    color:var(--blue-800); font-size:12px; font-weight:600; text-decoration:none; white-space:nowrap;
  }
  .headerTop .btn svg{ width:22px; height:22px; display:block; }
  .aiAgent{ display:inline-flex; align-items:center; gap:4px; cursor:pointer; white-space:nowrap; flex-shrink:1; margin-left:4px; }
  .aiLabel{ font-size:12px; font-weight:600; color:var(--blue-800); white-space:nowrap; }
  .headerTop .toggleLarge{
    border:none !important; border-radius:0 !important; background:transparent !important;
    padding:3px 4px !important; color:var(--blue-800) !important; font-size:12px; white-space:nowrap;
  }
  .large .headerTop .btn, .large .headerTop .toggleLarge, .large .aiLabel, .large #lblSpeak, .large #lblLarge{ font-size:13px !important; }

  .badgeOfficial{
    display:inline-flex; align-items:center; justify-content:center;
    padding:3px 6px; border:1px solid var(--blue-800); border-radius:999px;
    background:#eef4ff; color:#1f5fbf; font-size:12px; font-weight:700; line-height:1; white-space:nowrap;
  }

  /* AIと対話アイコン：わずかに縮小（22px） */
  .aiRobot{
    width:22px; height:22px; border-radius:8px;
    background-color:#3c7fe6 !important;
    border:2px solid #d7e0f0;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ffffff" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm-7 9v-1a7 7 0 0 1 14 0v1H5z"/></svg>') !important;
    background-repeat:no-repeat !important;
    background-position:center !important;
    background-size:68% 68% !important;
  }

  /* 進捗と章ラベル */
  .bar{ position:relative; }
  .bar::before{
    content:""; position:absolute; inset:0; pointer-events:none; border-radius:999px;
    background:
      linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 24.5%, rgba(31,95,191,.18) 25%, rgba(0,0,0,0) 25.5%),
      linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 49.5%, rgba(31,95,191,.18) 50%, rgba(0,0,0,0) 50.5%),
      linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 74.5%, rgba(31,95,191,.18) 75%, rgba(0,0,0,0) 75.5%);
  }
  .chapters{ display:flex; gap:6px; justify-content:space-between; margin:2px 10px 0 10px; font-size:11px; color:#5b6470; }
  .chapter{ flex:1; text-align:center; opacity:.75; }
  .chapter.active{ color:#1f5fbf; font-weight:700; opacity:1; }

  /* cover時はヘッダー/進捗/フッターを非表示、背景調整 */
  body.cover{ background:#dbe7ff !important; background-image:none !important; }
  body.cover header{ background:transparent !important; border-bottom:none !important; padding:0 !important; position:static !important; }
  body.cover .headerTop, body.cover .chapters, body.cover .progress, body.cover footer{ display:none !important; }

  .coverWrap{ min-height:100vh; min-height:100svh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:24px 16px; color:#111; }
  .coverCar svg{ width:72%; max-width:320px; height:auto; margin-bottom:18px; }
  .coverTitle .coverLine{ position:relative; color:#000; font-size:20px; font-weight:700; line-height:1.75; letter-spacing:.02em; padding-left:0; }
  .coverTitle .coverLine::before{ content:none !important; }
  .coverTitle .coverLine.noBullet{ padding-left:0 !important; }
  .coverTitle .coverLine.noBullet::before{ content:none !important; }
  .coverStartBtn{
    margin-top:22px; display:inline-block; padding:12px 20px; border-radius:14px;
    background:#3c7fe6; color:#fff; font-size:16px; font-weight:800; border:none; cursor:pointer;
    box-shadow:0 2px 0 rgba(15,61,122,.12);
    transition:transform .06s ease, filter .12s ease;
  }
  .coverStartBtn:hover{ filter:brightness(1.02); }
  .coverStartBtn:active{ transform:translateY(1px) scale(0.99); filter:brightness(0.98); }

  /* リンクの操作の手がかり（矢印アイコン常時併設） */
  .link{ color:var(--blue-800); text-decoration:none; position:relative; font-weight:700; }
  .link::after{ content:"›"; display:inline-block; margin-left:4px; color:var(--blue-800); font-weight:700; }
  .link:active{ opacity:.85; }
  .link:focus-visible{ text-decoration:underline; outline:3px solid #3c7fe6; outline-offset:2px; border-radius:2px; }

  /* 新規：WEBと書面の選択（免許証色UIと同系） */
  .choiceRow{ display:flex; gap:6px; margin-top:6px; }
  .choiceToggle{
    flex:1; display:flex; align-items:center; justify-content:center; gap:6px;
    padding:8px 10px; border-radius:10px; border:1px solid var(--blue-800); background:#fff; color:var(--blue-800);
    font-weight:700; cursor:pointer; white-space:nowrap; /* 二段化防止 */
  }
  .choiceToggle.active{ outline:2px solid var(--blue-800); background:#eef4ff; }

  /* ヒーロー導入（1行・小さめ・改行抑止） */
  .heroStrip{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; padding:0; margin:8px 0 0 0; background:none; border:none; }
  .heroStrip svg{ display:block; width:18px; height:18px; }
  .heroChip{ display:inline-flex; align-items:center; gap:6px; background:transparent; border:none; padding:0; box-shadow:none; color:#0f3d7a; font-size:12px; font-weight:600; white-space:nowrap; }

  /* フッターノート（センタリング＋本文相当13px） */
  .footerNote{ text-align:center; font-size:13px !important; line-height:1.55; margin-top:6px; color:var(--blue-900); }
  .large .footerNote{ font-size:13px !important; }

  /* フッターアクション（戻ると途中保存の等幅維持） */
  .footerActions{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; width:100%; }
  .footerActions .ghost{ width:100%; }

  /* 申込完了リスト（行頭記号 ■） */
  #donePostalUnder.doneLine, #doneList .doneLine{ position:relative; padding-left:1.8em; }
  #donePostalUnder.doneLine::before, #doneList .doneLine::before{
    content:"■"; position:absolute; left:0.25em; top:0.1em; color:var(--blue-900);
    font-weight:700; font-size:0.95em; line-height:1;
  }

  /* 進捗行は改行しない */
  .progressTop{ display:flex; align-items:center; justify-content:space-between; gap:8px; white-space:nowrap; }

  /* 長文ボタンのフォントわずかに小さく（改行抑止） */
  .btnPrimary{ font-size:15px; white-space:nowrap; }

  /* ④ 免許証の確認画面の2ボタンを車情報に合わせて縦積み（同じ間隔） */
  .screen[data-title="免許証の情報を確認する"] .card > div[style*="display:flex"]{
    display:block !important;
  }
</style>
<!-- END: styles-addon -->

<!-- START: styles-override-airobot -->
<style>
  /* AIと対話のアイコンを青地＋白シルエットに統一（「文字を大きく」アイコンと同系の青） */
  .aiRobot{
    width:23px; height:23px; border-radius:8px;
    background-color:#3c7fe6 !重要;
    border:2px solid #d7e0f0;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ffffff" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm-7 9v-1a7 7 0 0 1 14 0v1H5z"/></svg>') !重要;
    background-repeat:no-repeat !重要;
    background-position:center !重要;
    background-size:70% 70% !重要;
  }
</style>
<!-- END: styles-override-airobot -->

<!-- START: styles-official-inline-contrast -->
<style>
  /* 提案B：背景なしテキストを維持しつつ、ダーク/ライト両対応の視認性を確保 */
  .officialInline { padding:12px 12px 0 12px; }
  .officialInline-row { display:flex; align-items:flex-start; gap:10px; }
  .officialInline-bullet { width:18px; height:18px; flex:0 0 18px; }
  .officialInline-text { font-size:13px; line-height:1.6; color: #0f3d7a; letter-spacing:.01em; }
  .officialInline-text strong { font-weight:800; }

  /* 等幅チップ（ドメイン/メールの誤読防止） */
  .inlineChip{
    display:inline-flex; align-items:center; justify-content:center;
    margin:0 4px; padding:3px 8px;
    border:1px solid #2b6fd6; border-radius:999px;
    background:#fff; color:#2b6fd6; font-size:12px; font-weight:700; line-height:1;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
    white-space:nowrap;
  }

  /* リンクは常時下線＋ハイコントラスト色 */
  .officialInline .officialLink{
    color:#1f5fbf; text-decoration:underline; font-weight:700;
  }
  .officialInline .officialLink:active{ opacity:.9; }

  /* フォーカス可視性（キーボード操作にも配慮） */
  .officialInline .officialLink:focus-visible,
  .officialInline .inlineChip:focus-visible{
    outline:3px solid #3c7fe6; outline-offset:2px; border-radius:6px;
  }

  /* ダークモードでは文字色・リンク色を明示指定し、コントラストを確保（>=4.5:1） */
  @media (prefers-color-scheme: dark){
    .officialInline-text{ color:#ededed; }
    .officialInline .officialLink{ color:#66B2FF; }
    .inlineChip{
      background:transparent; border-color:#66B2FF; color:#66B2FF;
    }
    /* 警告アイコンも暗所で沈まないように少し明るめに */
    .officialInline-bullet polygon{ fill:#ffd54f; stroke:#e6c54b; }
    .officialInline-bullet text{ fill:#3b2f00; }
  }

  /* 狭幅端末での折返し最適化 */
  @media (max-width:360px){
    .officialInline-text{ font-size:12.5px; }
  }
</style>
<!-- END: styles-official-inline-contrast -->

<!-- START: styles-monthday-picker -->
<style>
  /* 月・日ピッカー（四角ボタン／ライト・ダーク対応） */
  .mdPickerHeader{ font-size:16px; font-weight:700; color:var(--blue-900); margin-top:0; }
  .mdPickerSub{ font-size:12px; color:var(--sub); margin-top:4px; }
  .mdGrid{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-top:10px; }
  .mdCell{
    position:relative;
    display:inline-flex; align-items:center; justify-content:center;
    min-height:42px; padding:10px; border:1px solid var(--border); border-radius:10px;
    background:#fff; color:#1a1a1a; font-size:15px; font-weight:700; cursor:pointer;
  }
  .mdCell:hover, .mdCell:focus-visible{ outline:3px solid #3c7fe6; outline-offset:2px; }
  .mdCell.selected{ background:#eef4ff; border-color:#aecdff; color:#0f3d7a; }
  .mdCell.selected::after{
    content:"✓"; position:absolute; right:10px; top:6px; font-size:14px; font-weight:800; color:#2b6fd6;
  }
  .mdCell.disabled{ opacity:.45; cursor:not-allowed; background:#f6f8fc; }

  .mdActions{ display:flex; gap:6px; margin-top:12px; justify-content:center; } /* センタリング */

  .mdClose{ display:inline-block; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; color:#0f3d7a; font-size:13px; cursor:pointer; }
  .mdClose:active{ opacity:.9; }

  @media (prefers-color-scheme: dark){
    .mdCell{ background:#1e1e1e; color:#fafafa; border-color:#2c2c2c; }
    .mdCell.disabled{ background:#222; border-color:#2c2c2c; color:#bbb; }
    .mdCell.selected{ background:#16365f; border-color:#3c7fe6; color:#fff; }
    .mdCell.selected::after{ color:#66B2FF; }
    .mdClose{ background:#1e1e1e; color:#fafafa; border-color:#2c2c2c; }
  }

  /* 非表示select（値保持用） */
  .visHiddenSelect{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

  /* 表示用のダミー入力風ボタン（幅を短縮） */
  .mdDisplayBtn{
    flex:0 0 70px; max-width:72px;
    display:flex; align-items:center; justify-content:center;
    padding:8px; border:1px solid var(--border); border-radius:10px; background:#fff;
    font-size:15px; color:#1a1a1a; cursor:pointer;
  }
  .mdDisplayBtn:focus-visible{ outline:3px solid #3c7fe6; outline-offset:2px; }
  @media (prefers-color-scheme:dark){
    .mdDisplayBtn{ background:#1e1e1e; color:#fafafa; border-color:#2c2c2c; }
  }
</style>
<!-- END: styles-monthday-picker -->

<!-- START: styles-voice-indicator -->
<style>
  /* 音声インジケータ（フィールド近傍・小型表示） */
  .voiceIndicator {
    display:inline-flex; align-items:center; gap:6px;
    margin-top:6px; padding:4px 8px; border:1px solid #c8d6f3; border-radius:999px;
    background:#eef4ff; color:#1f5fbf; font-size:12px; font-weight:700;
    will-change: opacity, transform;
  }
  .voiceIndicator .dot {
    width:8px; height:8px; border-radius:50%;
    background:#e53935; /* 録音中は赤 */
    box-shadow:0 0 0 2px rgba(229,57,53,.15);
  }
  .voiceIndicator.recognizing .dot { background:#ffb300; } /* 認識中は黄 */
  .voiceIndicator.ready .dot { background:#3c7fe6; } /* 準備中は青 */

  /* 縮退フェード（0.25s） */
  @keyframes fadeShrink {
    0% { opacity:1; transform:scale(1); }
    100% { opacity:0; transform:scale(0.92); }
  }
  .fadeShrink {
    animation: fadeShrink 0.25s ease-out forwards;
  }

  /* フッター音声ステータスにも同じ縮退フェードを適用可能 */
  #voiceStatus.fadeShrink {
    animation: fadeShrink 0.25s ease-out forwards;
  }

  @media (prefers-color-scheme: dark){
    .voiceIndicator { border-color:#3c7fe6; background:#16365f; color:#fff; }
    .voiceIndicator .dot { box-shadow:none; }
  }

  /* 動きを好まない設定への配慮：アニメーション無効化 */
  @media (prefers-reduced-motion: reduce){
    .fadeShrink {
      animation: none !important;
    }
  }
</style>
<!-- END: styles-voice-indicator -->

<!-- START: styles-tap-visual-tips -->
<style>
  /* タップ領域（44px以上）＋二段表示対策（nowrap） */
  .btnPrimary{
    min-height:46px;
    padding:12px;
    font-size:15px;
    white-space:nowrap;     /* sop btn no wrap */
  }
  .choiceToggle{
    min-height:44px;
    padding:10px 12px;
    font-size:14px;
    white-space:nowrap;     /* prevent two lines */
  }
  .colorBtn{
    min-height:44px;
    padding:10px 12px;
    font-size:14px;
    white-space:nowrap;
  }

  /* フッターのゴーストボタン（戻る／途中保存）を「電話予約／チャット」と高さ揃え */
  .footerActions .ghost{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    font-size:13px;
    line-height:1.2;
    white-space:nowrap;
    min-height:auto;
  }

  /* 選択済みの見える化（チェック：choiceToggle） */
  .choiceToggle.active{
    position:relative; background:#eef4ff; outline:2px solid var(--blue-800);
  }
  .choiceToggle.active::after{
    content:"✓"; position:absolute; right:10px; top:6px;
    color:var(--blue-800); font-size:14px; font-weight:800;
  }

  /* 選択済みの見える化（チェック：colorBtn＝免許色） */
  .colorBtn.active{
    position:relative; background:#eef4ff; outline:2px solid var(--blue-800);
  }
  .colorBtn.active::after{
    content:"✓"; position:absolute; right:10px; top:6px;
    color:var(--blue-800); font-size:14px; font-weight:800;
  }

  @media (prefers-color-scheme:dark){
    .choiceToggle.active::after{ color:#66B2FF; }
    .colorBtn.active::after{ color:#66B2FF; }
  }

  /* 解説アイコン：右横に置き、やや下げる（ベースライン寄り） */
  .label{
    display:flex;
    align-items:baseline;
    gap:6px;
  }
  .tipIcon{
    display:inline-flex; align-items:center; justify-content:center;
    width:19px; height:19px; border-radius:999px;
    border:none; background:transparent; cursor:pointer;
    padding:0; margin-left:8px;
    font-size:0; line-height:0;
    position:relative;
    top:7px; /* ほんの少し下げて上付き感を解消 */
  }
  .tipIcon::before{
    content:"";
    display:block; width:22px; height:22px;
    background-repeat:no-repeat; background-position:center; background-size:contain;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%233c7fe6" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 17.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm2-6.8c-.6.6-1 .9-1 .8v.5h-2v-1c0-.6.5-1.1 1.1-1.3.9-.3 1.9-1.1 1.9-2.2 0-1.3-1.1-2.3-2.5-2.3-1.1 0-2 .6-2.4 1.6l-1.8-.8C8 5.7 9.9 4.5 12 4.5c2.5 0 4.5 1.7 4.5 3.9 0 1.6-.8 2.6-2.5 3.3z"/></svg>');
  }
  .tipIcon:active{ opacity:.9; }
  @media (prefers-color-scheme:dark){
    .tipIcon::before{
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%2366B2FF" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 17.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm2-6.8c-.6.6-1 .9-1 .8v.5h-2v-1c0-.6.5-1.1 1.1-1.3.9-.3 1.9-1.1 1.9-2.2 0-1.3-1.1-2.3-2.5-2.3-1.1 0-2 .6-2.4 1.6l-1.8-.8C8 5.7 9.9 4.5 12 4.5c2.5 0 4.5 1.7 4.5 3.9 0 1.6-.8 2.6-2.5 3.3z"/></svg>');
    }
  }
</style>
<!-- END: styles-tap-visual-tips -->

<!-- START: styles-fixes-1204v7 -->
<style>
  /* 表紙（cover）時の背景色を、やや濃い淡青に調整 */
  body.cover{ background:#dbe7ff !important; }

  /* 進捗行（n/26 と 残り時間）を横並びで改行しない */
  .progress .progressTop{
    display:flex; align-items:center; justify-content:space-between;
    gap:8px; white-space:nowrap;
  }
  .progress #progressText, .progress #timeLeft{ white-space:nowrap; }

  /* 申込完了リストの行頭に■を付与（重なり防止：左に余白を作り、■は絶対配置） */
  #doneList .doneLine{
    position:relative;
    padding-left:1.8em; /* ■の分だけ左余白 */
  }
  #doneList .doneLine::before{
    content:"■";
    position:absolute;
    left:0.25em; top:0.1em;
    color:var(--blue-900);
    font-weight:700; font-size:0.95em; line-height:1;
  }
  @media (prefers-color-scheme:dark){
    #doneList .doneLine::before{ color:#66B2FF; }
  }
</style>
<!-- END: styles-fixes-1204v7 -->

<!-- START: styles-year-select-fix -->
<style>
  /* 年セレクトの幅を復元（年は約半幅、月・日は十分な幅で一行維持） */
  #licenseYear, #dobYear, #md_dobYear, #firstRegYear{
    flex: 1 1 48%;
    min-width: 136px;
    width: auto !important;
  }
  /* 月・日ボタン（表示用）は十分な幅を確保（従来値） */
  #licenseMonth, #licenseDay, #dobMonth, #dobDay, #md_dobMonth, #md_dobDay, #firstRegMonth{
    flex: 0 0 92px;
    max-width: 100px;
  }
  .mdDisplayBtn{ flex: 0 0 70px; }

  @media (max-width:360px){
    #licenseYear, #dobYear, #md_dobYear, #firstRegYear{ min-width:126px; flex-basis:46%; }
    #licenseMonth, #licenseDay, #dobMonth, #dobDay, #md_dobMonth, #md_dobDay, #firstRegMonth{ flex-basis:82px; max-width:88px; }
    select#licenseMonth, select#licenseDay, select#dobMonth, select#dobDay, select#md_dobMonth, select#md_dobDay, select#firstRegMonth{ font-size:15px; padding:7px; }
  }
</style>
<!-- END: styles-year-select-fix -->

</head>
<body>
<div class="wrap">

  <header>
<!-- START: header-top -->
<div class="headerTop">
  <div class="toolbar">
    <a href="#" class="btn" id="btnSpeak" onclick="toggleGuidedVoice()">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path fill="#3c7fe6" d="M2 12h2c.4 0 .7-.3.8-.7l.5-3.2c.1-.6 1-.6 1.1 0l.7 4.2c.1.6 1 .6 1.1 0l1.1-6.4c.1-.6 1-.6 1.1 0l1.2 8c.1.6 1 .6 1.1 0l1-5.4c.1-.6 1-.6 1.1 0l.8 4.5c.1.4.4.7.8.7h3c.6 0 1 .4 1 1s-.4 1-1 1h-3c-.4 0-.7.3-.8.7l-.8 4.5c-.1.6-1 .6-1.1 0l-1-5.4c-.1-.6-1-.6-1.1 0l-1.2 8c-.1.6-1 .6-1.1 0l-1.1-6.4c-.1-.6-1-.6-1.1 0l-.7 4.2c-.1.6-1 .6-1.1 0l-.5-3.2c-.1-.4-.4-.7-.8-.7H2c-.6 0-1-.4-1-1s.4-1 1-1z"/>
      </svg>
      <span id="lblSpeak">音声で解説</span>
    </a>

    <a href="#" class="btn toggleLarge" onclick="toggleLarge()">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="2" y="3" width="20" height="18" rx="4" fill="#3c7fe6"></rect>
        <text x="12" y="16" text-anchor="middle" font-size="12" fill="#ffffff" font-weight="700">あ</text>
      </svg>
      <span id="lblLarge">文字拡大</span>
    </a>

    <a href="#" class="btn" onclick="openHelp()" aria-label="ヘルプを開く">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path fill="#3c7fe6" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 17.5c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm2-6.8c-.6.6-1 .9-1 .8v.5h-2v-1c0-.6.5-1.1 1.1-1.3.9-.3 1.9-1.1 1.9-2.2 0-1.3-1.1-2.3-2.5-2.3-1.1 0-2 .6-2.4 1.6l-1.8-.8C8 5.7 9.9 4.5 12 4.5c2.5 0 4.5 1.7 4.5 3.9 0 1.6-.8 2.6-2.5 3.3z"/>
      </svg>
      <span>ヘルプ</span>
    </a>
  </div>

  <div class="aiAgent" onclick="openAiChoice()">
    <div class="aiRobot" aria-hidden="true" title="AIエージェント"></div>
    <div class="aiLabel">AIと対話</div>
  </div>
</div>
<!-- END: header-top -->

<!-- START: header-progress -->
<div class="progress">
  <div class="progressTop">
    <div id="progressText">進捗 1/26（最大）</div>
    <div id="timeLeft">残り約12分</div>
  </div>
  <div class="bar"><div id="progressBar" role="progressbar" aria-label="進捗" aria-valuemin="0" aria-valuemax="100" aria-valuenow="4"></div></div>
  <div class="chapters" aria-label="進捗の章">
    <span id="chapInput" class="chapter">お車情報</span>
    <span id="chapEstimate" class="chapter">お客様情報</span>
    <span id="chapExplain" class="chapter">更新手続</span>
    <span id="chapApply" class="chapter">申込</span>
  </div>
</div>
<!-- END: header-progress -->

    <!-- START: header-bottom -->
    <!-- 予備（将来拡張） -->
    <!-- END: header-bottom -->

<!-- START: screen-00-cover -->
<section class="screen active" data-title="表紙" data-role="cover" aria-label="プロトタイプの表紙（セダン・ラインアート／タイヤ重ね＋青塗り）">
  <div class="coverWrap">
    <!-- セダン：青のアウトライン。タイヤは車体ラインに少し重ね、青で塗りつぶし -->
    <div class="coverCar" aria-hidden="true" style="margin-bottom:4px;">
<svg viewBox="0 0 280 120" role="img" aria-label="セダンのラインアート（タイヤ青塗り）">
  <path d="M30 78c0-10 12-22 28-26h60c10 0 18-6 26-12 12-8 24-12 36-12h26c20 0 34 12 40 28l6 16c6 2 10 8 10 14 0 6-4 10-10 10H42c-6 0-10-4-10-10 0-6 4-12 10-16h-4c-6 0-8-2-8-6z"
        fill="none" stroke="#3c7fe6" stroke-width="2.6" stroke-linejoin="round" stroke-linecap="round"/>
  <circle cx="82" cy="91" r="10.5" fill="#3c7fe6" stroke="#3c7fe6" stroke-width="3"/>
  <circle cx="204" cy="91" r="10.5" fill="#3c7fe6" stroke="#3c7fe6" stroke-width="3"/>
</svg>
    </div>

    <!-- タイトル（線画との間は1行分の余白） -->
    <div class="coverTitle" style="margin-top:4px; margin-bottom:4px;">
      <div class="coverLine">プロトタイプ</div>
    </div>

    <!-- 番号と本文の開始位置を綺麗に揃える：1行＝1グリッド行 -->
    <style>
      .coverOutline{
        width:100%; max-width:420px;
        margin:0 auto;
        padding-left:80px; /* 既存の右寄せ量を維持 */
        text-align:left;
      }
      .coverRow{
        display:grid;
        grid-template-columns: 1.6em 1fr; /* 番号列をコンパクト化（過剰スペース解消） */
        column-gap:6px;
        align-items:baseline;
        margin:4px 0;
      }
      .coverRow .num{
        text-align:right; color:#0f3d7a; font-weight:700;
      }
      .coverRow .text{
        color:#0f3d7a; font-weight:700;
        white-space:normal; word-break:break-word; overflow-wrap:anywhere;
      }
      .coverRow.sub .text{
        color:#1a1a1a; font-weight:500; /* サブ項目は通常トーン */
      }
      .coverSpacer{ height:1.25em; }
    </style>

    <div class="coverOutline">
      <!-- 1行目：1. 狙い -->
      <div class="coverRow">
        <span class="num">1.</span>
        <span class="text">狙い：イメージ共有</span>
      </div>
      <!-- サブ項目（番号列は空、本文列に揃える） -->
      <div class="coverRow sub">
        <span class="num" aria-hidden="true"></span>
        <span class="text">・スマらく改修</span>
      </div>
      <div class="coverRow sub">
        <span class="num" aria-hidden="true"></span>
        <span class="text">・e-Auto更新</span>
      </div>

      <!-- 1行の空白行（1と2の間） -->
      <div class="coverSpacer" aria-hidden="true"></div>

      <!-- 2行目：2. 改修点 -->
      <div class="coverRow">
        <span class="num">2.</span>
        <span class="text">改修点：Pain解消</span>
      </div>
      <!-- サブ項目（本文列に揃える） -->
      <div class="coverRow sub">
        <span class="num" aria-hidden="true"></span>
        <span class="text">・非スマらく理由解消</span>
      </div>
      <!-- 追加：UI/UXの改善 -->
      <div class="coverRow sub">
        <span class="num" aria-hidden="true"></span>
        <span class="text">・高齢者目線でUI/UX改善</span>
      </div>
    </div>

    <button class="coverStartBtn" onclick="startDemo()" aria-label="デモを開始する" style="margin-top:16px;">デモ開始</button>
  </div>
</section>
<!-- END: screen-00-cover -->

  </header>

  <main id="screens">

<!-- START: screen-01-intro -->
<section class="screen" data-title="手続き開始">
  <div class="officialInline" role="note" aria-label="公式案内と注意点">
    <div class="officialInline-row">
      <svg class="officialInline-bullet" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <polygon points="12,2 22,20 2,20" fill="#ffcc00" stroke="#e0b700" stroke-width="1"/>
        <text x="12" y="16" text-anchor="middle" font-size="12" fill="#3b2f00" font-weight="700">!</text>
      </svg>
      <span class="officialInline-text">
        <strong>公式サイト</strong>
        <span class="inlineChip" aria-label="公式ドメイン">example.co.jp</span><br>
        送信元メールは
        <span class="inlineChip" aria-label="送信元メールドメイン">@example.co.jp</span>
        から届きます。<br>
        <a href="#" class="officialLink" onclick="openSecurityCheck()">偽サイトの見分け方はコチラ</a>
      </span>
    </div>
  </div>

  <div class="card">
    <!-- 先頭に動画リンク -->
    <a href="#" class="videoChip" role="button"
       onclick="openNotice('本番では60秒動画に推移します')"
       aria-label="使い方の60秒動画（視聴は任意）"
       style="margin-top:4px;">
      <svg class="videoChip-icon" viewBox="0 0 22 22" aria-hidden="true" focusable="false">
        <rect x="1.5" y="1.5" width="19" height="19" rx="4"/>
        <polygon points="9,6.5 16,11 9,15.5"/>
      </svg>
      使い方の60秒動画（視聴は任意）
    </a>

    <!-- アイコン付き案内4行 -->
    <div class="item infoRow" style="margin-top:8px;">
      <!-- スマホ/PC風アイコン（モニタ＋スマホ） -->
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="3" y="4" width="12" height="9" rx="2" fill="#3c7fe6"></rect>
        <rect x="17" y="6" width="4" height="10" rx="1.5" fill="#1f5fbf"></rect>
        <rect x="8" y="13.5" width="2" height="1.5" fill="#3c7fe6"></rect>
      </svg>
      <div style="line-height:1.55;">スマホまたはPCで手続きできます（途中保存OK）</div>
    </div>

    <div class="item infoRow">
      <!-- 所要時間（時計アイコン） -->
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path fill="#3c7fe6" d="M12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm.5-13h-1v6l5 3 .5-.87-4.5-2.63V7z"/>
      </svg>
      <div style="line-height:1.55;">所要時間約12分です</div>
    </div>

    <div class="item infoRow">
      <!-- 〒の絵（シンプルな郵便マーク） -->
      <div aria-hidden="true" style="width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; border-radius:4px; border:1px solid #c8d6f3; background:#eef4ff; color:#1f5fbf; font-weight:800; font-size:12px;">〒</div>
      <div style="line-height:1.55;">紙の保険証券の郵送もできます</div>
    </div>

    <div class="item infoRow">
      <!-- AI相談（ヘッダーと同系の人アイコン） -->
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="1" y="1" width="22" height="22" rx="5" fill="#3c7fe6"/>
        <path fill="#ffffff" d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm-7 9v-1a7 7 0 0 1 14 0v1H5z"/>
      </svg>
      <div style="line-height:1.55;">困ったらAIに質問できます。また電話予約やチャットもご利用いただけます</div>
    </div>
  </div>

  <!-- 事前準備（アイコン付き3行）＋ 次へボタンを同カード内に移動 -->
  <div class="card">
    <div class="h1">事前にご準備ください</div>

    <!-- 免許証（カード風アイコン） -->
    <div class="item infoRow" style="margin-top:8px;">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <!-- カード枠 -->
        <rect x="3" y="5" width="18" height="12" rx="2" fill="#eef4ff" stroke="#1f5fbf" stroke-width="1.2"></rect>
        <!-- カード内のライン -->
        <rect x="5.5" y="8" width="8.5" height="1.6" fill="#2b6fd6"></rect>
        <rect x="5.5" y="10.4" width="6.5" height="1.6" fill="#93b8ff"></rect>
        <!-- 赤強調欄（有効期限イメージ） -->
        <rect x="15.5" y="8" width="4.5" height="4" rx="1" fill="#ffdfe0" stroke="#d32f2f" stroke-width="0.8"></rect>
      </svg>
      <div style="line-height:1.55;">免許証（色・有効期限を確認します）</div>
    </div>

    <!-- 車検証（ペーパー風アイコン） -->
    <div class="item infoRow">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <!-- 用紙 -->
        <rect x="5" y="4" width="14" height="16" rx="1.5" fill="#fff" stroke="#cfd8ea" stroke-width="1.2"></rect>
        <!-- タイトル行 -->
        <rect x="7" y="7" width="10" height="1.6" fill="#1f5fbf"></rect>
        <!-- 明細行 -->
        <rect x="7" y="10" width="8" height="1.4" fill="#93b8ff"></rect>
        <rect x="7" y="12.5" width="9" height="1.4" fill="#c8d6f3"></rect>
      </svg>
      <div style="line-height:1.55;">車検証（お車情報の確認に使います）</div>
    </div>

    <!-- メール（封筒風アイコン） -->
    <div class="item infoRow">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <rect x="3" y="6" width="18" height="12" rx="2" fill="#eef4ff" stroke="#1f5fbf" stroke-width="1.2"></rect>
        <path d="M4 8l8 6 8-6" fill="none" stroke="#2b6fd6" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
      <div style="line-height:1.55;">メールアドレス（控え送付・お知らせ用）</div>
    </div>

    <!-- 「所要時間は約10〜12分…」は削除 -->
    <button class="btnPrimary" onclick="next()">次へ（ログイン）</button>
  </div>
</section>
<!-- END: screen-01-intro -->

<!-- START: screen-02-login -->
    <section class="screen" data-title="ログイン">
      <div class="card">
        <div class="h1">ログイン</div>
        <div class="field">
          <div class="label">ご登録の電話番号またはメールアドレス</div>
          <input class="input" id="loginId" placeholder="例：09012345678 / name@example.co.jp" autocomplete="username">
        </div>
        <button class="btnPrimary" onclick="sendLoginCode()">認証コードを送信</button>

        <div class="field">
          <div class="label">認証コード（4桁）</div>
          <div class="otpRow" role="group" aria-label="認証コード4桁">
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp1" oninput="otpAutoNext(1)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp2" oninput="otpAutoNext(2)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp3" oninput="otpAutoNext(3)" />
            <input class="otpBox" inputmode="numeric" maxlength="1" id="otp4" oninput="otpAutoNext(4)" />
          </div>
        </div>

        <button class="btnPrimary" onclick="if(validateOtpLogin()) next()">次へ（お車の情報）</button>
      </div>
    </section>
<!-- END: screen-02-login -->

<!-- START: screen-03-vehicle-summary -->
<section class="screen" data-title="お車の情報">
  <div class="card">
    <div class="h1">お車情報を確認する</div>
    <ul class="list">
      <li>車名：トヨタ プリウス</li>
      <li>型式：ZVW50</li>
      <li>ナンバー：品川 300 あ 12-34</li>
    </ul>
    <div class="desc">変更はございますか？</div>
    <button class="btnPrimary" onclick="goToTitle('免許証の情報を確認する')">変更なし</button>
    <button class="btnPrimary" onclick="goToTitle('車検証の情報')">変更する</button>
  </div>
</section>
<!-- END: screen-03-vehicle-summary -->

<!-- START: screen-04-vehicle-shaken -->
<section class="screen" data-title="車検証の情報">
  <div class="card">
    <div class="h1">車検証の情報を入力する</div>
    <div class="desc">以下の方法で車検証の情報を入力できます。</div>
    <button class="btnPrimary" onclick="showOCRGuide()">カメラで読み取る</button>
    <button class="btnPrimary" onclick="showManual()">手入力する（選択式）</button>
  </div>

  <div class="card" id="ocrShoot" style="display:none;">
    <div class="h1">車検証をカメラで読み取る</div>
    <div class="desc">明るい場所で枠に収めて撮影してください。反射や影を避けると精度が上がります。</div>
    <button class="btnPrimary" onclick="startShooting()">撮影を開始</button>
  </div>

  <div class="card" id="ocrGuide" style="display:none;">
    <div class="h1">車検証の読み取り枠</div>
    <img alt="読み取り枠" style="width:100%; border:1px solid var(--border); border-radius:8px;"
      src="data:image/svg+xml;utf8,
<svg xmlns='http://www.w3.org/2000/svg' width='360' height='200'>
  <rect width='100%%' height='100%%' fill='%23eef4ff'/>
  <rect x='20' y='20' width='320' height='160' fill='none' stroke='%231f5fbf' stroke-width='3' stroke-dasharray='8,6'/>
  <text x='28' y='48' fill='%230f3d7a' font-size='14'>この枠に車検証の該当箇所を収めてください</text>
</svg>"/>
  </div>

  <div class="card" id="ocrResult" style="display:none;">
    <div class="h1">読み取った内容を確認する</div>
    <div class="list">・車名：トヨタ プリウス（変更なし）</div>
    <div class="list">・型式：ZVW50（変更なし）</div>
    <div class="list">・車台番号：ZVW50-1234567（新規）</div>
    <div class="list">・ナンバー：品川 300 あ 12-34（変更なし）</div>
    <div class="list">・初度登録年月：2018年3月（変更なし）</div>
    <button class="btnPrimary" onclick="next()">次へ（免許証の情報）</button>
    <button class="btnPrimary" onclick="showManual()">変更する</button>
  </div>

  <div class="card" id="manualForm" style="display:none;">
    <div class="h1">お車情報を入力する</div>

    <div class="field">
      <div class="label">
        <span>メーカー</span>
      </div>
      <select id="maker" onchange="onMakerChange()">
        <option value="">選択してください</option>
        <option value="toyota">トヨタ</option>
        <option value="mazda">マツダ</option>
        <option value="suzuki">スズキ</option>
        <option value="mercedes">ベンツ</option>
      </select>
    </div>

    <div class="field" id="modelField" style="display:block;">
      <div class="label">
        <span>車名</span>
      </div>
      <select id="model" onchange="onModelChange()">
        <option value="">選択してください</option>
        <option value="crown">クラウン</option>
        <option value="prius">プリウス</option>
        <option value="corolla">カローラ</option>
      </select>
    </div>

    <div class="field" id="typeField" style="display:block;">
      <div class="label">
        <span>型式</span>
      </div>
      <select id="type">
        <option value="">選択してください</option>
        <option value="ZVW50">ZVW50</option>
        <option value="DAA-ZVW55">DAA-ZVW55</option>
      </select>
    </div>

    <div class="field">
      <div class="label">初度登録年月</div>
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <select id="firstRegYear"><option value="">年</option></select>

        <button type="button" id="firstRegMonthDisplay" class="mdDisplayBtn" onclick="openMonthPickerForFirstReg()" aria-label="月を選ぶ">月</button>
        <select id="firstRegMonth" class="visHiddenSelect" aria-hidden="true"><option value="">月</option></select>
      </div>
    </div>

    <button class="btnPrimary" onclick="if(validateFirstRegSelect()) next()">次へ（免許証の情報）</button>
  </div>
</section>
<!-- END: screen-04-vehicle-shaken -->

<!-- START: screen-05-license-summary -->
<section class="screen" data-title="免許証の情報を確認する">
  <div class="card">
    <div class="h1">免許証の情報を確認する</div>
    <ul class="list" id="licenseSummaryList">
      <li>免許証の色：ブルー</li>
      <li>免許証の有効期限：2026年（令和8年）8月1日</li>
    </ul>
    <div class="desc">変更はございますか？</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btnPrimary" onclick="goToTitle('お客様情報の確認')">変更なし</button>
      <button class="btnPrimary" onclick="goToTitle('免許証の色')">変更する</button>
    </div>
  </div>
</section>
<!-- END: screen-05-license-summary -->

<!-- START: screen-06-license -->
<section class="screen" data-title="免許証の色">
  <div class="card">
    <div class="h1">免許証の色を選ぶ</div>

    <div class="label">
      <span>免許証の色</span>
    </div>

    <div class="colorRow">
      <button class="colorBtn" onclick="selectColor('ゴールド', this)"><span class="swatch gold"></span> ゴールド</button>
      <button class="colorBtn" onclick="selectColor('ブルー', this)"><span class="swatch blue"></span> ブルー</button>
      <button class="colorBtn" onclick="selectColor('グリーン', this)"><span class="swatch green"></span> グリーン</button>
    </div>
  </div>

  <div class="card">
    <div class="h1">免許証の有効期限を入力する</div>
    <div class="desc">・免許証の有効期限の記載場所</div>

    <div class="licenseSheet" aria-hidden="true" style="margin-top:8px;">
      <div class="licRow">
        <div class="licBox equal">氏名：〇〇 〇〇</div>
        <div class="licBox equal">生年月日：yyyy年mm月dd日</div>
      </div>
      <div class="licRow">
        <div class="licBox wide">住所：〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇〇</div>
      </div>
      <div class="licRow">
        <div class="licBox short">交付日：yyyy年mm月dd日</div>
      </div>
      <div class="licRow">
        <div class="licBox red short">有効期限：yyyy年mm月dd日</div>
      </div>
      <div class="licRow">
        <div class="licBox short">免許の条件等：XXXXXXXX</div>
      </div>
      <div class="faceBox">顔写真</div>
    </div>

    <div class="desc" style="margin-top:8px;">年・月・日をそれぞれお選びください。</div>
    <div class="field">
      <div class="label">有効期限</div>
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <select id="licenseYear"><option value="">年</option></select>

        <button type="button" id="licenseMonthDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForLicense('month')" aria-label="月を選ぶ">月</button>
        <select id="licenseMonth" class="visHiddenSelect" aria-hidden="true"><option value="">月</option></select>

        <button type="button" id="licenseDayDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForLicense('day')" aria-label="日を選ぶ">日</button>
        <select id="licenseDay" class="visHiddenSelect" aria-hidden="true"><option value="">日</option></select>
      </div>
    </div>
    <button class="btnPrimary" onclick="if(validateDateSelect()) next()">次へ（お客様情報）</button>
  </div>
</section>
<!-- END: screen-06-license -->

<!-- START: screen-07-customer-summary -->
<section class="screen" data-title="お客様情報の確認">
  <div class="card">
    <div class="h1">お客様情報を確認する</div>
    <ul class="list" id="custList">
      <li>氏名：山田 太郎</li>
      <li>性別：男性</li>
      <li>住所：東京都港区赤坂1-1-1 〇〇マンション101</li>
      <li>電話番号：090-0000-0000</li>
      <li>生年月日：1965年04月12日</li>
      <li>勤務先：ABC株式会社</li>
    </ul>
    <div class="desc">変更はございますか？</div>
    <button class="btnPrimary" onclick="goToTitle('主に運転する方（記名被保険者）')">変更なし</button>
    <button class="btnPrimary" onclick="goToTitle('お客様情報の編集')">変更する</button>
  </div>
</section>
<!-- END: screen-07-customer-summary -->

<!-- START: screen-08-customer-edit -->
<section class="screen" data-title="お客様情報の編集">
  <div class="card">
    <div class="h1">お客様情報を変更する</div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>氏名</span>
        <button class="ghost" onclick="startVoiceForField('cust_name')" aria-label="音声で氏名を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="cust_name" placeholder="山田 太郎">
    </div>

    <div class="field">
      <div class="label">性別</div>
      <div class="choiceRow" role="radiogroup" aria-label="性別">
        <button class="choiceToggle" id="choice_gender_m" onclick="toggleChoice('gender_m')">男性</button>
        <button class="choiceToggle" id="choice_gender_f" onclick="toggleChoice('gender_f')">女性</button>
      </div>
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>郵便番号</span>
        <button class="ghost" onclick="startVoiceForField('zip', 'digits')" aria-label="音声で郵便番号を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="zip" placeholder="1234567" oninput="mockZipToAddress(this.value)">
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>住所</span>
        <button class="ghost" onclick="startVoiceForField('addr')" aria-label="音声で住所を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="addr" placeholder="東京都港区赤坂1-1-1 〇〇マンション101">
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>電話番号</span>
        <button class="ghost" onclick="startVoiceForField('cust_phone', 'digits')" aria-label="音声で電話番号を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="cust_phone" placeholder="09012345678">
    </div>

    <div class="field">
      <div class="label">生年月日</div>
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <select id="dobYear"><option value="">年</option></select>

        <button type="button" id="dobMonthDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForDob('month')" aria-label="月を選ぶ">月</button>
        <select id="dobMonth" class="visHiddenSelect" aria-hidden="true"><option value="">月</option></select>

        <button type="button" id="dobDayDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForDob('day')" aria-label="日を選ぶ">日</button>
        <select id="dobDay" class="visHiddenSelect" aria-hidden="true"><option value="">日</option></select>
      </div>
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>勤務先</span>
        <button class="ghost" onclick="startVoiceForField('company')" aria-label="音声で勤務先を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="company" placeholder="ABC株式会社">
    </div>

    <button class="btnPrimary" onclick="goToTitle('主に運転する方（記名被保険者）')">次へ（主に運転する方）</button>
  </div>
</section>
<!-- END: screen-08-customer-edit -->

<!-- START: screen-09-main-driver -->
<section class="screen" data-title="主に運転する方（記名被保険者）">
  <div class="card">
    <div class="h1">主に運転する方を確認する</div>
    <div class="list">現在の登録：山田 太郎</div>
    <div class="desc">変更はございますか？</div>
    <button class="btnPrimary" onclick="goToTitle('運転者の範囲と年齢条件')">変更なし</button>
    <button class="btnPrimary" onclick="goToTitle('主に運転する方の編集')">変更する</button>
  </div>
</section>
<!-- END: screen-09-main-driver -->

<!-- START: screen-10-main-driver-edit -->
<section class="screen" data-title="主に運転する方の編集">
  <div class="card">
    <div class="h1">主に運転する方を変更する</div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>氏名</span>
        <button class="ghost" onclick="startVoiceForField('mainDriverName')" aria-label="音声で氏名を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="mainDriverName" placeholder="山田 花子">
    </div>

    <div class="field">
      <div class="label"><span>性別</span></div>
      <div class="choiceRow" role="radiogroup" aria-label="性別">
        <button class="choiceToggle" id="choice_gender_m2" onclick="toggleChoice('gender_m2')">男性</button>
        <button class="choiceToggle" id="choice_gender_f2" onclick="toggleChoice('gender_f2')">女性</button>
      </div>
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>郵便番号</span>
        <button class="ghost" onclick="startVoiceForField('md_zip','digits')" aria-label="音声で郵便番号を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="md_zip" placeholder="1234567" oninput="mdZipToAddress(this.value)">
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>住所</span>
        <button class="ghost" onclick="startVoiceForField('md_addr')" aria-label="音声で住所を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="md_addr" placeholder="東京都港区赤坂1-1-1 〇〇マンション101">
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>電話番号</span>
        <button class="ghost" onclick="startVoiceForField('md_phone','digits')" aria-label="音声で電話番号を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="md_phone" placeholder="09012345678">
    </div>

    <div class="field">
      <div class="label"><span>生年月日</span></div>
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <select id="md_dobYear"><option value="">年</option></select>

        <button type="button" id="md_dobMonthDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForMdDob('month')" aria-label="月を選ぶ">月</button>
        <select id="md_dobMonth" class="visHiddenSelect" aria-hidden="true"><option value="">月</option></select>

        <button type="button" id="md_dobDayDisplay" class="mdDisplayBtn" onclick="openMonthDayPickerForMdDob('day')" aria-label="日を選ぶ">日</button>
        <select id="md_dobDay" class="visHiddenSelect" aria-hidden="true"><option value="">日</option></select>
      </div>
    </div>

    <div class="field">
      <div class="label" style="display:flex; align-items:center; justify-content:space-between;">
        <span>勤務先</span>
        <button class="ghost" onclick="startVoiceForField('md_company')" aria-label="音声で勤務先を入力">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" style="margin-right:6px;">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          音声で入力
        </button>
      </div>
      <input class="input" id="md_company" placeholder="ABC株式会社">
    </div>

    <button class="btnPrimary" onclick="goToTitle('運転者の範囲と年齢条件')">次へ（年齢条件等）</button>
  </div>
</section>
<!-- END: screen-10-main-driver-edit -->

<!-- START: screen-11-driver-scope-age -->
<section class="screen" data-title="運転者の範囲と年齢条件">
  <div class="card">
    <div class="h1">運転者の範囲と年齢条件を確認する</div>
    <ul class="list">
      <li>範囲：本人と配偶者</li>
      <li>年齢条件：26歳以上補償</li>
    </ul>
    <div class="desc">変更はございますか？</div>
    <button class="btnPrimary" onclick="goToTitle('使用目的・走行距離')">変更なし</button>
    <button class="btnPrimary" onclick="goToTitle('運転者範囲・年齢条件の編集')">変更する</button>
  </div>
</section>
<!-- END: screen-11-driver-scope-age -->

<!-- START: screen-12-driver-scope-age-edit -->
<section class="screen" data-title="運転者範囲・年齢条件の編集">
  <div class="card">
    <div class="h1">運転者の範囲と年齢条件を変更する</div>
    <div class="field">
      <div class="label">運転者の範囲</div>
      <select id="driverScope">
        <option>本人のみ</option>
        <option selected>本人と配偶者</option>
        <option>限定しない</option>
      </select>
    </div>
    <div class="field">
      <div class="label">年齢条件</div>
      <select id="ageCond">
        <option>年齢問わず</option>
        <option>21歳以上補償</option>
        <option selected>26歳以上補償</option>
        <option>35歳以上補償</option>
      </select>
    </div>
    <button class="btnPrimary" onclick="goToTitle('使用目的・走行距離')">次へ（走行距離等）</button>
  </div>
</section>
<!-- END: screen-12-driver-scope-age-edit -->

<!-- START: screen-13-usage-mileage -->
<section class="screen" data-title="使用目的・走行距離">
  <div class="card">
    <div class="h1">使用目的と年間走行距離を選ぶ</div>

    <div class="field">
      <div class="label">使用目的</div>
      <select id="usagePurpose">
        <option>通勤・通学</option>
        <option>レジャー</option>
        <option>業務</option>
      </select>
    </div>

    <div class="field">
      <div class="label">年間走行距離の目安</div>
      <select id="annualMileage">
        <option value="3000" selected>〜3,000km/年</option>
        <option value="5000">3,001〜5,000km/年</option>
        <option value="8000">5,001〜8,000km/年</option>
        <option value="12000">8,001〜12,000km/年</option>
        <option value="20000">12,001km以上/年</option>
      </select>
    </div>

    <button class="btnPrimary" onclick="next()">次へ（現在の補償内容）</button>
  </div>
</section>
<!-- END: screen-13-usage-mileage -->

<!-- START: screen-14-current-coverage -->
<section class="screen" data-title="現在の内容を確認">
  <div class="card">
    <div class="h1">現在の補償内容と保険料を確認する</div>
    <a href="#" class="videoChip" role="button"
       onclick="openNotice('本番では補償のポイント解説動画に推移します')"
       aria-label="補償のポイント60秒動画（視聴は任意）">
      <svg class="videoChip-icon" viewBox="0 0 22 22" aria-hidden="true" focusable="false">
        <rect x="1.5" y="1.5" width="19" height="19" rx="4"/>
        <polygon points="9,6.5 16,11 9,15.5"/>
      </svg>
      補償のポイント60秒動画（視聴は任意）
    </a>
    <ul class="list" style="margin-top:8px;">
      <li>対人・対物：無制限</li>
      <li>人身傷害：3,000万円</li>
      <li>車両保険：保険金額 200万円・免責5万円</li>
      <li>特約：弁護士費用・代車費用</li>
      <li>保険期間：令和8年11月1日午後4時から<br>令和9年11月1日午後4時まで（1年間）</li>
      <li>等級：7F等級</li>
    </ul>

    <div class="desc" style="margin-top:6px;">
      <a href="#" class="link" onclick="openNotice('本番では補償内容の詳細画面に推移します')">補償の詳細はコチラ</a>
    </div>
    <table class="priceTable">
      <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
      <tbody>
        <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="curMonthly">¥5,900</td><td id="curYearly">¥70,800</td></tr>
      </tbody>
    </table>
    <button class="btnPrimary" onclick="next()">次へ（同じ補償内容で更新した場合の保険料）</button>
  </div>
</section>
<!-- END: screen-14-current-coverage -->

<!-- START: screen-15-same-coverage-premium -->
    <section class="screen" data-title="現在と同じ補償内容で更新した場合の保険料">
      <div class="card">
        <div class="h1">現在と同じ補償内容で更新した場合の保険料</div>
        <table class="priceTable">
          <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
          <tbody>
            <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="curMonthly12">¥5,900</td><td id="curYearly12">¥70,800</td></tr>
            <tr class="rowNew"><td class="rowLabel">更新後</td><td id="sameMonthly">¥6,400</td><td id="sameYearly">¥76,800</td></tr>
            <tr class="rowDelta"><td class="rowLabel">差額</td><td id="deltaMonthlyBox">+¥500</td><td id="deltaYearlyBox">+¥6,000</td></tr>
          </tbody>
        </table>
        <div class="infoRow">
          <div class="infoIcon">i</div>
          <div class="h1" style="margin:0;">金額が変わる主な理由</div>
        </div>
        <div class="desc">
          全体の料率改定（物価・部品・修理費の上昇）／年齢・地域・使用状況の変化／等級の進行や事故有の影響（該当する場合）
          <div><a href="#" class="link blockLink" onclick="openReasonDetail()">詳細はコチラ</a></div>
        </div>
        <button class="btnPrimary" onclick="goToTitle('更新方法の選択')">次へ（更新方法を選ぶ）</button>
      </div>
    </section>
<!-- END: screen-15-same-coverage-premium -->

<!-- START: screen-16-renewal-method -->
<section class="screen" data-title="更新方法の選択">
  <div class="card">
    <div class="h1">更新方法を選ぶ</div>
    <button class="btnPrimary" onclick="chooseSameFlow()">現在と同じ補償内容で更新する</button>
    <button class="btnPrimary" onclick="openSimplePlans()">別のプランから選ぶ</button>
    <div class="redNote">オススメの補償充実プランと保険料を抑えたプランをご用意。</div>
    <button class="btnPrimary" onclick="goStepByStep()">項目ごとに設定する（人身傷害・車両・特約）</button>
  </div>
</section>
<!-- END: screen-16-renewal-method -->

<!-- START: screen-17-simple-plans -->
<section class="screen" data-title="別のプランから選ぶ">
  <div class="card">
    <div class="h1">別のプランから選ぶ</div>

    <div class="tabHeader" role="tablist" aria-label="プランの切り替え" style="display:flex; gap:6px; margin-top:6px;">
      <button id="tab_up" class="choiceToggle active" role="tab" aria-selected="true" aria-controls="panel_up" onclick="switchPlanTab('up')">安心重視</button>
      <button id="tab_down" class="choiceToggle" role="tab" aria-selected="false" aria-controls="panel_down" onclick="switchPlanTab('down')">保険料重視</button>
    </div>

    <div id="panel_up" role="tabpanel" aria-labelledby="tab_up" style="margin-top:8px;">
      <div class="label">補償を充実 安心重視</div>
      <div class="desc">※変更した補償：人身傷害、特約</div>

      <div class="foldCard" style="margin-top:8px;">
        <div class="foldHeader" style="font-size:13px; font-weight:600; color:var(--blue-900); padding-bottom: var(--sp-8); border-bottom:1px solid rgba(215,224,240,0.8);">
          補償内容に変更がある場合は➡で表示
        </div>
        <div class="foldBody">
          <ul class="list" style="margin-top:0; padding-left:1em; list-style:disc;">
            <li>対人・対物：無制限</li>
            <li>人身傷害：3,000万円 ➡ 5,000万円</li>
            <li>車両保険：200万円・免責5万円</li>
            <li>特約：弁護士費用／代車費用 ➡ 弁護士費用／代車費用／DAP（ドライブレコーダー）</li>
          </ul>
        </div>
      </div>

      <div class="desc" style="margin-top:6px;">
        <a href="#" class="link" onclick="openNotice('本番では補償内容の詳細画面に推移します')">補償の詳細はコチラ</a>
      </div>

      <table class="priceTable">
        <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
        <tbody>
          <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="planUpCurM">¥5,900</td><td id="planUpCurY">¥70,800</td></tr>
          <tr class="rowNew"><td class="rowLabel">更新後</td><td id="planUpNewM">¥6,900</td><td id="planUpNewY">¥82,800</td></tr>
          <tr class="rowDelta"><td class="rowLabel">差額</td><td id="planUpDeltaM">+¥1,000</td><td id="planUpDeltaY">+¥12,000</td></tr>
        </tbody>
      </table>

      <button class="btnPrimary" onclick="chooseSimplePlan('up')">このプランを選ぶ</button>
      <div aria-hidden="true" style="height:8px;"></div>
      <button class="btnPrimary" onclick="goStepByStep()">項目ごとに設定する（人身傷害・車両・特約）</button>
    </div>

    <div id="panel_down" role="tabpanel" aria-labelledby="tab_down" style="margin-top:8px; display:none;">
      <div class="label">補償を控えめ 保険料重視</div>
      <div class="desc">※変更した補償：車両保険、特約</div>

      <div class="foldCard" style="margin-top:8px;">
        <div class="foldHeader" style="font-size:13px; font-weight:600; color:var(--blue-900); padding-bottom: var(--sp-8); border-bottom:1px solid rgba(215,224,240,0.8);">
          補償内容に変更がある場合は➡で表示
        </div>
        <div class="foldBody">
          <ul class="list" style="margin-top:0; padding-left:1em; list-style:disc;">
            <li>対人・対物：無制限</li>
            <li>人身傷害：3,000万円</li>
            <li>車両保険：200万円・免責5万円 ➡ なし</li>
            <li>特約：弁護士費用／代車費用 ➡ なし</li>
          </ul>
        </div>
      </div>

      <div class="desc" style="margin上:6px;">
        <a href="#" class="link" onclick="openNotice('本番では補償内容の詳細画面に推移します')">補償の詳細はコチラ</a>
      </div>

      <table class="priceTable">
        <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
        <tbody>
          <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="planDownCurM">¥5,900</td><td id="planDownCurY">¥70,800</td></tr>
          <tr class="rowNew"><td class="rowLabel">更新後</td><td id="planDownNewM">¥4,800</td><td id="planDownNewY">¥57,600</td></tr>
          <tr class="rowDelta"><td class="rowLabel">差額</td><td id="planDownDeltaM">-¥1,100</td><td id="planDownDeltaY">-¥13,200</td></tr>
        </tbody>
      </table>

      <button class="btnPrimary" onclick="chooseSimplePlan('down')">このプランを選ぶ</button>
      <div aria-hidden="true" style="height:8px;"></div>
      <button class="btnPrimary" onclick="goStepByStep()">項目ごとに設定する（人身傷害・車両・特約）</button>
    </div>
  </div>

  <script>
    function switchPlanTab(which){
      try{
        const upTab = document.getElementById('tab_up');
        const downTab = document.getElementById('tab_down');
        const upPanel = document.getElementById('panel_up');
        const downPanel = document.getElementById('panel_down');

        const isUp = (which === 'up');
        upTab.classList.toggle('active', isUp);
        downTab.classList.toggle('active', !isUp);
        upTab.setAttribute('aria-selected', isUp ? 'true' : 'false');
        downTab.setAttribute('aria-selected', !isUp ? 'true' : 'false');

        upPanel.style.display = isUp ? '' : 'none';
        downPanel.style.display = isUp ? 'none' : '';
      }catch(e){}
    }
  </script>
</section>
<!-- END: screen-17-simple-plans -->

<!-- START: screen-18-bodily-amount -->
<section class="screen" data-title="人身傷害の金額を選ぶ">
  <div class="card">
    <div class="h1">人身傷害の金額を選ぶ</div>
    <ul class="list">
      <li>現在：3,000万円</li>
    </ul>
    <div class="field">
      <div class="label">
        人身傷害
        <button type="button" class="tipIcon" aria-label="人身傷害の説明" onclick="showTermTip('人身傷害')">?</button>
      </div>
      <select id="bodilyAmount" onchange="onBodilyChange(this.value)">
        <option value="unlimited">無制限</option>
        <option value="10000">1億円</option>
        <option value="8000">8,000万円</option>
        <option value="5000">5,000万円</option>
        <option value="3000" selected>3,000万円</option>
      </select>
    </div>
    <table class="priceTable">
      <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
      <tbody>
        <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="kpiCur1">¥5,900</td><td id="kpiCur1Y">¥70,800</td></tr>
        <tr class="rowNew"><td class="rowLabel">更新後</td><td id="kpiNew1">¥6,800</td><td id="kpiNew1Y">¥81,600</td></tr>
        <tr class="rowDelta"><td class="rowLabel">差額</td><td id="kpiDelta1">+¥900</td><td id="kpiDelta1Y">+¥10,800</td></tr>
      </tbody>
    </table>
    <div class="desc" style="margin-top:4px;"><a href="#" class="link" onclick="openNotice('本番では補償内容の詳細説明画面に遷移します')">・補償の詳細はコチラ</a></div>
    <button class="btnPrimary" onclick="next()">次へ（車両保険）</button>
  </div>
</section>
<!-- END: screen-18-bodily-amount -->

<!-- START: screen-19-vehicle-amount -->
<section class="screen" data-title="車両保険の金額を選ぶ">
  <div class="card">
    <div class="h1">車両保険の金額を選ぶ</div>
    <ul class="list">
      <li>現在：200万円・免責5万円</li>
    </ul>
    <select id="vehicleAmount" onchange="recalcAll()">
      <option value="0">なし</option>
      <option value="150">150万円</option>
      <option value="200" selected>200万円</option>
      <option value="250">250万円</option>
    </select>
    <div class="label" style="margin-top:8px;">
      自己負担額（免責）
      <button type="button" class="tipIcon" aria-label="免責の説明" onclick="showTermTip('免責')">i</button>
    </div>
    <select id="deduct" onchange="recalcAll()">
      <option value="0">0万円</option>
      <option value="50000" selected>5万円</option>
      <option value="100000">10万円</option>
    </select>
    <table class="priceTable">
      <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
      <tbody>
        <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="kpiCur2">¥5,900</td><td id="kpiCur2Y">¥70,800</td></tr>
        <tr class="rowNew"><td class="rowLabel">更新後</td><td id="kpiNew2">¥6,650</td><td id="kpiNew2Y">¥79,800</td></tr>
        <tr class="rowDelta"><td class="rowLabel">差額</td><td id="kpiDelta2">+¥750</td><td id="kpiDelta2Y">+¥9,000</td></tr>
      </tbody>
    </table>
    <div class="desc" style="margin-top:4px;"><a href="#" class="link" onclick="openNotice('本番では補償内容の詳細説明画面に遷移します')">・補償の詳細はコチラ</a></div>
    <button class="btnPrimary" onclick="next()">次へ（特約）</button>
  </div>
</section>
<!-- END: screen-19-vehicle-amount -->

<!-- START: screen-20-riders -->
<section class="screen" data-title="特約の付け外し">
  <div class="card">
    <div class="h1">特約を選ぶ</div>
    <ul class="list">
      <li>現在：弁護士費用・代車費用</li>
    </ul>
    <div class="optionCard">
      <input type="checkbox" id="opt_law" onchange="recalcAll()" aria-label="弁護士費用特約">
      <label class="item" for="opt_law" style="margin:0;">弁護士費用特約（+¥200/月）</label>
    </div>
    <div class="optionCard">
      <input type="checkbox" id="opt_rental" onchange="recalcAll()" aria-label="代車費用特約">
      <label class="item" for="opt_rental" style="margin:0;">代車費用特約（+¥180/月）</label>
    </div>
    <div class="optionCard">
      <input type="checkbox" id="opt_dap" onchange="recalcAll()" aria-label="DAP（ドライブレコーダー）特約">
      <label class="item" for="opt_dap" style="margin:0;">DAP（ドライブレコーダー）特約（+¥200/月）</label>
    </div>
    <table class="priceTable">
      <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
      <tbody>
        <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="kpiCur3">¥5,900</td><td id="kpiCur3Y">¥70,800</td></tr>
        <tr class="rowNew"><td class="rowLabel">更新後</td><td id="kpiNew3">¥7,030</td><td id="kpiNew3Y">¥84,360</td></tr>
        <tr class="rowDelta"><td class="rowLabel">差額</td><td id="kpiDelta3">+¥1,130</td><td id="kpiDelta3Y">+¥13,560</td></tr>
      </tbody>
    </table>
    <div class="desc" style="margin-top:4px;"><a href="#" class="link" onclick="openNotice('本番では補償内容の詳細説明画面に遷移します')">・補償の詳細はコチラ</a></div>
    <button class="btnPrimary" onclick="next()">次へ（最終見積）</button>
  </div>
</section>
<!-- END: screen-20-riders -->

<!-- START: screen-21-final-summary -->
<section class="screen" data-title="最終見積のまとめ">
  <div class="card">
    <div class="h1">最終見積を確認する</div>

    <div class="foldCard" style="margin-top:8px;">
      <div class="foldHeader" style="font-size:13px; font-weight:600; color:var(--blue-900); padding-bottom: var(--sp-8); border-bottom:1px solid rgba(215,224,240,0.8);">
        ※補償内容に変更がある場合は➡で表示
      </div>
      <div class="foldBody">
        <ul class="list" style="margin-top:0; padding-left:1em; list-style:disc;">
          <li>対人・対物：無制限</li>
          <li id="diffBodily">人身傷害：3,000万円 ➡ 5,000万円</li>
          <li id="diffVehicle">車両保険：200万円・免責5万円 ➡ 200万円・免責5万円</li>
          <li id="optSummary">特約：弁護士費用／代車費用 ➡ 弁護士費用／代車費用／DAP（ドライブレコーダー）</li>
        </ul>
      </div>
    </div>

    <div class="desc" style="margin-top:6px;">
      <a href="#" class="link" onclick="openNotice('本番では補償内容の詳細画面に推移します')">補償の詳細はコチラ</a>
    </div>

    <table class="priceTable" style="margin-top:6px;">
      <thead><tr><th class="rowLabel"></th><th>月額</th><th>年額</th></tr></thead>
      <tbody>
        <tr class="rowCurrent"><td class="rowLabel">現在</td><td id="sumCurMonthly">¥5,900</td><td id="sumCurYearly">¥70,800</td></tr>
        <tr class="rowNew"><td class="rowLabel">更新後</td><td id="sumNewMonthly">¥7,030</td><td id="sumNewYearly">¥84,360</td></tr>
        <tr class="rowDelta"><td class="rowLabel">差額</td><td id="sumDeltaMonthly">+¥1,130</td><td id="sumDeltaYearly">+¥13,560</td></tr>
      </tbody>
    </table>

    <button class="btnPrimary" onclick="goToTitle('重要なご説明')">次へ（重要事項）</button>
    <button class="btnPrimary" onclick="goToTitle('人身傷害の金額を選ぶ')">修正へ戻る</button>
  </div>

  <script>
    (function(){
      function normalizeVehicle(val){
        return val
          .replace(/（免責(\d+万円)）/,'・免責$1')
          .replace(/免責：/,'免責');
      }
      function normalizeLine(el, label){
        if (!el) return;
        let txt = el.innerText || '';
        txt = txt.replace(/→/g,'➡');
        txt = txt.replace(/DAP（ドライブレコーダー）特約/g,'DAP（ドライブレコーダー）');
        if (label.includes('車両保険')) {
          const parts = txt.split('：');
          const valueAll = parts.slice(1).join('：');
          const bp = valueAll.split('➡');
          let before = (bp[0]||'').trim();
          let after  = (bp[1]||'').trim();
          before = normalizeVehicle(before);
          after  = normalizeVehicle(after);
          txt = `${label}：${before}` + (after ? ` ➡ ${after}` : '');
        }
        el.textContent = txt;
      }
      function updateFinalSummary(){
        try{
          normalizeLine(document.getElementById('diffBodily'), '人身傷害');
          normalizeLine(document.getElementById('diffVehicle'), '車両保険');
          normalizeLine(document.getElementById('optSummary'),  '特約');
        }catch(e){}
      }
      updateFinalSummary();
      try{
        const orig = window.recalcAll;
        window.recalcAll = function(){
          try{ orig && orig(); }catch(e){}
          updateFinalSummary();
        };
      }catch(e){}
    })();
  </script>
</section>
<!-- END: screen-21-final-summary -->

<!-- START: screen-22-important-info -->
<section class="screen" data-title="重要なご説明">
  <div class="card foldCard">
    <div class="foldHeader">大切なポイント（短くまとめました）</div>
    <div class="foldBody">
      <ul class="list">
        <li>保険を使うと翌年の等級が変わる場合があります</li>
        <li>自己負担（免責）がある補償があります</li>
        <li>正しい内容のご申告をお願いします（虚偽は補償対象外になることがあります）</li>
        <li>事故のときは早めのご連絡が必要です</li>
      </ul>
    </div>
  </div>

  <div class="card foldCard">
    <div class="foldHeader">章ごとの確認（タップで説明）</div>
    <div class="foldSub">各項目をタップすると短い解説を表示します。</div>
    <div class="foldBody">
      <ul class="list">
        <li><a href="#" class="link" onclick="openNotice('本番では詳細を図を交えて表示する画面に推移します')">1章：等級と割引のしくみ</a></li>
        <li><a href="#" class="link" onclick="openNotice('本番では詳細を図を交えて表示する画面に推移します')">2章：自己負担（免責）について</a></li>
        <li><a href="#" class="link" onclick="openNotice('本番では詳細を図を交えて表示する画面に推移します')">3章：告知（ご申告）のお願い</a></li>
        <li><a href="#" class="link" onclick="openNotice('本番では詳細を図を交えて表示する画面に推移します')">4章：事故・故障時の連絡</a></li>
      </ul>
    </div>
  </div>

  <div class="card foldCard">
    <div class="foldHeader">用語をやさしく（タップで説明）</div>
    <div class="foldSub">よく出る用語の意味を短く説明します。タップで詳しく読めます。</div>
    <div class="foldBody">
      <ul class="list">
        <li><a href="#" class="link" onclick="openNotice('本番では詳細解説画面に推移します')">「等級」＝翌年の割引の段階</a></li>
        <li><a href="#" class="link" onclick="openNotice('本番では詳細解説画面に推移します')">「免責」＝自己負担する金額</a></li>
        <li><a href="#" class="link" onclick="openNotice('本番では詳細解説画面に推移します')">「約款」＝保険の大切なルール</a></li>
      </ul>
    </div>
  </div>

  <div class="card foldCard">
    <div class="foldHeader">重要事項の全文</div>
    <div class="foldSub">全文の確認やPDFの受け取り方法をお選びいただけます。</div>
    <div class="foldBody">
      <div class="desc">全文はいつでも読めます。メールでもお送りします。</div>
      <div class="field" style="margin-top:6px;">
        <div class="choiceRow" role="group" aria-label="重要事項の受け取り方法">
          <button class="choiceToggle" id="imp_choice_full" onclick="toggleMultiChoice('imp_full')">全文を表示する</button>
          <button class="choiceToggle" id="imp_choice_pdf" onclick="toggleMultiChoice('imp_pdf')">PDFをメールで受け取る</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <button class="btnPrimary" onclick="finishImportantNext()">次へ（連絡方法を選ぶ）</button>
  </div>
</section>
<!-- END: screen-22-important-info -->

<!-- START: screen-23-contact-method -->
    <section class="screen" data-title="連絡方法を選ぶ">
      <div class="card">
        <div class="h1">連絡方法を選ぶ</div>
        <div class="desc">ご連絡方法をどちらか選び、メールアドレスか電話番号を入力してください</div>
        <div class="field">
          <div class="label">方法</div>
          <div class="choiceRow">
            <button class="choiceToggle" id="choice_contact_email" onclick="toggleChoice('contact_email')">メール</button>
            <button class="choiceToggle" id="choice_contact_sms" onclick="toggleChoice('contact_sms')">SMS</button>
          </div>
        </div>
        <div class="field">
          <div class="label">メールアドレス / 電話番号</div>
          <input class="input" id="contactValue" placeholder="例：name@example.co.jp / 090..." />
        </div>

        <div class="field">
          <div class="label">情報配信のご希望</div>
          <div class="desc" style="margin-bottom:6px;">
            お困りごとが無いかお伺いしたり、<br>
            お役立ち情報や新しい商品・サービスなどの情報を、今後お届けしてもよろしいですか？
          </div>
          <select id="optMarketing">
            <option value="yes" selected>はい</option>
            <option value="no">いいえ</option>
          </select>
        </div>

        <button class="btnPrimary" onclick="finishContactChoice()">次へ（受け取り方法を選ぶ）</button>
      </div>
    </section>
<!-- END: screen-23-contact-method -->

<!-- START: screen-24-receive-method -->
<section class="screen" data-title="受け取り方法を選ぶ">
  <div class="card">
    <div class="h1">受け取り方法を選ぶ</div>

    <div class="list" style="margin-top:6px;">「ご契約のしおり（約款）」「保険証券」「次回更新時のご案内」「申込書控え」の受け取り方法を選択してください。</div>
    <div class="desc" style="margin-top:6px;">※一括でも個別でも選択できます</div>

    <div aria-hidden="true" style="height:8px;"></div>

    <div class="label" style="font-weight:700;">一括で選択する</div>
    <div class="field" style="margin-top:6px;">
      <select id="bulkReceiveSelect" onchange="onBulkReceiveChange(this.value)">
        <option value="">選択してください</option>
        <option value="paper">全てを紙で受け取る</option>
        <option value="web">全てをWebで受け取る</option>
      </select>
    </div>

    <div aria-hidden="true" style="height:8px;"></div>

    <div class="label" style="font-weight:700;">個別に選択・変更する</div>

    <div class="field" style="margin-top:8px;">
      <div class="label">
        ご契約のしおり（約款）
        <button type="button" class="tipIcon" aria-label="約款の説明" onclick="showTermTip('約款')">i</button>
      </div>
      <div class="choiceRow">
        <button class="choiceToggle" id="choice_terms_web" onclick="toggleChoice('terms_web')">Web約款</button>
        <button class="choiceToggle" id="choice_terms_paper" onclick="toggleChoice('terms_paper')">書面</button>
      </div>
    </div>

    <div class="field">
      <div class="label">
        保険証券
        <button type="button" class="tipIcon" aria-label="保険証券の説明" onclick="showTermTip('保険証券')">i</button>
      </div>
      <div class="choiceRow">
        <button class="choiceToggle" id="choice_cert_web" onclick="toggleChoice('cert_web')">Web証券</button>
        <button class="choiceToggle" id="choice_cert_paper" onclick="toggleChoice('cert_paper')">書面</button>
      </div>
    </div>

    <div class="field">
      <div class="label">
        次回更新時のご案内
        <button type="button" class="tipIcon" aria-label="更新案内の説明" onclick="showTermTip('更新案内')">i</button>
      </div>
      <div class="choiceRow">
        <button class="choiceToggle" id="choice_notice_web" onclick="toggleChoice('notice_web')">Web更新案内</button>
        <button class="choiceToggle" id="choice_notice_paper" onclick="toggleChoice('notice_paper')">書面</button>
      </div>
    </div>

    <div class="field">
      <div class="label">
        申込書控えのPDF送付
        <button type="button" class="tipIcon" aria-label="申込書控えPDFの説明" onclick="showTermTip('申込書控えPDF')">i</button>
      </div>
      <div class="choiceRow">
        <button class="choiceToggle" id="choice_pdf_no" onclick="toggleChoice('pdf_no')">不要</button>
        <button class="choiceToggle" id="choice_pdf_yes" onclick="toggleChoice('pdf_yes')">必要</button>
      </div>
    </div>

    <button class="btnPrimary" onclick="finishWebPaper()">次へ（同意と申込）</button>
  </div>

  <script>
    function onBulkReceiveChange(val){
      try{
        if(val!=='paper' && val!=='web') return;
        const isWeb = (val === 'web');

        const setChoiceActive = function(idSuffix, active){
          const el = document.getElementById('choice_'+idSuffix);
          if(!el) return;
          el.classList.toggle('active', !!active);
          el.setAttribute('aria-checked', active ? 'true' : 'false');
          el.setAttribute('tabindex', active ? '0' : '-1');
        };

        // 一括反映：電子（左）/ 紙（右）
        setChoiceActive('terms_web',   isWeb);
        setChoiceActive('terms_paper', !isWeb);
        setChoiceActive('cert_web',    isWeb);
        setChoiceActive('cert_paper',  !isWeb);
        setChoiceActive('notice_web',  isWeb);
        setChoiceActive('notice_paper',!isWeb);
        // PDF送付：電子一括時は不要（左）／紙一括時は必要（右）
        setChoiceActive('pdf_no',      isWeb);
        setChoiceActive('pdf_yes',     !isWeb);

        try{
          window.choiceState = window.choiceState || {};
          ['terms_web','terms_paper','cert_web','cert_paper','notice_web','notice_paper','pdf_yes','pdf_no'].forEach(k=>{
            const el = document.getElementById('choice_'+k);
            window.choiceState[k] = !!(el && el.classList.contains('active'));
          });
        }catch(e){}
      }catch(e){}
    }
  </script>
</section>
<!-- END: screen-24-receive-method -->

<!-- START: screen-25-consent -->
<section class="screen" data-title="同意と申込">
  <div class="card">
    <div class="h1">内容に同意して申し込む</div>

    <div class="desc" style="margin-bottom:6px;">
      <a href="#" class="link" onclick="openNotice('本番では最終のお申込内容の確認画面に推移します')">最終のお申込内容はコチラ</a>
    </div>

    <div class="item"><label><input type="checkbox" id="agree1"> お申込内容を確認しました</label></div>
    <div class="item"><label><input type="checkbox" id="agree2"> 重要なご説明を読みました</label></div>
    <button class="btnPrimary" style="margin-top:10px;" onclick="onAgreeSubmit()">内容に同意して申し込む</button>
  </div>
</section>
<!-- END: screen-25-consent -->

<!-- START: screen-26-done -->
<section class="screen" data-title="申込完了">
  <div class="card">
    <div class="h1">お申込みが完了しました</div>

    <div class="desc">お申込みありがとうございました。</div>

    <div class="item" id="receiptNo">受付番号：ABC12345</div>
    <ul class="list" id="doneList" style="margin-top:6px; list-style:none; padding-left:0;">
      <li class="doneLine" id="doneTermsPostal" style="display:none;">ご契約のしおり（約款）を郵送いたします。</li>
      <li class="doneLine" id="donePostal" style="display:none;">保険証券を郵送いたします。</li>
      <li class="doneLine" id="donePdf" style="display:none;">申込書控え（PDF）を送信しました。</li>
      <li class="doneLine" id="doneImpPdf" style="display:none;">重要事項全文（PDF）を送信しました。</li>
    </ul>
    <button class="btnPrimary" onclick="openNotice('本番では払込方法の確認・変更の画面に推移します。デモ画面はここで終了です。')">次へ（払込方法の確認）</button>
  </div>
</section>
<!-- END: screen-26-done -->

  </main>

<!-- START: footer -->
<footer>
  <div class="footerRow">
    <div class="footerActions">
      <button class="ghost" onclick="prev()">戻る</button>
      <button class="ghost" onclick="saveDraft()">途中保存</button>
    </div>
    <div style="display:flex; gap:6px;">
      <button class="supportItem" onclick="openNotice('本番では電話予約画面に推移します。')">電話予約</button>
      <button class="supportItem" onclick="openNotice('本番ではチャット画面に推移します。')">チャット</button>
    </div>
  </div>
  <div class="footerNote" id="voiceStatus">音声入力の準備ができました（未対応端末ではキーボードのマイクをご利用ください）</div>
  <div class="footerNote">受付時間：平日 9:00–18:00（年末年始を除く）</div>
</footer>
<!-- END: footer -->
</div>

<!-- START: modal-notice -->
<div class="modal" id="noticeModal" role="dialog" aria-modal="true" aria-labelledby="noticeTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="noticeTitle">お知らせ</div>
    <div class="desc" id="noticeBody">本番ではXXXX画面に推移します。</div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="closeNotice()" id="noticeCloseBtn">OK</button>
    </div>
  </div>
</div>
<!-- END: modal-notice -->

<!-- START: modal-reason -->
<div class="modal" id="reasonModal" role="dialog" aria-modal="true" aria-labelledby="reasonTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="reasonTitle">保険料が変わる主な理由（FAQ）</div>
    <div class="desc" id="reasonBody">
      <div style="margin-bottom:8px;">
        以下は一般的な理由の例です。該当の有無は契約ごとに異なります。
      </div>
      <ul class="faqList" aria-label="保険料が変わる主な理由の例">
        <li><strong>料率改定（全体）：</strong>物価上昇、部品・修理費の上昇に伴う保険料算出の見直し。</li>
        <li><strong>年齢・地域・使用状況：</strong>運転者の年齢、居住地域、走行距離などの条件変化。</li>
        <li><strong>事故有の影響：</strong>直近の事故ご利用により翌年の割引（等級）が変動。</li>
        <li><strong>等級の進行：</strong>無事故で割引が進む場合もあれば、条件変化で相殺される場合あり。</li>
        <li><strong>車両価値・修理単価：</strong>車両保険の対象価値や修理単価の推移。</li>
      </ul>
      <div style="margin-top:8px;">
        詳しくは最終見積や契約控えで個別の条件をご確認ください。
      </div>
    </div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="document.getElementById('reasonModal').classList.remove('show')" id="reasonCloseBtn">OK</button>
    </div>
  </div>
</div>
<!-- END: modal-reason -->

<!-- START: modal-security-check -->
<div class="modal" id="securityCheckModal" role="dialog" aria-modal="true" aria-labelledby="securityCheckTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="securityCheckTitle">偽サイトの見分け方（チェックリスト）</div>
    <div class="desc" id="securityCheckBody">
      <ul class="list" aria-label="偽サイトの見分け方チェック項目">
        <li>送信元メールが <strong>@example.co.jp</strong> か確認</li>
        <li>リンク先URLが公式ドメイン <strong>example.co.jp</strong> か確認</li>
        <li>個人情報の「新規の要求」がないか確認（変更の案内のみが一般的）</li>
        <li>不審な場合は、この画面の「ヘルプ」からお問い合わせ</li>
      </ul>
    </div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="closeModal(document.getElementById('securityCheckModal'))" id="securityCheckCloseBtn">閉じる</button>
    </div>
  </div>
</div>
<!-- END: modal-security-check -->

<!-- START: modal-help -->
<div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="helpTitle">ヘルプ（困ったときは）</div>
    <div class="desc" id="helpBody">
      <ul class="list">
        <li>この画面の「音声で解説」を押すと、要点を読み上げます</li>
        <li>入力欄の右側の「音声で入力」で話しかけると自動入力できます</li>
        <li>「文字拡大」を押すと、文字を大きくできます（もう一度押すと戻ります）</li>
        <li>途中で中断するときは「途中保存」を押してください。次回は続きから再開できます</li>
        <li>受け取り方法は「一括で選択する」で簡単に設定できます。個別の変更も可能です</li>
      </ul>
    </div>
    <div style="display:flex; gap:6px; margin-top:10px;">
      <button class="btnPrimary" style="flex:1" onclick="closeModal(document.getElementById('helpModal'))" id="helpCloseBtn">閉じる</button>
    </div>
  </div>
</div>
<!-- END: modal-help -->

<!-- START: modal-ai-choice -->
<div class="modal" id="aiChoiceModal" role="dialog" aria-modal="true" aria-labelledby="aiChoiceTitle" tabindex="-1">
  <div class="box">
    <div class="h1" id="aiChoiceTitle">AIと言葉で対話するかチャットで対話するかお選びください。</div>

    <div class="desc" style="margin-top:6px;">どちらもあとから切り替えできます。</div>
    <div aria-hidden="true" style="height:8px;"></div>

    <div class="field" style="margin-top:8px;">
      <div class="choiceRow" role="group" aria-label="AI対話方式の選択">
        <button class="choiceToggle" id="ai_choice_voice" onclick="aiChoiceSelect('voice')">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="#3c7fe6" d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V20H9v2h6v-2h-2v-2.08A7 7 0 0 0 19 11h-2z"/>
          </svg>
          言葉
        </button>
        <button class="choiceToggle" id="ai_choice_chat" onclick="aiChoiceSelect('chat')">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="#3c7fe6" d="M20 2H4a2 2 0 0 0-2 2v14l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/>
          </svg>
          チャット
        </button>
      </div>
    </div>

    <div style="display:flex; gap:6px; margin-top:12px;">
      <button class="btnPrimary" style="flex:1" onclick="closeModal(document.getElementById('aiChoiceModal'))">閉じる</button>
    </div>
  </div>
</div>
<!-- END: modal-ai-choice -->

<!-- START: modal-monthday-picker -->
<div class="modal" id="monthDayPickerModal" role="dialog" aria-modal="true" aria-labelledby="mdPickerTitle" tabindex="-1">
  <div class="box">
    <div class="h1 mdPickerHeader" id="mdPickerTitle">有効期限の月・日を選ぶ</div>
    <div class="mdPickerSub" id="mdPickerSub">まず「月」を選んでください。選択後に「日」へ切り替わります。</div>
    <div id="mdPickerGrid" class="mdGrid" role="grid" aria-label="月・日選択グリッド"></div>
    <div class="mdActions">
      <button class="mdClose" onclick="closeModal(document.getElementById('monthDayPickerModal'))" aria-label="閉じる">×閉じる</button>
    </div>
  </div>
</div>
<!-- END: modal-monthday-picker -->

<!-- START: toast -->
<div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>
<!-- END: toast -->

<!-- START: js-core-bootstrap -->
<script>
  (function(){
    if (!window.App){
      window.App = { version: 'core-split-2025-12-01', modules: {}, bus: {}, flags:{} };
      const listeners = {};
      App.bus.on = function(evt, fn){ (listeners[evt] ||= []).push(fn); };
      App.bus.emit = function(evt, payload){ (listeners[evt] || []).forEach(fn => { try{ fn(payload); }catch(e){} }); };
    }
  })();
</script>
<!-- END: js-core-bootstrap -->

<!-- START: js-core-utils -->
<script>
  (function(App){
    if (App.modules && App.modules.utils) return;
    const safeTimers = new Set();
    const utils = {
      setSafeTimeout(fn, ms){
        const id = setTimeout(()=>{ safeTimers.delete(id); try{ fn(); }catch(e){}; }, ms);
        safeTimers.add(id); return id;
      },
      clearAllSafeTimeouts(){ safeTimers.forEach(id=> clearTimeout(id)); safeTimers.clear(); },
      clamp(n,min,max){ return Math.max(min, Math.min(max, n)); },
      isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }
    };
    App.modules = App.modules || {};
    App.modules.utils = utils;
  })(window.App || (window.App={modules:{},bus:{on(){},emit(){}}}));
</script>
<!-- END: js-core-utils -->

<!-- START: js-core-guided-voice -->
<script>
  (function(App){
    if (App.modules && App.modules.guidedVoice) return;
    const U = (App.modules && App.modules.utils) || {};

    let guidedSpeaking = false;
    let cancelFlag = false;
    let guidedCancelFn = function(){ cancelFlag = true; App.bus && App.bus.emit && App.bus.emit('voice:cancel'); };

    const ITEM_PAUSE=1500, SUB_PAUSE=700, NAME_BRIEF_PAUSE=30, BREAK_PAUSE=400;

    function setGuidedBtn(){
      const lbl=document.getElementById('lblSpeak');
      if(lbl) lbl.textContent = guidedSpeaking ? '音声を停止' : '音声で解説';
    }

    function speakQueue(queue,{rate=1.0,volume=1.0}={}){
      cancelFlag=false;
      const play=(idx)=>{
        if(cancelFlag) return;
        if(idx>=queue.length){ guidedSpeaking=false; setGuidedBtn(); App.bus && App.bus.emit && App.bus.emit('voice:end'); return; }
        const seg=queue[idx];
        const u=new SpeechSynthesisUtterance(seg.text);
        u.lang='ja-JP'; u.rate=rate; u.volume=volume;
        u.onstart=()=>{ guidedSpeaking=true; setGuidedBtn(); App.bus && App.bus.emit && App.bus.emit('voice:start'); };
        u.onend=()=>{ if(!cancelFlag) setTimeout(()=>play(idx+1), typeof seg.pause==='number'? seg.pause: ITEM_PAUSE); };
        u.onerror=()=>{ if(!cancelFlag) setTimeout(()=>play(idx+1), 300); };
        try{ speechSynthesis.speak(u);}catch(e){ setTimeout(()=>play(idx+1), 300); }
      };
      try{ speechSynthesis.cancel(); }catch(e){}
      guidedSpeaking=true; setGuidedBtn(); play(0);
    }

    function stopGuidedVoice(){
      try{ if (typeof guidedCancelFn === 'function') guidedCancelFn(); }catch(e){}
      try{ if ('speechSynthesis' in window) speechSynthesis.cancel(); }catch(e){}
      guidedSpeaking=false; setGuidedBtn(); App.bus && App.bus.emit && App.bus.emit('voice:stop');
    }

    // 読み上げ補助
    const DASH_REGEX=/[‐‑‒–—−ー－-]/g;
    function normalizeDigitsAndDashes(s){ const toHalf=s.replace(/[０-９]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)); return toHalf.replace(DASH_REGEX,'-'); }
    function replaceMaruWords(s){ return s.replace(/〇〇/g,'マルマル').replace(/〇/g,'マル'); }
    function readBlockNumberForSpeech(bn){
      const map={'0':'ゼロ','1':'イチ','2':'ニ','3':'サン','4':'ヨン','5':'ゴ','6':'ロク','7':'ナナ','8':'ハチ','9':'キュウ'};
      const normalized=normalizeDigitsAndDashes(bn);
      const parts=normalized.split('-').filter(Boolean).map(token=> token.split('').map(d=> map[d]||d).join(''));
      return parts.join('の');
    }
    function buildAddressSegments(addr){
      const segs=[]; let rest=addr;
      if(rest.includes('東京都')){ segs.push('東京都'); rest=rest.replace('東京都',''); }
      if(rest.includes('港区'))  { segs.push('港区');   rest=rest.replace('港区',''); }
      if(rest.includes('赤坂')){ segs.push('アカサカ'); rest=rest.replace('赤坂',''); }
      rest = replaceMaruWords(rest);
      const normalized=normalizeDigitsAndDashes(rest);
      const blockMatch=normalized.match(/(\d+(?:-\d+)+|\d+)/);
      if(blockMatch){
        segs.push(readBlockNumberForSpeech(blockMatch[1]));
        rest=rest.replace(/[０-９0-9][０-９0-9\- ‑‒–—−ー－]*/, '').trim();
      }
      if(rest) segs.push(rest.replace(/\s+/g,''));
      return segs.filter(Boolean);
    }
    function kanaDigits(s){ const map={'0':'ゼロ','1':'イチ','2':'ニ','3':'サン','4':'ヨン','5':'ゴ','6':'ロク','7':'ナナ','8':'ハチ','9':'キュウ'}; return s.split('').map(d=> map[d]||d).join(''); }
    function formatPhoneNo(phoneRaw){
      const p=phoneRaw.replace(/[^\d]/g,'');
      if(p.length===11) return `${kanaDigits(p.slice(0,3))}の${kanaDigits(p.slice(3,7))}の${kanaDigits(p.slice(7))}`;
      if(p.length===10) return `${kanaDigits(p.slice(0,3))}の${kanaDigits(p.slice(3,7))}の${kanaDigits(p.slice(7))}`;
      return kanaDigits(p);
    }

    function buildGuidedQueue(){
      const screens=[...document.querySelectorAll('.screen')];
      const step = screens.findIndex(s=> s.classList.contains('active'));
      const titles = ()=> screens.map(s=> s.dataset.title);
      const title = titles()[step];
      if(title==='お客様情報の確認'){
        const list=document.getElementById('custList');
        const lines=(list?.innerText||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const name=(lines.find(v=>v.startsWith('氏名：'))||'').replace('氏名：','').trim();
        const gender=(lines.find(v=>v.startsWith('性別：'))||'').replace('性別：','').trim();
        const addr=(lines.find(v=>v.startsWith('住所：'))||'').replace('住所：','').trim();
        const phone=(lines.find(v=>v.startsWith('電話番号：'))||'').replace('電話番号：','').trim();
        const dob=(lines.find(v=>v.startsWith('生年月日：'))||'').replace('生年月日：','').trim();
        const company=(lines.find(v=>v.startsWith('勤務先：'))||'').replace('勤務先：','').trim();
        const q=[];
        q.push({text:'変更はございますか？ご登録内容を読み上げます。', pause:ITEM_PAUSE});
        if(name){ q.push({text:`氏名は、${name}`, pause:NAME_BRIEF_PAUSE}); q.push({text:'サマ。', pause:ITEM_PAUSE}); const g = gender.includes('女性') ? 'ジョセイ' : 'ダンセイ'; q.push({text:`セイベツワ　${g}`, pause:ITEM_PAUSE}); }
        if(addr){
          const addrSegs=buildAddressSegments(addr);
          if(addrSegs.length){
            q.push({text:'住所は、', pause:SUB_PAUSE});
            addrSegs.forEach((s,i)=> q.push({text:s+(i===addrSegs.length-1?'':'、'), pause:SUB_PAUSE}));
            q.push({text:'。', pause:ITEM_PAUSE});
          }else{ q.push({text:`住所は、${addr}。`, pause:ITEM_PAUSE}); }
        }
        if(phone){ q.push({text:`電話番号は、${formatPhoneNo(phone)}。`, pause:ITEM_PAUSE}); }
        if(dob){
          q.push({text:`生年月日は${dob.replace('日','')}ニチ`, pause:ITEM_PAUSE});
          if(company){
            const compReading = (会社名 => 会社名==='ABC株式会社' ? 'エービーシーカブシキガイシャ' : 会社名)(company);
            q.push({text:`キンムサキワ　${compReading}`, pause:ITEM_PAUSE});
          }
        }
        q.push({text:'内容に変更はございますか。変更がある場合は、変更するボタンを押してください。', pause:0});
        return q;
      }
      const raw = (screens[step]?.innerText || '');
      const lines = raw.split('\n').map(s=> s.trim()).filter(Boolean);
      const queue = [];
      lines.forEach((line, idx)=>{ queue.push({ text: line, pause: (idx === lines.length-1 ? SUB_PAUSE : BREAK_PAUSE) }); });
      return queue.length ? queue : [{text: raw.replace(/\s+/g,' '), pause:0}];
    }

    function toggleGuidedVoice(){
      if (!('speechSynthesis' in window)) { try{ showToast('音声読み上げに未対応のブラウザです'); }catch(e){} return; }
      if (guidedSpeaking) { stopGuidedVoice(); try{ showToast('音声を停止しました'); }catch(e){} return; }
      const queue=buildGuidedQueue();
      const screens=[...document.querySelectorAll('.screen')];
      const step = screens.findIndex(s=> s.classList.contains('active'));
      const title = screens[step]?.dataset?.title || '';
      const isIOS = U && U.isIOS && U.isIOS();
      const opts={ rate:1.0, volume:1.0 };
      const merged = isIOS && (title !== 'お客様情報の確認')
        ? [{text:queue.map(q=>q.text).join('。'), pause:0}] : queue;
      speakQueue(merged, opts);
      try{ showToast('音声で解説を開始しました（再タップで停止）'); }catch(e){}
    }

    App.modules = App.modules || {};
    App.modules.guidedVoice = {
      speakQueue, stop: stopGuidedVoice, toggle: toggleGuidedVoice,
      buildGuidedQueue, get speaking(){ return guidedSpeaking; },
      get cancel(){ return guidedCancelFn; }, cancelQueue(){ guidedCancelFn(); }
    };

    // 互換API
    window.stopGuidedVoice = stopGuidedVoice;
    window.toggleGuidedVoice = toggleGuidedVoice;
    window.setGuidedBtn = setGuidedBtn;
    window.guidedCancelFn = guidedCancelFn;
    window.guidedSpeaking = guidedSpeaking;
  })(window.App || (window.App={modules:{},bus:{on(){},emit(){}}}));
</script>
<!-- END: js-core-guided-voice -->

<!-- START: js-core-progress -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.progress) return;

    // 可視ステップの計算（TITLE_NO優先、無い場合はindexベース）
    function computeVisualStep(i, screens, TITLE_NO, MAX_STEPS){
      try{
        const titles = screens.map(s => s.dataset.title || '');
        const t = titles[i] || '';
        const m = (TITLE_NO && typeof TITLE_NO[t] === 'number') ? TITLE_NO[t] : null;
        if (typeof m === 'number') return Math.max(1, Math.min(MAX_STEPS, m));
        const coverCount = screens.slice(0, i+1).filter(s => s.dataset.role === 'cover').length;
        return Math.max(1, Math.min(MAX_STEPS, (i + 1 - coverCount)));
      }catch(e){
        return Math.max(1, Math.min(MAX_STEPS, i+1));
      }
    }

    // 章ハイライト更新（active表示＋完了✓付与）
    function updateChapters(visualStep){
      try{
        // 章のアクティブ判定（従来の境界）
        const chapKey = (visualStep<=13) ? 'input'
                        : (visualStep<=21 ? 'estimate'
                        : (visualStep===22 ? 'explain' : 'apply'));
        const ids = ['chapInput','chapEstimate','chapExplain','chapApply'];
        ids.forEach(id=>{
          const el=document.getElementById(id);
          if(!el) return;
          const isActive =
            (chapKey==='input'   && id==='chapInput') ||
            (chapKey==='estimate'&& id==='chapEstimate') ||
            (chapKey==='explain' && id==='chapExplain') ||
            (chapKey==='apply'   && id==='chapApply');
          el.classList.toggle('active', isActive);
        });

        // ✓付与タイミング（指定ステップで点灯）
        // ・「お車情報」章に✓：step >= 7（お客様情報の確認）
        // ・「お客様情報」章に✓：step >= 14（現在の内容を確認）
        // ・「更新手続」章に✓：step >= 22（重要なご説明）
        // ・「申込」章に✓：step >= 26（申込完了）
        const doneInput    = (visualStep >= 7);
        const doneEstimate = (visualStep >= 14);
        const doneExplain  = (visualStep >= 22);
        const doneApply    = (visualStep >= 26);

        const inEl  = document.getElementById('chapInput');
        const estEl = document.getElementById('chapEstimate');
        const exEl  = document.getElementById('chapExplain');
        const apEl  = document.getElementById('chapApply');
        if (inEl)  inEl.classList.toggle('done', doneInput);
        if (estEl) estEl.classList.toggle('done', doneEstimate);
        if (exEl)  exEl.classList.toggle('done', doneExplain);
        if (apEl)  apEl.classList.toggle('done', doneApply);
      }catch(e){}
    }

    // 進捗UI更新
    function updateProgressUI(visualStep, MAX_STEPS){
      try{
        const progText = document.getElementById('progressText');
        if (progText) {
          progText.textContent = visualStep===1 ? `進捗 ${visualStep}/${MAX_STEPS}（最大）` : `進捗 ${visualStep}/${MAX_STEPS}`;
        }
        const pct = (visualStep / MAX_STEPS) * 100;
        const bar = document.getElementById('progressBar');
        if (bar){
          bar.style.width = `${pct}%`;
          bar.setAttribute('aria-valuemin','0');
          bar.setAttribute('aria-valuemax', String(MAX_STEPS));
          bar.setAttribute('aria-valuenow', String(visualStep));
          bar.setAttribute('aria-valuetext', `全${MAX_STEPS}ステップ中の${visualStep}ステップ目`);
        }
      }catch(e){}
    }

    // 残り時間の目安更新（<1分は「残り約1分未満」で表示）
    function updateTimeLeft(visualStep, MAX_STEPS){
      try{
        const remainingRaw = 12 * (MAX_STEPS - visualStep) / MAX_STEPS;
        const remainingRounded = Math.round(remainingRaw);
        const timeLeftEl = document.getElementById('timeLeft');
        if (!timeLeftEl) return;
        if (visualStep < MAX_STEPS && remainingRounded === 0 && remainingRaw > 0){
          timeLeftEl.textContent = '残り約1分未満';
        }else{
          timeLeftEl.textContent = `残り約${remainingRounded}分`;
        }
      }catch(e){}
    }

    // 画面アクティブ変更時の進捗更新
    function onActive(index, screens, MAX_STEPS, TITLE_NO){
      try{
        const visualStep = computeVisualStep(index, screens, TITLE_NO, MAX_STEPS);
        updateProgressUI(visualStep, MAX_STEPS);
        updateChapters(visualStep);
        updateTimeLeft(visualStep, MAX_STEPS);
      }catch(e){}
    }

    App.modules.progress = { onActive, computeVisualStep, updateChapters };
  })(window.App);
</script>
<!-- END: js-core-progress -->

<!-- START: js-core-storage -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.storage) return;

    var KEY = 'auto_ins_update_draft';

    function safeOpenNotice(msg){
      try{
        if (typeof window.openNotice === 'function') { openNotice(msg); }
        else { alert(msg); }
      }catch(e){}
    }

    function save(){
      try{
        // グローバル（js-core）から最小限の状態を取得
        var curStep = (typeof window.step === 'number') ? window.step : 0;
        var getTitles = (typeof window.titles === 'function') ? window.titles : function(){ return Array.from(document.querySelectorAll('.screen')).map(function(s){ return s.dataset.title || ''; }); };
        var titleArr = getTitles();
        var title = titleArr[curStep] || '';
        var hist = Array.isArray(window.historyStack) ? window.historyStack.slice() : [];
        // 新しい保存では「提案抑止」を解除（=次回提案する）
        var data = { step: curStep, title: title, hist: hist, timestamp: new Date().toISOString(), suppressed: false };
        localStorage.setItem(KEY, JSON.stringify(data));
        safeOpenNotice('途中保存しました。次回は前回の続きから再開できます（デモ）。');
      }catch(e){
        safeOpenNotice('保存に失敗しました（デモ）。');
      }
    }

    function load(){
      try{
        var raw = localStorage.getItem(KEY);
        if (!raw) return null;
        var data = JSON.parse(raw);
        if (!data || typeof data.step !== 'number') return null;
        return data;
      }catch(e){
        return null;
      }
    }

    function clear(){
      try{ localStorage.removeItem(KEY); }catch(e){}
    }

    // 初回読み込み時に下書きがあれば復元の提案（軽量なconfirmで実装）
    function offerResume(){
      try{
        var data = load();
        if (!data) return;

        // suppressed（提案抑止）フラグが立っていれば提案しない
        if (data.suppressed === true) return;

        // すでに表紙でない or すでにナビゲーション開始済みなら提案しない
        var screens = Array.from(document.querySelectorAll('.screen'));
        var activeIdx = screens.findIndex(function(s){ return s.classList.contains('active'); });
        var isCover = function(i){ return !!(screens[i] && screens[i].dataset.role === 'cover'); };
        var onCover = isCover(activeIdx);
        if (!onCover) return;

        var ok = window.confirm('前回の続き（「' + (data.title || '前回の画面') + '」）から再開しますか？');
        if (!ok){
          // ユーザーがキャンセルした場合は、次回以降の提案を抑止
          data.suppressed = true;
          try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){}
          return;
        }

        // ヒストリーも復元（可能な範囲）
        try{
          if (Array.isArray(data.hist)) {
            window.historyStack = data.hist.slice(); // 破壊的代入
          }
        }catch(e){}

        // 該当タイトルへ移動（なければ step index でフォールバック）
        var titlesFn = (typeof window.titles === 'function') ? window.titles : function(){ return screens.map(function(s){ return s.dataset.title || ''; }); };
        var list = titlesFn();
        var tIdx = list.indexOf(data.title);
        if (tIdx >= 0 && typeof window.goToTitle === 'function') {
          window.goToTitle(data.title);
        } else if (typeof window.setActive === 'function') {
          window.setActive(Math.max(0, Math.min(screens.length - 1, data.step)));
        } else if (typeof window.goToTitle === 'function') {
          // 最後の手段
          window.goToTitle('手続き開始');
        }
      }catch(e){}
    }

    App.modules.storage = { save, load, clear, offerResume };

    // 既存onclick互換（js-core短縮後もここに委譲）
    if (typeof window.saveDraft !== 'function'){
      window.saveDraft = function(){ try{ App.modules.storage.save(); }catch(e){} };
    }
  })(window.App);
</script>
<!-- END: js-core-storage -->

<!-- START: js-core-network -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.network) return;

    // 設定（将来の本番API切替を見据えた簡易設定）
    var cfg = {
      baseUrl: '',          // 本番でAPIベースURLを入れる
      timeoutMs: 10000,     // ネットワークタイムアウト
      mock: true            // デモ中はモック
    };

    function safeOpenNotice(msg){
      try{ (typeof window.openNotice === 'function') ? openNotice(msg) : alert(msg); }catch(e){}
    }
    function safeToast(msg){
      try{ (typeof window.showToast === 'function') ? showToast(msg) : console.log('[toast]', msg); }catch(e){}
    }
    function focusOtp(){
      try{ document.getElementById('otp1')?.focus(); }catch(e){}
    }

    // 汎用リクエスト（今後の拡張用）
    async function request(path, opts){
      if (cfg.mock){
        // デモでは疑似遅延のみ
        await new Promise(r => setTimeout(r, 450));
        return { ok:true, status:200, json: async()=>({ ok:true }) };
      }
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), cfg.timeoutMs);
      try{
        const res = await fetch((cfg.baseUrl || '') + path, { ...opts, signal: ctrl.signal });
        clearTimeout(id);
        return res;
      }catch(e){
        clearTimeout(id);
        throw e;
      }
    }

    // 認証コード送信（デモ実装：入力チェック + 成功トースト + フォーカス移動）
    async function sendLoginCode(){
      try{
        const id = (document.getElementById('loginId')?.value || '').trim();
        if (!id){
          safeOpenNotice('電話番号またはメールアドレスを入力してください');
          return;
        }
        // 通信中の見た目（任意）
        try{ if (typeof window.showLoading === 'function') showLoading(); }catch(_){}

        // デモはmock成功
        await request('/auth/send-code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ loginId:id }) });

        try{ if (typeof window.hideLoading === 'function') hideLoading(); }catch(_){}
        safeToast('認証コードを送信しました（デモ）。届いた４桁の認証コードを入力してください');
        focusOtp();
      }catch(e){
        try{ if (typeof window.hideLoading === 'function') hideLoading(); }catch(_){}
        safeOpenNotice('認証コードの送信に失敗しました。しばらくしてから再度お試しください。');
      }
    }

    App.modules.network = { sendLoginCode, request, config: cfg };

    // 既存のonclick互換（js-core短縮後はここに委譲）
    if (typeof window.sendLoginCode !== 'function'){
      window.sendLoginCode = function(){ try{ App.modules.network.sendLoginCode(); }catch(e){} };
    }
  })(window.App);
</script>
<!-- END: js-core-network -->

<!-- START: js-core-estimate -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.estimate) return;

    // 内部状態（従来どおり）
    let cur=5900, same=6400, bodily='3000';

    // ユーティリティ
    function money(n){ return '¥'+Math.round(n).toLocaleString(); }
    function setCell(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
    function setDelta(id,v){
      const el=document.getElementById(id); if(!el) return;
      const sign=v>=0?'+':'-'; const abs=Math.abs(v);
      el.textContent=`${sign}¥${Math.round(abs).toLocaleString()}`;
      el.classList.toggle('dpos',v>=0); el.classList.toggle('dneg',v<0);
    }
    function normalizeVehicleText(amount, deduct){
      const dMText = (deduct === 0) ? '0万円' : (deduct === 100000 ? '10万円' : '5万円');
      if (amount === 0) return 'なし';
      return `${amount}万円・免責${dMText}`;
    }

    function recalcSamePage(){
      const sameM=same, sameY=same*12, curM=cur, curY=cur*12;
      setCell('curMonthly12', money(curM)); setCell('curYearly12', money(curY));
      setCell('sameMonthly', money(sameM)); setCell('sameYearly', money(sameY));
      setCell('deltaMonthlyBox',(sameM-curM>=0?'+':'-')+'¥'+Math.abs(sameM-curM).toLocaleString());
      setCell('deltaYearlyBox',(sameY-curY>=0?'+':'-')+'¥'+Math.abs(sameY-curY).toLocaleString());
      setCell('planUpCurM', money(curM)); setCell('planUpCurY', money(curY));
      setCell('planUpNewM', money(6900)); setCell('planUpNewY', money(6900*12));
      setDelta('planUpDeltaM', 6900-curM); setDelta('planUpDeltaY', 6900*12-curY);
      setCell('planDownCurM', money(curM)); setCell('planDownCurY', money(curY));
      setCell('planDownNewM', money(4800)); setCell('planDownNewY', money(4800*12));
      setDelta('planDownDeltaM', 4800-curM); setDelta('planDownDeltaY', 4800*12-curY);
    }

    function updateDiffLinesDynamic(){
      const bEl = document.getElementById('diffBodily');
      if (bEl){
        const curB = '3,000万円';
        let newB = '3,000万円';
        if (bodily === '5000') newB = '5,000万円';
        else if (bodily === '8000') newB = '8,000万円';
        else if (bodily === '10000') newB = '1億円';
        else if (bodily === 'unlimited') newB = '無制限';
        bEl.textContent = (newB === curB)
          ? `人身傷害：${curB}`
          : `人身傷害：${curB} ➡ ${newB}`;
      }
      const vEl = document.getElementById('diffVehicle');
      if (vEl){
        const vehA = Number(document.getElementById('vehicleAmount')?.value || 200);
        const deduct = Number(document.getElementById('deduct')?.value || 50000);
        const curV = `200万円・免責5万円`;
        const newV = normalizeVehicleText(vehA, deduct);
        vEl.textContent = (newV === curV)
          ? `車両保険：${curV}`
          : `車両保険：${curV} ➡ ${newV}`;
      }
    }

    function getSelectedOptionsLabels(){
      const s=[];
      if(document.getElementById('opt_law')?.checked)    s.push('弁護士費用');
      if(document.getElementById('opt_rental')?.checked) s.push('代車費用');
      if(document.getElementById('opt_dap')?.checked)    s.push('DAP（ドライブレコーダー）');
      return s;
    }
    const currentOptionBaseline=['弁護士費用','代車費用'];
    function arrayEqualIgnoreOrder(a,b){ if(a.length!==b.length) return false; const aa=[...a].sort(), bb=[...b].sort(); return aa.every((v,i)=> v===bb[i]); }
    function normalizeOptionLabel(lbl){
      return String(lbl || '')
        .replace(/特約/g, '')
        .replace(/DAP（ドライブレコーダー）特約/g, 'DAP（ドライブレコーダー）');
    }
    function renderOptionDiff(newList){
      const curStr='弁護士費用／代車費用';
      const newStr = newList.length ? newList.map(normalizeOptionLabel).join('／') : 'なし';
      const el=document.getElementById('optSummary'); if(!el) return;
      if(arrayEqualIgnoreOrder(newList, currentOptionBaseline)){
        el.textContent = `特約：${curStr}`;
      }else{
        el.textContent = `特約：${curStr} ➡ ${newStr}`;
      }
    }

    let optSummaryMode='dynamic';
    function updateOptionSummary(){
      if(optSummaryMode==='fixedCurrent'){ renderOptionDiff([...currentOptionBaseline]); return; }
      if(optSummaryMode==='fixedNone'){ renderOptionDiff([]); return; }
      const sel=getSelectedOptionsLabels(); renderOptionDiff(sel);
    }

    function recalcAll(){
      recalcSamePage();
      let bodilyAdj=0;
      if(bodily==='5000') bodilyAdj=400; else if(bodily==='8000') bodilyAdj=700; else if(bodily==='10000') bodilyAdj=900; else if(bodily==='unlimited') bodilyAdj=1200;
      const vehA=Number(document.getElementById('vehicleAmount')?.value||200);
      const deduct=Number(document.getElementById('deduct')?.value||50000);
      const optLaw=document.getElementById('opt_law')?.checked?200:0;
      const optRent=document.getElementById('opt_rental')?.checked?180:0;
      const optDap=document.getElementById('opt_dap')?.checked?200:0;
      const vehAdj=vehA===0?-1200:(vehA===150?300:(vehA===200?600:900));
      let deductAdj=0; if(deduct===0) deductAdj=400; else if(deduct===100000) deductAdj=-400;
      const optAdj=optLaw+optRent+(isNaN(optDap)?0:optDap);
      const newMonthly=Math.max(1500, same + bodilyAdj + vehAdj + deductAdj + optAdj);
      const newYearly=newMonthly*12;
      setCell('curMonthly', money(cur)); setCell('curYearly', money(cur*12));
      setCell('kpiCur1', money(cur)); setCell('kpiCur1Y', money(cur*12));
      setCell('kpiNew1', money(newMonthly)); setCell('kpiNew1Y', money(newYearly)); setDelta('kpiDelta1', newMonthly-cur); setDelta('kpiDelta1Y', newYearly - cur*12);
      setCell('kpiCur2', money(cur)); setCell('kpiCur2Y', money(cur*12));
      setCell('kpiNew2', money(newMonthly)); setCell('kpiNew2Y', money(newYearly)); setDelta('kpiDelta2', newMonthly-cur); setDelta('kpiDelta2Y', newYearly - cur*12);
      setCell('kpiCur3', money(cur)); setCell('kpiCur3Y', money(cur*12));
      setCell('kpiNew3', money(newMonthly)); setCell('kpiNew3Y', money(newYearly)); setDelta('kpiDelta3', newMonthly-cur); setDelta('kpiDelta3Y', newYearly - cur*12);
      setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12));
      setCell('sumNewMonthly', money(newMonthly)); setCell('sumNewYearly', money(newYearly));
      setDelta('sumDeltaMonthly', newMonthly-cur); setDelta('sumDeltaYearly', newYearly - cur*12);
      updateOptionSummary();
      try { if (typeof window.updateFinalSummary === 'function') window.updateFinalSummary(); } catch(e){}
    }

    function onBodilyChange(val){ bodily=val||'3000'; recalcAll(); }

    function chooseSameFlow(){
      optSummaryMode='fixedCurrent';
      const newM=same, newY=newM*12;
      setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12));
      setCell('sumNewMonthly', money(newM)); setCell('sumNewYearly', money(newY));
      setDelta('sumDeltaMonthly', newM-cur); setDelta('sumDeltaYearly', newY - cur*12);
      const b=document.getElementById('diffBodily'), v=document.getElementById('diffVehicle');
      if(b) b.textContent='人身傷害：3,000万円';
      if(v) v.textContent='車両保険：200万円・免責5万円';
      updateOptionSummary();
      try { if (typeof window.updateFinalSummary === 'function') window.updateFinalSummary(); } catch(e){}
      if (typeof window.goToTitle === 'function') window.goToTitle('重要なご説明');
    }
    function openSimplePlans(){ if (typeof window.goToTitle === 'function') window.goToTitle('別のプランから選ぶ'); }
    function goStepByStep(){ optSummaryMode='dynamic'; if (typeof window.goToTitle === 'function') window.goToTitle('人身傷害の金額を選ぶ'); }
    function chooseSimplePlan(type){
      let newM=same;
      const b=document.getElementById('diffBodily');
      const v=document.getElementById('diffVehicle');
      if(type==='up'){
        newM=6900;
        if(b) b.textContent='人身傷害：3,000万円 ➡ 5,000万円';
        if(v) v.textContent='車両保険：200万円・免責5万円 ➡ 250万円・免責5万円';
        optSummaryMode='fixedCurrent';
      }else{
        newM=4800;
        if(b) b.textContent='人身傷害：3,000万円';
        if(v) v.textContent='車両保険：あり ➡ なし';
        optSummaryMode='fixedNone';
      }
      const newY=newM*12;
      setCell('sumCurMonthly', money(cur)); setCell('sumCurYearly', money(cur*12));
      setCell('sumNewMonthly', money(newM)); setCell('sumNewYearly', money(newY));
      setDelta('sumDeltaMonthly', newM - cur); setDelta('sumDeltaYearly', newY - cur*12);
      updateOptionSummary();
      try { if (typeof window.updateFinalSummary === 'function') window.updateFinalSummary(); } catch(e){}
      if (typeof window.goToTitle === 'function') window.goToTitle('重要なご説明');
    }

    // 公開API
    App.modules.estimate = {
      recalcAll, onBodilyChange, chooseSameFlow, openSimplePlans, goStepByStep, chooseSimplePlan
    };

    // 互換API（HTMLのonclick互換維持）
    window.recalcAll = recalcAll;
    window.onBodilyChange = onBodilyChange;
    window.chooseSameFlow = chooseSameFlow;
    window.openSimplePlans = openSimplePlans;
    window.goStepByStep = goStepByStep;
    window.chooseSimplePlan = chooseSimplePlan;
  })(window.App);
</script>
<!-- END: js-core-estimate -->

<!-- START: js-estimate-final-bridge -->
<script>
  (function(){
    // recalcAll の呼び出しで最終見積の表記整形も確実に呼ぶ統合ラッパ
    try{
      var mod = (window.App && App.modules && App.modules.estimate) ? App.modules.estimate : null;
      if (mod && typeof mod.recalcAll === 'function'){
        var originalRecalc = mod.recalcAll;
        var unified = function(){
          try{ originalRecalc(); }catch(e){}
          try{ if (typeof window.updateFinalSummary === 'function') window.updateFinalSummary(); }catch(e){}
        };
        // モジュール内とwindow双方に統一版を適用
        App.modules.estimate.recalcAll = unified;
        window.recalcAll = unified;
      }
    }catch(e){}

    // 人身傷害・車両/免責の変更時は即時に再計算＋最終整形
    function bindLiveRecalc(){
      try{
        var bodilySel = document.getElementById('bodilyAmount');
        var vehSel    = document.getElementById('vehicleAmount');
        var dedSel    = document.getElementById('deduct');
        var handler = function(){
          try{ App.modules && App.modules.estimate && App.modules.estimate.recalcAll(); }catch(e){}
        };
        if (bodilySel) bodilySel.addEventListener('change', handler);
        if (vehSel)    vehSel.addEventListener('change', handler);
        if (dedSel)    dedSel.addEventListener('change', handler);
      }catch(e){}
    }
    document.addEventListener('DOMContentLoaded', bindLiveRecalc);
  })();
</script>
<!-- END: js-estimate-final-bridge -->

<!-- START: js-core-modal -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.modal) return;

    let lastFocus = null;

    function getFocusable(container){
      try{
        return Array.from(container.querySelectorAll(
          'a[href], area[href], input:not([disabled]), select:not([disabled]), ' +
          'textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )).filter(el => el.offsetParent !== null);
      }catch(e){ return []; }
    }

    function trapFocus(modal){
      function onKeyDown(e){
        if (e.key === 'Escape') { e.preventDefault(); closeModal(modal); return; }
        if (e.key !== 'Tab') return;
        const f = getFocusable(modal); if (f.length === 0) return;
        const first = f[0], last = f[f.length-1];
        if (e.shiftKey){
          if (document.activeElement === first || !modal.contains(document.activeElement)) { e.preventDefault(); last.focus(); }
        }else{
          if (document.activeElement === last || !modal.contains(document.activeElement)) { e.preventDefault(); first.focus(); }
        }
      }
      modal.__trapHandler = onKeyDown;
      document.addEventListener('keydown', onKeyDown);
    }

    function untrapFocus(modal){
      if (modal.__trapHandler){
        document.removeEventListener('keydown', modal.__trapHandler);
        modal.__trapHandler = null;
      }
    }

    function openModal(modal){
      try{
        lastFocus = document.activeElement;
        modal.classList.add('show');
        const f = getFocusable(modal);
        (f.find(el=>el.id && /CloseBtn$/i.test(el.id)) || f[0] || modal).focus();
        trapFocus(modal);
      }catch(e){}
    }

    function closeModal(modal){
      try{
        untrapFocus(modal);
        modal.classList.remove('show');
        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
        lastFocus = null;
      }catch(e){}
    }

    // 外側タップで閉じる（既存モーダルに適用）
    function bindBackdropClose(id){
      try{
        const m = document.getElementById(id);
        if(!m) return;
        m.addEventListener('mousedown', function(e){ if(e.target === m) closeModal(m); });
      }catch(e){}
    }

    // 公開API
    App.modules.modal = { openModal, closeModal };

    // 互換: windowへ公開（既存コードが参照）
    window.openModal = openModal;
    window.closeModal = closeModal;

    // 既存モーダルへ適用
    document.addEventListener('DOMContentLoaded', function(){
      ['noticeModal','reasonModal','aiChoiceModal'].forEach(bindBackdropClose);
    });
  })(window.App);
</script>
<!-- END: js-core-modal -->

<!-- START: js-core-accessibility -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.accessibility) return;

    // 初期フォーカス（画面内の最初のインタラクティブ要素へ）
    function focusFirstInteractive(scope){
      try{
        const root = scope || document.querySelector('.screen.active');
        if(!root) return;
        const selectors = [ 'button.btnPrimary', 'input, select, textarea, button, a[href]', '.coverStartBtn' ];
        for (const sel of selectors){
          const el = root.querySelector(sel);
          if (el && typeof el.focus === 'function'){ el.focus(); return; }
        }
      }catch(e){}
    }

    // 見出しARIA付与（.card .h1 に role/aria-levelを付与）
    function initHeadingAria(){
      try{
        document.querySelectorAll('.card .h1').forEach(function(h){
          if(!h.getAttribute('role')) h.setAttribute('role','heading');
          if(!h.getAttribute('aria-level')) h.setAttribute('aria-level','1');
        });
      }catch(e){}
    }

    // 押下フィードバック（btnPrimary / videoCta / videoChip に pressed クラス）
    function initPressedFeedback(){
      try{
        const pressables = document.querySelectorAll('.btnPrimary, .videoCta, .videoChip');
        pressables.forEach(function(el){
          const add = function(){ el.classList.add('pressed'); };
          const remove = function(){ el.classList.remove('pressed'); };
          el.addEventListener('pointerdown', add);
          el.addEventListener('pointerup', remove);
          el.addEventListener('pointerleave', remove);
          el.addEventListener('mousedown', add);
          el.addEventListener('mouseup', remove);
          el.addEventListener('mouseleave', remove);
          el.addEventListener('touchstart', add, {passive:true});
          el.addEventListener('touchend', remove);
          el.addEventListener('touchcancel', remove);
        });
      }catch(e){}
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', function(){
      initHeadingAria();
      initPressedFeedback();
    });

    // 公開API
    App.modules.accessibility = { focusFirstInteractive, initHeadingAria };
    // 互換: windowへも露出（既存コード参照用）
    window.focusFirstInteractive = focusFirstInteractive;
  })(window.App);
</script>
<!-- END: js-core-accessibility -->

<!-- START: js-cta-theme -->
<script>
  (function(){
    // ボタン配色を「青テーマ」にする（.exp-cta スタイルを有効化）
    document.addEventListener('DOMContentLoaded', function(){
      document.body.classList.add('exp-cta');
    });
  })();
</script>
<!-- END: js-cta-theme -->

<!-- START: js-core-navigation -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.navigation) return;

    let _TITLE_NO = {};
    let _MAX_STEPS = 26;
    let _step = 0;
    let _historyStack = [];
    const afterHooks = [];

    function safe(fn){ try{ return fn && fn(); }catch(e){} }
    function screens(){ return Array.from(document.querySelectorAll('.screen')); }
    function titles(){ return screens().map(s=> s.dataset.title || ''); }
    function isCover(i){ const ss = screens(); return !!(ss[i] && ss[i].dataset.role === 'cover'); }
    function curTitle(i){ const t = titles(); return t[i] || ''; }

    function configure(cfg){
      _TITLE_NO = cfg && cfg.TITLE_NO ? cfg.TITLE_NO : _TITLE_NO;
      _MAX_STEPS = typeof cfg?.MAX_STEPS === 'number' ? cfg.MAX_STEPS : _MAX_STEPS;
    }
    function setAfterActivate(fn){ if (typeof fn === 'function') afterHooks.push(fn); }
    function addAfterActivate(fn){ if (typeof fn === 'function') afterHooks.push(fn); }

    function updateProgress(i){
      if (isCover(i)) return;
      if (App.modules && App.modules.progress && typeof App.modules.progress.onActive === 'function'){
        App.modules.progress.onActive(i, screens(), _MAX_STEPS, _TITLE_NO);
      }
    }

    function setActive(i){
      safe(()=> window.stopGuidedVoice && window.stopGuidedVoice());
      safe(()=> window.cancelVoiceInput && window.cancelVoiceInput());

      const ss = screens();
      ss.forEach((s, idx)=>{
        const isActive = idx === i;
        s.classList.toggle('active', isActive);
        s.classList.toggle('anim-in', isActive);
      });

      const onCover = isCover(i);
      document.body.classList.toggle('cover', onCover);

      // フッター音声ステータスは切替後に隠す
      try{
        const vs = document.getElementById('voiceStatus');
        if (vs) vs.style.display = 'none';
      }catch(e){}

      // 画面切替時に残留インジケータを一括クリーンアップ
      try{
        document.querySelectorAll('.voiceIndicator').forEach(ind=>{
          ind.style.display = 'none';
          ind.classList.remove('fadeShrink','ready','recording','recognizing');
        });
      }catch(e){}

      safe(()=> window.scrollToTop && window.scrollToTop());
      updateProgress(i);

      const title = curTitle(i);
      if (title === '最終見積のまとめ' || title === '最終見積もり'){
        safe(()=> window.updateFinalSummary && window.updateFinalSummary());
      }

      try{ afterHooks.forEach(fn => { try{ fn(title); }catch(e){} }); }catch(e){}

      safe(()=> App.modules && App.modules.accessibility && App.modules.accessibility.focusFirstInteractive());

      _step = i;
    }

    function pushHistory(idx){
      if (typeof idx!=='number') return;
      if (_historyStack.length && _historyStack[_historyStack.length-1]===idx) return;
      _historyStack.push(idx);
    }

    function next(){
      pushHistory(_step);
      const idx = Math.min(_step + 1, screens().length - 1);
      setActive(idx);
      safe(()=> App.modules && App.modules.estimate && App.modules.estimate.recalcAll());
    }

    function prev(){
      if (!_historyStack.length) return;
      const backIdx = _historyStack.pop();
      if (typeof backIdx === 'number'){
        setActive(backIdx);
        safe(()=> App.modules && App.modules.estimate && App.modules.estimate.recalcAll());
      }
    }

    function goToTitle(title){
      const idx = titles().indexOf(title);
      if (idx >= 0){
        pushHistory(_step);
        setActive(idx);
        safe(()=> App.modules && App.modules.estimate && App.modules.estimate.recalcAll());
      }
    }

    App.modules.navigation = {
      configure, setAfterActivate, addAfterActivate, setActive, next, prev, goToTitle,
      titles,
      get step(){ return _step; },
      get historyStack(){ return _historyStack; }
    };

    window.setActive = setActive;
    window.next = next;
    window.prev = prev;
    window.goToTitle = goToTitle;
    window.addAfterActivate = addAfterActivate;
  })(window.App);
</script>
<!-- END: js-core-navigation -->

<!-- START: js-core-dates -->
<script>
  (function(App){
    if (!App) App = (window.App = { modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.dates) return;

    // 和暦併記
    function formatYearWithEra(y){
      const year = Number(y);
      if (isNaN(year)) return `${y}年`;
      let era = '';
      if (year >= 2019) era = `令和${year - 2018}年`;
      else if (year >= 1989) era = `平成${year - 1988}年`;
      else if (year >= 1926) era = `昭和${year - 1925}年`;
      else era = '';
      return era ? `${year}年（${era}）` : `${year}年`;
    }

    // 汎用フォーカス（安全）
    function safeFocusById(id){
      try{
        const el = document.getElementById(id);
        if (el && el.offsetParent && typeof el.focus === 'function'){
          setTimeout(()=>{ try{ el.focus(); }catch(e){} }, 0);
        }
      }catch(e){}
    }

    function fillYearOptions(sel, startY, endY){
      if (!sel || sel.options.length > 1) return;
      for(let y=startY; y<=endY; y++){
        const o=document.createElement('option'); o.value=String(y); o.textContent=formatYearWithEra(y); sel.appendChild(o);
      }
    }
    function fillMonthOptions(sel, max=12){
      if (!sel) return;
      sel.innerHTML = '<option value="">月</option>';
      for(let m=1; m<=max; m++){
        const o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.textContent=`${m}月`; sel.appendChild(o);
      }
    }
    function fillDayOptions(sel){
      if (!sel || sel.options.length > 1) return;
      for(let d=1; d<=31; d++){
        const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=`${d}日`; sel.appendChild(o);
      }
    }

    // 免許証の有効期限
    function populateLicenseDateSelects(){
      try{
        const ySel = document.getElementById('licenseYear');
        const mSel = document.getElementById('licenseMonth');
        const dSel = document.getElementById('licenseDay');
        if (!ySel || !mSel || !dSel) return;
        const now=new Date(), startY=now.getFullYear(), endY=startY+12;
        fillYearOptions(ySel, startY, endY);
        if (mSel.options.length <= 1) fillMonthOptions(mSel, 12);
        fillDayOptions(dSel);

        // 年を選んだら 月ボタン へ
        ySel.addEventListener('change', function(){ safeFocusById('licenseMonthDisplay'); });
      }catch(e){}
    }
    function validateLicenseDate(){
      try{
        const y=document.getElementById('licenseYear')?.value || '';
        const m=document.getElementById('licenseMonth')?.value || '';
        const d=document.getElementById('licenseDay')?.value || '';
        if(!y||!m||!d){
          if (typeof openNotice === 'function') openNotice('有効期限を「年・月・日」の3つから選んでください');
          return false;
        }
        return true;
      }catch(e){
        if (typeof openNotice === 'function') openNotice('有効期限の選択でエラーが発生しました。再度お試しください。');
        return false;
      }
    }

    // 生年月日（お客様）
    function populateDobSelects(){
      try{
        const ySel = document.getElementById('dobYear');
        const mSel = document.getElementById('dobMonth');
        const dSel = document.getElementById('dobDay');
        if (!ySel || !mSel || !dSel) return;
        const now=new Date(), endY=now.getFullYear(), startY=endY-100;
        fillYearOptions(ySel, startY, endY);
        if (mSel.options.length <= 1) fillMonthOptions(mSel, 12);
        fillDayOptions(dSel);

        // 年 → 月、 日 → 勤務先（お客様 = company）
        ySel.addEventListener('change', function(){ safeFocusById('dobMonthDisplay'); });
        dSel.addEventListener('change', function(){ safeFocusById('company'); });
      }catch(e){}
    }
    function validateDobSelect(){
      try{
        const y=document.getElementById('dobYear')?.value || '';
        const m=document.getElementById('dobMonth')?.value || '';
        const d=document.getElementById('dobDay')?.value || '';
        if(!y||!m||!d){
          if (typeof openNotice === 'function') openNotice('生年月日を「年・月・日」の3つから選んでください');
          return false;
        }
        return true;
      }catch(e){
        if (typeof openNotice === 'function') openNotice('生年月日の選択でエラーが発生しました。再度お試しください。');
        return false;
      }
    }

    // 生年月日（主に運転する方）
    function populateMdDobSelects(){
      try{
        const ySel = document.getElementById('md_dobYear');
        const mSel = document.getElementById('md_dobMonth');
        const dSel = document.getElementById('md_dobDay');
        if (!ySel || !mSel || !dSel) return;
        const now=new Date(), endY=now.getFullYear(), startY=endY-100;
        fillYearOptions(ySel, startY, endY);
        if (mSel.options.length <= 1) fillMonthOptions(mSel, 12);
        fillDayOptions(dSel);

        // 年 → 月、 日 → 勤務先（主運転者 = md_company）
        ySel.addEventListener('change', function(){ safeFocusById('md_dobMonthDisplay'); });
        dSel.addEventListener('change', function(){ safeFocusById('md_company'); });
      }catch(e){}
    }

    // 初度登録年月（未来月は不可／当年は当月まで）
    function populateFirstRegSelects(){
      try{
        const ySel = document.getElementById('firstRegYear');
        const mSel = document.getElementById('firstRegMonth');
        if (!ySel || !mSel) return;
        const now=new Date(), endY=now.getFullYear(), startY=endY-50;
        fillYearOptions(ySel, startY, endY);
        const selectedY = Number(ySel.value || endY);
        const maxMonth  = (selectedY === now.getFullYear()) ? (now.getMonth()+1) : 12;
        fillMonthOptions(mSel, maxMonth);
        // 年変更で再計算＋月ボタンへフォーカス
        ySel.addEventListener('change', function(){
          try{
            const sy = Number(ySel.value || endY);
            const mm = (sy === now.getFullYear()) ? (now.getMonth()+1) : 12;
            fillMonthOptions(mSel, mm);
          }catch(e){}
          safeFocusById('firstRegMonthDisplay');
        });
      }catch(e){}
    }

    // 公開API
    App.modules.dates = {
      formatYearWithEra,
      populateLicenseDateSelects, validateLicenseDate,
      populateDobSelects,         validateDobSelect,
      populateMdDobSelects,
      populateFirstRegSelects
    };

    // 互換（window.* を従来名で露出）
    window.formatYearWithEra = formatYearWithEra;
    window.populateDateSelectsSafe     = populateLicenseDateSelects;
    window.validateDateSelect          = validateLicenseDate;
    window.populateDobSelectsSafe      = populateDobSelects;
    window.populateMdDobSelectsSafe    = populateMdDobSelects;
    window.populateFirstRegSelectsSafe = populateFirstRegSelects;
  })(window.App);
</script>
<!-- END: js-core-dates -->

<!-- START: js-monthday-picker -->
<script>
  (function(App){
    App = App || (window.App={ modules:{}, bus:{ on(){}, emit(){} }});

    // 現在の対象グループとフェーズ
    let phase = 'month'; // 'month' -> 'day'
    let group = 'license'; // 'license' | 'dob' | 'md_dob' | 'firstReg'
    let lastSelectedMonth = null;

    const groups = {
      license: { yearId:'licenseYear', monthId:'licenseMonth', dayId:'licenseDay', monthBtn:'licenseMonthDisplay', dayBtn:'licenseDayDisplay' },
      dob:     { yearId:'dobYear',     monthId:'dobMonth',     dayId:'dobDay',     monthBtn:'dobMonthDisplay',     dayBtn:'dobDayDisplay' },
      md_dob:  { yearId:'md_dobYear',  monthId:'md_dobMonth',  dayId:'md_dobDay',  monthBtn:'md_dobMonthDisplay',  dayBtn:'md_dobDayDisplay' },
      firstReg:{ yearId:'firstRegYear',monthId:'firstRegMonth',                     monthBtn:'firstRegMonthDisplay' }
    };

    function getEl(id){ return document.getElementById(id); }
    function openPicker(){
      const m = getEl('monthDayPickerModal');
      if (!m){ alert('ピッカーのモーダルが見つかりません'); return; }
      if (typeof openModal === 'function') openModal(m); else m.classList.add('show');
      renderMonthGrid();
      const sub = getEl('mdPickerSub');
      if (sub) sub.textContent = (group === 'firstReg')
        ? '「月」を選んでください。選択後に元の画面へ戻ります。'
        : 'まず「月」を選んでください。選択後に「日」へ切り替わります。';
    }
    function closePicker(){
      const m = getEl('monthDayPickerModal');
      if (!m) return;
      if (typeof closeModal === 'function') closeModal(m); else m.classList.remove('show');
      phase = 'month'; group = 'license'; lastSelectedMonth = null;
    }

    function daysInMonth(year, month){
      const y = Number(year||0), m = Number(month||0);
      if (!y || !m) return 31;
      return new Date(y, m, 0).getDate();
    }

    function renderMonthGrid(){
      phase = 'month';
      const cfg = groups[group];
      const grid = getEl('mdPickerGrid'); if (!grid || !cfg) return;
      grid.innerHTML = '';
      const months = Array.from({length:12}, (_,i)=> i+1);
      months.forEach((mm)=>{
        const btn = document.createElement('button');
        const curVal = String(getEl(cfg.monthId)?.value||'');
        btn.className = 'mdCell' + (curVal === String(mm).padStart(2,'0') ? 'selected':'');
        btn.type='button';
        btn.setAttribute('role','gridcell');
        btn.setAttribute('aria-selected', btn.classList.contains('selected') ? 'true' : 'false');
        btn.textContent = mm + '月';
        btn.addEventListener('click', function(){
          selectMonth(mm, btn);
        });
        grid.appendChild(btn);
      });
    }

    function renderDayGrid(){
      phase = 'day';
      const cfg = groups[group];
      const grid = getEl('mdPickerGrid'); if (!grid || !cfg) return;
      grid.innerHTML = '';
      const yVal = getEl(cfg.yearId)?.value || '';
      const mVal = lastSelectedMonth || getEl(cfg.monthId)?.value || '';
      const maxDay = daysInMonth(yVal, mVal);

      const makeCell = function(d){
        const btn = document.createElement('button');
        const curVal = String(getEl(cfg.dayId)?.value||'');
        btn.className = 'mdCell' + (curVal === String(d).padStart(2,'0') ? 'selected':'');
        btn.type='button';
        btn.setAttribute('role','gridcell');
        btn.setAttribute('aria-selected', btn.classList.contains('selected') ? 'true' : 'false');
        btn.textContent = d + '日';
        btn.addEventListener('click', function(){ selectDay(d, btn); });
        return btn;
      };

      for (let d=1; d<=Math.min(30, maxDay); d++){ grid.appendChild(makeCell(d)); }
      if (maxDay >= 31){ grid.appendChild(makeCell(31)); }

      const sub = getEl('mdPickerSub');
      if (sub) sub.textContent = '「日」を選んでください。選択後に元の画面へ戻ります。';
    }

    // 選択後にチェック表示 → 0.5秒後に自動遷移
    function selectMonth(m, btn){
      const cfg = groups[group];
      if (!cfg) return;
      const val = String(m).padStart(2,'0');

      try{
        btn && btn.classList.add('selected');
        btn && btn.setAttribute('aria-selected','true');
      }catch(e){}

      const sel = getEl(cfg.monthId);
      if (sel){ sel.value = val; lastSelectedMonth = val; sel.dispatchEvent(new Event('change')); }

      const disp = getEl(cfg.monthBtn);
      if (disp) disp.textContent = m + '月';

      if (group === 'firstReg'){
        setTimeout(closePicker, 500);
      }else{
        setTimeout(renderDayGrid, 500);
      }
    }

    function selectDay(d, btn){
      const cfg = groups[group];
      if (!cfg) return;
      const val = String(d).padStart(2,'0');

      try{
        btn && btn.classList.add('selected');
        btn && btn.setAttribute('aria-selected','true');
      }catch(e){}

      const sel = getEl(cfg.dayId);
      if (sel){ sel.value = val; sel.dispatchEvent(new Event('change')); }

      const disp = getEl(cfg.dayBtn);
      if (disp) disp.textContent = d + '日';

      // 0.5秒後に閉じて元画面へ
      setTimeout(()=>{
        closePicker();
        // 日選択完了後：勤務先へ自動フォーカス（dob→company / md_dob→md_company）
        if (group === 'dob'){
          setTimeout(()=>{ try{ document.getElementById('company')?.focus(); }catch(e){} }, 0);
        }else if (group === 'md_dob'){
          setTimeout(()=>{ try{ document.getElementById('md_company')?.focus(); }catch(e){} }, 0);
        }
      }, 500);
    }

    // 公開関数（各対象）
    function openMonthDayPicker(targetGroup, targetPhase){
      group = targetGroup || 'license';
      const cfg = groups[group];
      if (cfg){
        if (!getEl(cfg.monthId)) return openPicker();
        if (getEl(cfg.monthId) && getEl(cfg.monthId).options.length <= 1){
          getEl(cfg.monthId).innerHTML = '<option value="">月</option>' + Array.from({length:12},(_,i)=> `<option value="${String(i+1).padStart(2,'0')}">${i+1}月</option>`).join('');
        }
        if (cfg.dayId && getEl(cfg.dayId) && getEl(cfg.dayId).options.length <= 1){
          getEl(cfg.dayId).innerHTML = '<option value="">日</option>' + Array.from({length:31},(_,i)=> `<option value="${String(i+1).padStart(2,'0')}">${i+1}日</option>`).join('');
        }
      }
      openPicker();
      if (targetPhase === 'day'){
        const mv = cfg && (getEl(cfg.monthId)?.value || '');
        if (!mv && group !== 'firstReg'){ renderMonthGrid(); return; }
        if (group === 'firstReg'){ return; }
        renderDayGrid();
      }
    }

    // ラッパー（既存onclick互換）
    window.openMonthDayPickerForLicense = function(target){ openMonthDayPicker('license', target); };
    window.openMonthDayPickerForDob     = function(target){ openMonthDayPicker('dob', target); };
    window.openMonthDayPickerForMdDob   = function(target){ openMonthDayPicker('md_dob', target); };
    window.openMonthPickerForFirstReg   = function(){ openMonthDayPicker('firstReg', 'month'); };

    // 初期表示のボタンラベルを既存select値に同期（空なら「月」「日」）
    document.addEventListener('DOMContentLoaded', function(){
      try{
        const sync = (cfg)=>{
          const mSel = getEl(cfg.monthId), dSel = cfg.dayId ? getEl(cfg.dayId) : null;
          const mBtn = getEl(cfg.monthBtn), dBtn = cfg.dayBtn ? getEl(cfg.dayBtn) : null;
          if (mBtn) mBtn.textContent = (mSel && mSel.value) ? Number(mSel.value) + '月' : '月';
          if (dBtn) dBtn.textContent = (dSel && dSel.value) ? Number(dSel.value) + '日' : '日';
        };
        sync(groups.license);
        sync(groups.dob);
        sync(groups.md_dob);
        sync(groups.firstReg);
      }catch(e){}
    });
  })(window.App);
</script>
<!-- END: js-monthday-picker -->

<!-- START: js-core -->
<script>
  // 画面番号マップ（分割後もここで維持）
  const TITLE_NO = {
    '手続き開始':1, 'ログイン':2,
    'お車の情報':3, '車検証の情報':4,
    '免許証の情報を確認する':5, '免許証の色':6,
    'お客様情報の確認':7, 'お客様情報の編集':8,
    '主に運転する方（記名被保険者）':9, '主に運転する方の編集':10,
    '運転者の範囲と年齢条件':11, '運転者範囲・年齢条件の編集':12,
    '使用目的・走行距離':13,
    '現在の内容を確認':14, '現在の補償内容と保険料の確認':14,
    '現在と同じ補償内容で更新した場合の保険料':15, '同じ補償内容で更新した場合の保険料':15,
    '更新方法の選択':16, '更新方法を選ぶ':16,
    '別のプランから選ぶ':17,
    '人身傷害の金額を選ぶ':18, '人身傷害':18,
    '車両保険の金額を選ぶ':19, '車両保険':19,
    '特約の付け外し':20, '特約':20,
    '最終見積のまとめ':21, '最終見積もり':21,
    '重要なご説明':22, '大切なポイント':22,
    '連絡方法を選ぶ':23,
    '受け取り方法を選ぶ':24,
    '同意と申込':25, '同意して申込':25, '内容に同意して申し込む':25,
    '申込完了':26, '完了':26
  };
  const MAX_STEPS = 26;

  try { if ('scrollRestoration' in history) history.scrollRestoration = 'manual'; } catch(e){}

  // スクロール補助
  function scrollToTop(){
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    try { window.scrollTo({ top: 0, left: 0, behavior: prefersReduced ? 'auto' : 'smooth' }); }
    catch(e){ window.scrollTo(0, 0); }
  }

  // 申込完了画面の表示同期（選択内容に応じて完了行を表示）
  function updateDoneScreen(){
    try{
      const st = (window.choiceState || {});
      const sendImpPdf = !!window.flagSendPdf;
      const elPdf         = document.getElementById('donePdf');
      const elImpPdf      = document.getElementById('doneImpPdf');
      const elPostal      = document.getElementById('donePostal');
      const elTermsPostal = document.getElementById('doneTermsPostal');

      if (elPdf)         elPdf.style.display         = st['pdf_yes']      ? '' : 'none';
      if (elImpPdf)      elImpPdf.style.display      = sendImpPdf         ? '' : 'none';
      if (elPostal)      elPostal.style.display      = st['cert_paper']   ? '' : 'none';
      if (elTermsPostal) elTermsPostal.style.display = st['terms_paper']  ? '' : 'none';

      // 既定では利用しない補助行（必要時のみ活用）
      // const elPostalUnder = document.getElementById('donePostalUnder');
      // if (elPostalUnder) elPostalUnder.style.display = st['cert_paper'] ? '' : 'none';
    }catch(e){}
  }

  // ナビゲーション（モジュール）への委譲設定
  (function(){
    function afterActivate(title){
      try{
        if (title==='免許証の色')                         App.modules?.dates?.populateLicenseDateSelects();
        if (title==='お客様情報の編集')                   App.modules?.dates?.populateDobSelects();
        if (title==='主に運転する方の編集')               App.modules?.dates?.populateMdDobSelects();
        if (title==='車検証の情報')                       App.modules?.dates?.populateFirstRegSelects();

        // 申込完了画面に遷移したら、選択内容にもとづき完了メッセージを連動表示
        if (title==='申込完了' || title==='完了'){
          updateDoneScreen();
        }
      }catch(e){}
    }
    try{
      App.modules?.navigation?.configure({ TITLE_NO, MAX_STEPS });
      App.modules?.navigation?.setAfterActivate(afterActivate);
    }catch(e){}
  })();

  // 初期化
  (function(){
    document.addEventListener('DOMContentLoaded', function(){
      try{
        App.modules?.dates?.populateLicenseDateSelects();
        App.modules?.dates?.populateDobSelects();
        App.modules?.dates?.populateMdDobSelects();
        App.modules?.dates?.populateFirstRegSelects();
      }catch(e){}

      const l=document.getElementById('lblLarge');
      if(l) l.textContent = document.body.classList.contains('large') ? '文字縮小' : '文字拡大';
      try{ if (typeof setGuidedBtn === 'function') setGuidedBtn(); }catch(e){}

      try{
        const ss = Array.from(document.querySelectorAll('.screen'));
        const coverIdx = ss.findIndex(s=> s.dataset.role==='cover');
        if(coverIdx>=0){
          App.modules?.navigation?.setActive(coverIdx);
          setTimeout(()=>{ const btn=document.querySelector('.coverStartBtn'); if(btn) btn.focus(); },0);
        }else{
          App.modules?.navigation?.setActive(0);
        }
      }catch(e){ App.modules?.navigation?.setActive(0); }

      try{
        App.modules?.storage?.offerResume && App.modules.storage.offerResume();
      }catch(e){}
    });
  })();

  // デモ開始（互換）
  function startDemo(){
    try{
      const ss = Array.from(document.querySelectorAll('.screen'));
      const coverIdx = ss.findIndex(s=> s.dataset.role==='cover');
      const t = ss.map(s=> s.dataset.title || '');
      const firstIdx = t.indexOf('手続き開始');
      if (firstIdx>=0){
        if (coverIdx>=0){ App.modules?.navigation?.goToTitle && (window.historyStack = App.modules.navigation.historyStack, window.historyStack.push(coverIdx)); }
        App.modules?.navigation?.setActive(firstIdx);
      }
    }catch(e){ App.modules?.navigation?.setActive(0); }
  }
  window.startDemo = startDemo;

  // storage等から参照されるユーティリティを露出（互換）
  window.titles = function(){ try{ return App.modules?.navigation?.titles() || []; }catch(e){ return []; } };
  Object.defineProperty(window, 'step', { get(){ try{ return App.modules?.navigation?.step || 0; }catch(e){ return 0; } } });
  window.historyStack = (function(){ try{ return App.modules?.navigation?.historyStack || []; }catch(e){ return []; } })();
</script>
<!-- END: js-core -->

<!-- START: js-final-summary-sync -->
<script>
  (function(){
    // ラベル生成
    function mapBodilyLabel(val){
      if (val === 'unlimited') return '無制限';
      if (val === '10000')     return '1億円';
      if (val === '8000')      return '8,000万円';
      if (val === '5000')      return '5,000万円';
      if (val === '3000')      return '3,000万円';
      return '';
    }
    function normalizeVehicleText(amount, deduct){
      var dMText = (deduct === 0) ? '0万円' : (deduct === 100000 ? '10万円' : '5万円');
      if (amount === 0) return 'なし';
      return String(amount) + '万円・免責' + dMText;
    }

    // diff行へ現在選択を確実に反映（recalcAllと整形も含める統一タスク）
    function syncFinalSummaryAll(){
      try{
        // まず再計算（js-core-estimate）
        if (window.App && App.modules && App.modules.estimate && typeof App.modules.estimate.recalcAll === 'function'){
          App.modules.estimate.recalcAll();
        }
      }catch(e){}

      try{
        // 直接 diff 行を上書き（防御的）
        var bEl = document.getElementById('diffBodily');
        var vEl = document.getElementById('diffVehicle');
        if (bEl){
          var curB = '3,000万円';
          var bodilySel = document.getElementById('bodilyAmount');
          var newB = (bodilySel ? mapBodilyLabel(bodilySel.value || '') : '');
          bEl.textContent = (newB && newB !== curB)
            ? ('人身傷害：' + curB + ' ➡ ' + newB)
            : ('人身傷害：' + curB);
        }
        if (vEl){
          var vehSel = document.getElementById('vehicleAmount');
          var dedSel = document.getElementById('deduct');
          var curV = '200万円・免責5万円';
          var newV = (vehSel && dedSel) ? normalizeVehicleText(Number(vehSel.value || 200), Number(dedSel.value || 50000)) : '';
          vEl.textContent = (newV && newV !== curV)
            ? ('車両保険：' + curV + ' ➡ ' + newV)
            : ('車両保険：' + curV);
        }
      }catch(e){}

      try{
        // 表記整形（「➡」「免責」表記など）
        if (typeof window.updateFinalSummary === 'function') window.updateFinalSummary();
      }catch(e){}
    }

    // 最終見積アクティブ判定
    function isFinalSummaryActive(){
      try{
        var ss = document.querySelectorAll('.screen');
        for (var i=0; i<ss.length; i++){
          if (ss[i].classList.contains('active')){
            var t = ss[i].dataset ? (ss[i].dataset.title || '') : '';
            return (t === '最終見積のまとめ' || t === '最終見積もり');
          }
        }
      }catch(e){}
      return false;
    }

    // 1) ナビゲーションの afterActivate フックで「最終見積」直後に同期し、かつ「申込完了」でも完了表示を同期
    (function installAfterActivateHook(){
      try{
        if (window.App && App.modules && App.modules.navigation && typeof App.modules.navigation.setAfterActivate === 'function'){
          var prevHook = null;
          App.modules.navigation.setAfterActivate(function(title){
            // 既存フックがあれば実行
            try{ typeof prevHook === 'function' && prevHook(title); }catch(e){}
            // 最終見積の同期
            if (title === '最終見積のまとめ' || title === '最終見積もり'){
              setTimeout(syncFinalSummaryAll, 0);
            }
            // 申込完了の完了表示同期
            if (title === '申込完了' || title === '完了'){
              try{ if (typeof window.updateDoneScreen === 'function') window.updateDoneScreen(); }catch(e){}
            }
          });
        }
      }catch(e){}
    })();

    // 2) 最終見積画面にいる間は、「人身傷害」「車両保険/免責」変更時に即時同期
    function bindLiveSync(){
      try{
        var bodilySel = document.getElementById('bodilyAmount');
        var vehSel    = document.getElementById('vehicleAmount');
        var dedSel    = document.getElementById('deduct');
        var handler = function(){
          if (!isFinalSummaryActive()) return;
          syncFinalSummaryAll();
        };
        if (bodilySel) bodilySel.addEventListener('change', handler);
        if (vehSel)    vehSel.addEventListener('change', handler);
        if (dedSel)    dedSel.addEventListener('change', handler);
      }catch(e){}
    }
    document.addEventListener('DOMContentLoaded', bindLiveSync);

    // 3) 万一、最終見積画面に直接到達した場合（戻る等）にも初回同期を担保
    document.addEventListener('DOMContentLoaded', function(){
      setTimeout(function(){ if (isFinalSummaryActive()) syncFinalSummaryAll(); }, 0);
    });
  })();
</script>
<!-- END: js-final-summary-sync -->

<!-- START: js-actions-helper -->
<script>
  (function(){
    // 「金額が変わる主な理由」モーダル
    if (typeof window.openReasonDetail !== 'function'){
      window.openReasonDetail = function(){
        try{
          var m = document.getElementById('reasonModal');
          if (m && typeof openModal === 'function') openModal(m);
          else if (m) m.classList.add('show');
        }catch(e){}
      };
    }

    // 同意して申込 → 完了へ（デモ動線）
    if (typeof window.onAgreeSubmit !== 'function'){
      window.onAgreeSubmit = function(){
        try{
          var g1=document.getElementById('agree1'), g2=document.getElementById('agree2');
          if(!g1 || !g2 || !g1.checked || !g2.checked){
            if (typeof openNotice === 'function') openNotice('同意のチェックを入れてください。');
            return;
          }
          try{ if (typeof showLoading === 'function') showLoading(); }catch(e){}
          setTimeout(function(){
            try{ if (typeof hideLoading === 'function') hideLoading(); }catch(e){}
            try{ if (typeof goToTitle === 'function') goToTitle('申込完了'); }catch(e){}
          }, 600);
        }catch(e){}
      };
    }

    // PDF送付（デモ）
    if (typeof window.sendPdf !== 'function'){
      window.sendPdf = function(){
        try{ if (typeof openNotice === 'function') openNotice('本番ではPDF送付確認画面に推移します。'); }catch(e){}
      };
    }
  })();
</script>
<!-- END: js-actions-helper -->

<!-- START: js-core-input-assist -->
<script>
  (function(App){
    // 二重定義防止
    App = App || (window.App={ modules:{}, bus:{ on(){}, emit(){} }});
    if (App.modules && App.modules.inputAssist) return;

    // 内部状態
    var otpIds = ['otp1', 'otp2', 'otp3', 'otp4'];

    // 数字1桁に正規化（全角→半角）
    function normalizeOneDigit(v){
      if (!v) return '';
      var s = String(v).replace(/[^0-9０-９]/g,'').slice(-1);
      return s.replace(/[０-９]/g, function(d){ return String.fromCharCode(d.charCodeAt(0) - 0xFEE0); });
    }

    // 汎用フォーカス
    function safeFocus(id){
      try{
        var el = document.getElementById(id);
        if (el && el.offsetParent && typeof el.focus === 'function'){
          setTimeout(function(){ try{ el.focus(); }catch(e){} }, 0);
        }
      }catch(e){}
    }

    // 次のOTPへ自動フォーカス
    function otpAutoNext(idx){
      try{
        var id = 'otp' + idx;
        var cur = document.getElementById(id);
        if (!cur) return;
        cur.value = normalizeOneDigit(cur.value);

        // 入力済なら次へ
        if (cur.value && idx < 4){
          var next = document.getElementById('otp' + (idx + 1));
          if (next && typeof next.focus === 'function') next.focus();
        }

        // 4桁揃ったらフォーカスを外す
        if (idx === 4){
          var filled = otpIds.every(function(i){ var el = document.getElementById(i); return el && el.value && el.value.length === 1; });
          if (filled && typeof cur.blur === 'function') cur.blur();
        }
      }catch(e){}
    }

    // ログインID存在チェックとOTP4桁チェック
    function validateOtpLogin(){
      try{
        var idEl = document.getElementById('loginId');
        var id = (idEl && idEl.value || '').trim();
        if(!id){
          if (typeof openNotice === 'function') openNotice('電話番号またはメールアドレスを入力してください');
          return false;
        }
        var filled = otpIds.every(function(i){ var el = document.getElementById(i); return el && (el.value || '').length === 1; });
        if(!filled){
          if (typeof openNotice === 'function') openNotice('認証コード4桁を入力してください');
          return false;
        }
        return true;
      }catch(e){
        if (typeof openNotice === 'function') openNotice('認証の確認でエラーが発生しました。再度お試しください。');
        return false;
      }
    }

    // ============ 手入力の完了で次フィールドに移動（Zip→Addr→Phone→DobYear） ============
    function digitsOnly(str){
      return String(str || '').replace(/[^\d０-９]/g,'').replace(/[０-９]/g, function(d){ return String.fromCharCode(d.charCodeAt(0) - 0xFEE0); });
    }
    function bindManualFocusChain(){
      try{
        // 1) お客様側
        var zip      = document.getElementById('zip');
        var addr     = document.getElementById('addr');
        var phone    = document.getElementById('cust_phone');
        var dobYear  = document.getElementById('dobYear');

        // 2) 主運転者側
        var md_zip     = document.getElementById('md_zip');
        var md_addr    = document.getElementById('md_addr');
        var md_phone   = document.getElementById('md_phone');
        var md_dobYear = document.getElementById('md_dobYear');

        // 共通バインダ：Enter で移動、blur でも値があれば移動
        function chainOnEnterAndBlur(srcEl, nextId){
          if (!srcEl || !nextId) return;
          srcEl.addEventListener('keydown', function(e){
            if (e.key === 'Enter'){
              e.preventDefault();
              // 値があるときだけ遷移。空なら遷移しない（誤移動防止）
              var val = (srcEl.value || '').trim();
              if (val) safeFocus(nextId);
            }
          });
          srcEl.addEventListener('blur', function(){
            try{
              var val = (srcEl.value || '').trim();
              if (val) safeFocus(nextId);
            }catch(e){}
          });
        }

        // 郵便番号：7桁入力時点でも即時遷移（input監視）
        function chainZipInput(zipEl, nextId){
          if (!zipEl || !nextId) return;
          zipEl.addEventListener('input', function(){
            try{
              var d = digitsOnly(zipEl.value);
              if (d.length >= 7){
                safeFocus(nextId);
              }
            }catch(e){}
          });
        }

        // お客様側のチェーン
        chainZipInput(zip, 'addr');
        chainOnEnterAndBlur(zip, 'addr');
        chainOnEnterAndBlur(addr, 'cust_phone');
        chainOnEnterAndBlur(phone, 'dobYear');

        // 主運転者側のチェーン
        chainZipInput(md_zip, 'md_addr');
        chainOnEnterAndBlur(md_zip, 'md_addr');
        chainOnEnterAndBlur(md_addr, 'md_phone');
        chainOnEnterAndBlur(md_phone, 'md_dobYear');
      }catch(e){}
    }

    // 使い勝手向上（Enterキー送信、初期バインド）
    function bindOtpUX(){
      try{
        // 1) 入力イベントで常に1桁に正規化（既存HTMLのoninputと併用でもOK）
        otpIds.forEach(function(i, idx){
          var el = document.getElementById(i);
          if (!el) return;
          el.addEventListener('input', function(){ otpAutoNext(idx+1); });
          el.setAttribute('inputmode', 'numeric');
          el.setAttribute('aria-label', '認証コード ' + (idx+1) + '桁目');
        });

        // 2) 最後の桁でEnter押下時に送信ボタンをクリック
        var last = document.getElementById('otp4');
        if (last){
          last.addEventListener('keydown', function(e){
            if (e.key === 'Enter'){
              e.preventDefault();
              // 画面内の「認証して次へ」ボタンを探してクリック
              var btns = Array.from(document.querySelectorAll('button.btnPrimary'));
              var submit = btns.find(function(b){ return /認証して次へ/.test((b.textContent || '').trim()); });
              if (submit) submit.click();
            }
          });
        }
      }catch(e){}
    }

    // DOM準備時にUXバインド＋手入力チェーンをセット
    document.addEventListener('DOMContentLoaded', function(){
      bindOtpUX();
      bindManualFocusChain();
    });

    // モジュール公開 + 互換グローバル
    App.modules.inputAssist = { otpAutoNext, validateOtpLogin };
    window.otpAutoNext = otpAutoNext;
    window.validateOtpLogin = validateOtpLogin;

  })(window.App);
</script>
<!-- END: js-core-input-assist -->

<!-- START: js-core-ui-helpers -->
<script>
  (function(){
    // Notice（お知らせモーダル）
    if (typeof window.openNotice !== 'function'){
      window.openNotice = function(msg){
        try{
          var b = document.getElementById('noticeBody');
          if (b) b.textContent = String(msg || 'お知らせ');
          var m = document.getElementById('noticeModal');
          if (m && typeof openModal === 'function') {
            openModal(m);
          } else if (m) {
            m.classList.add('show');
            // フォーカス配慮がない環境でも最低限表示
          } else {
            alert(msg || 'お知らせ');
          }
        }catch(e){
          try{ alert(msg || 'お知らせ'); }catch(_){}
        }
      };
    }
    if (typeof window.closeNotice !== 'function'){
      window.closeNotice = function(){
        try{
          var m = document.getElementById('noticeModal');
          if (m && typeof closeModal === 'function') closeModal(m);
          else if (m) m.classList.remove('show');
        }catch(e){}
      };
    }

    // Toast（簡易通知）
    if (typeof window.showToast !== 'function'){
      window.showToast = function(message){
        try{
          var t = document.getElementById('toast');
          if (!t) { alert(message || ''); return; }
          t.textContent = '';
          void t.offsetHeight; // 連続表示のためリフロー
          t.textContent = String(message || '');
          t.style.display = 'block';
          clearTimeout(showToast._tid);
          showToast._tid = setTimeout(function(){ t.style.display = 'none'; }, 2250);
        }catch(e){
          try{ alert(message || ''); }catch(_){}
        }
      };
    }

    // 車検証入力画面の表示切替（OCR/手入力）
    function safeDisplay(id, show){
      var el = document.getElementById(id);
      if (el) el.style.display = show ? 'block' : 'none';
    }
    if (typeof window.showManual !== 'function'){
      window.showManual = function(){
        safeDisplay('ocrShoot', false);
        safeDisplay('ocrGuide', false);
        safeDisplay('ocrResult', false);
        safeDisplay('manualForm', true);
      };
    }
    if (typeof window.showOCRGuide !== 'function'){
      window.showOCRGuide = function(){
        safeDisplay('ocrShoot', true);
        safeDisplay('ocrGuide', true);
        safeDisplay('ocrResult', false);
        safeDisplay('manualForm', false);
      };
    }
    if (typeof window.startShooting !== 'function'){
      window.startShooting = function(){
        try{ if (typeof showLoading === 'function') showLoading(); }catch(e){}
        try{ if (typeof openNotice === 'function') openNotice('本番ではカメラ撮影に遷移します（デモは結果へ）'); }catch(e){}
        setTimeout(function(){
          try{ if (typeof hideLoading === 'function') hideLoading(); }catch(e){}
          try{ if (typeof showOCRResult === 'function') showOCRResult(); }catch(e){}
        }, 800);
      };
    }
    if (typeof window.showOCRResult !== 'function'){
      window.showOCRResult = function(){
        safeDisplay('ocrShoot', false);
        safeDisplay('ocrGuide', false);
        safeDisplay('ocrResult', true);
        safeDisplay('manualForm', false);
      };
    }
  })();
</script>
<!-- END: js-core-ui-helpers -->

<!-- START: js-help-security-handlers -->
<script>
  (function(){
    // 偽サイトチェック（既存のまま）
    if (typeof window.openSecurityCheck !== 'function'){
      window.openSecurityCheck = function(){
        try{
          var m = document.getElementById('securityCheckModal');
          if (m && typeof openModal === 'function') openModal(m);
          else if (m) m.classList.add('show');
          else if (typeof openNotice === 'function') openNotice('偽サイトの見分け方：送信元・URL・個人情報要求の確認をしてください。');
        }catch(e){}
      };
    }

    // 現在アクティブ画面のタイトル
    function getActiveTitle(){
      try{
        var s = document.querySelector('.screen.active');
        return s ? (s.dataset.title || '') : '';
      }catch(e){ return ''; }
    }

    // 画面タイトル → ヘルプ本文（短文・2〜4行）
    function helpTextByTitle(title){
      var fallback = '<ul class="list"><li>本番ではこの画面の使い方についてポイントを解説する内容を表示します</li></ul>';
      switch (title) {
        case '手続き開始':
          return '<ul class="list">' +
                   '<li>公式サイトと送信元ドメインをご案内します。偽サイトの見分け方はリンクから確認できます</li>' +
                   '<li>使い方の動画・音声解説・文字拡大・AI相談が利用できます</li>' +
                   '<li>準備物（免許証・車検証・メールアドレス）をご用意ください</li>' +
                 '</ul>';
        case 'ログイン':
          return '<ul class="list">' +
                   '<li>電話番号またはメールアドレスを入力して認証コード（4桁）を受け取ります</li>' +
                   '<li>届いた認証コードを入力して「認証して次へ」を押してください</li>' +
                 '</ul>';
        case 'お車の情報':
          return '<ul class="list">' +
                   '<li>車名・型式・ナンバーの登録内容を確認します</li>' +
                   '<li>変更がなければ「変更なし」、変更する場合は「車検証の情報」へ進んでください</li>' +
                 '</ul>';
        case '車検証の情報':
          return '<ul class="list">' +
                   '<li>カメラ読み取りまたは手入力（選択式・音声入力）を選べます</li>' +
                   '<li>初度登録は年・月を選択します。当年は今月まで、未来月は選べません</li>' +
                 '</ul>';
        case '免許証の情報を確認する':
          return '<ul class="list">' +
                   '<li>免許証の色と有効期限を確認します</li>' +
                   '<li>変更がなければ「変更なし」、変更する場合は「免許証の色」へ進みます</li>' +
                 '</ul>';
        case '免許証の色':
          return '<ul class="list">' +
                   '<li>ゴールド・ブルー・グリーンから選びます（選択済みには✓が表示されます）</li>' +
                   '<li>続いて有効期限の年・月・日を選択してください（ポップアップの四角ボタン）</li>' +
                 '</ul>';
        case 'お客様情報の確認':
          return '<ul class="list">' +
                   '<li>氏名・住所・電話番号・生年月日・勤務先などの登録内容を確認します</li>' +
                   '<li>変更がある場合は「お客様情報の編集」に進んでください</li>' +
                 '</ul>';
        case 'お客様情報の編集':
          return '<ul class="list">' +
                   '<li>氏名・住所・電話・生年月日などを入力します</li>' +
                   '<li>音声入力が利用できます（郵便番号は7桁で市区の住所候補が入ります）</li>' +
                   '<li>生年月日の月・日はポップアップで選択します</li>' +
                 '</ul>';
        case '主に運転する方（記名被保険者）':
          return '<ul class="list">' +
                   '<li>主に運転する方の登録内容を確認します</li>' +
                   '<li>変更がなければ「変更なし」、変更する場合は「主に運転する方の編集」へ進みます</li>' +
                 '</ul>';
        case '主に運転する方の編集':
          return '<ul class="list">' +
                   '<li>氏名・住所・電話・生年月日などを入力します</li>' +
                   '<li>音声入力が利用できます（郵便番号は7桁で市区の住所候補が入ります）</li>' +
                   '<li>生年月日の月・日はポップアップで選択します</li>' +
                 '</ul>';
        case '運転者の範囲と年齢条件':
          return '<ul class="list">' +
                   '<li>運転者の範囲と年齢条件の登録内容を確認します</li>' +
                   '<li>変更がある場合は「運転者範囲・年齢条件の編集」へ進んでください</li>' +
                 '</ul>';
        case '運転者範囲・年齢条件の編集':
          return '<ul class="list">' +
                   '<li>運転者の範囲（本人のみ等）と年齢条件（26歳以上等）を選びます</li>' +
                   '<li>決定したら「OK」で次へ進みます</li>' +
                 '</ul>';
        case '使用目的・走行距離':
          return '<ul class="list">' +
                   '<li>使用目的（通勤・レジャー等）と年間走行距離の目安を選びます</li>' +
                   '<li>変更がなければ「次へ」で進んでください</li>' +
                 '</ul>';
        case '現在の内容を確認':
          return '<ul class="list">' +
                   '<li>現在の補償内容・保険期間・等級を確認します</li>' +
                   '<li>補償のポイント動画や詳細リンクから解説が見られます</li>' +
                 '</ul>';
        case '現在と同じ補償内容で更新した場合の保険料':
          return '<ul class="list">' +
                   '<li>現在と同じ補償内容での保険料（更新後）を確認します</li>' +
                   '<li>主な理由の詳細は「詳細はコチラ」からご覧ください</li>' +
                 '</ul>';
        case '更新方法の選択':
          return '<ul class="list">' +
                   '<li>同じ補償で更新、別プラン、項目ごとの設定から選べます</li>' +
                   '<li>おすすめプラン（充実／保険料重視）も用意しています</li>' +
                 '</ul>';
        case '別のプランから選ぶ':
          return '<ul class="list">' +
                   '<li>タブで「安心重視」「保険料重視」を切り替えます</li>' +
                   '<li>人身傷害・車両保険・特約の変更は「➡」で表示されます</li>' +
                   '<li>選んだプランで進む／項目ごとに設定に進むを選べます</li>' +
                 '</ul>';
        case '人身傷害の金額を選ぶ':
          return '<ul class="list">' +
                   '<li>人身傷害の金額を選びます。無制限や1億円なども選択可能です</li>' +
                   '<li>変更すると月額・年額と差額が更新されます</li>' +
                 '</ul>';
        case '車両保険の金額を選ぶ':
          return '<ul class="list">' +
                   '<li>車両保険の金額を選び、自己負担額（免責）を指定します</li>' +
                   '<li>変更すると月額・年額と差額が更新されます</li>' +
                 '</ul>';
        case '特約の付け外し':
          return '<ul class="list">' +
                   '<li>弁護士費用・代車費用・DAP（ドライブレコーダー）などの特約を選べます</li>' +
                   '<li>選択に応じて月額・年額と差額が更新されます</li>' +
                 '</ul>';
        case '最終見積のまとめ':
          return '<ul class="list">' +
                   '<li>補償内容の変更は「➡」で表示されます</li>' +
                   '<li>人身傷害・車両保険・特約の差分を確認してください</li>' +
                   '<li>修正がある場合は「修正へ戻る」から各項目へ戻れます</li>' +
                 '</ul>';
        case '重要なご説明':
          return '<ul class="list">' +
                   '<li>大切なポイントを短くまとめています。必要に応じて各章をタップで詳しく確認できます</li>' +
                   '<li>全文の確認やPDF受け取りの設定もここで行えます</li>' +
                 '</ul>';
        case '連絡方法を選ぶ':
          return '<ul class="list">' +
                   '<li>メールまたはSMSを選び、連絡先を入力します</li>' +
                   '<li>情報配信の希望も選択できます。必要に応じて変更してください</li>' +
                 '</ul>';
        case '受け取り方法を選ぶ':
          return '<ul class="list">' +
                   '<li>一括選択で全体の設定ができます。個別の変更も可能です</li>' +
                   '<li>約款・証券・更新案内・申込書控えの受け取り方法を選びます</li>' +
                   '<li>迷ったら各項目の「i」ボタンで用語の説明をご覧ください</li>' +
                 '</ul>';
        case '同意と申込':
          return '<ul class="list">' +
                   '<li>内容をご確認のうえ、チェックを入れて「内容に同意して申し込む」を押してください</li>' +
                   '<li>最終のお申込内容はリンクから確認できます</li>' +
                 '</ul>';
        case '申込完了':
          return '<ul class="list">' +
                   '<li>受け取り方法の設定に応じて、約款・証券・控えPDFの送付内容が表示されます</li>' +
                   '<li>次へ（払込方法の確認）から手続きを続けられます</li>' +
                 '</ul>';
        default:
          return fallback;
      }
    }

    // ヘルプモーダル起動（本文差し替え）
    if (typeof window.openHelp !== 'function'){
      window.openHelp = function(){
        try{
          var m = document.getElementById('helpModal');
          var body = document.getElementById('helpBody');
          var titleEl = document.getElementById('helpTitle');
          var curTitle = getActiveTitle();
          if (titleEl) titleEl.textContent = 'ヘルプ（この画面の使い方）';
          if (body) body.innerHTML = helpTextByTitle(curTitle);
          if (m && typeof openModal === 'function') openModal(m);
          else if (m) m.classList.add('show');
          else if (typeof openNotice === 'function') openNotice('本番ではこの画面の使い方についてポイントを解説する内容を表示します');
        }catch(e){}
      };
    } else {
      // 既存 openHelp がある場合も本文差し替えを適用（冪等）
      var origOpenHelp = window.openHelp;
      window.openHelp = function(){
        try{
          var m = document.getElementById('helpModal');
          var body = document.getElementById('helpBody');
          var titleEl = document.getElementById('helpTitle');
          var curTitle = getActiveTitle();
          if (titleEl) titleEl.textContent = 'ヘルプ（この画面の使い方）';
          if (body) body.innerHTML = helpTextByTitle(curTitle);
        }catch(e){}
        try{ origOpenHelp(); }catch(e){}
      };
    }

    // バックドロップで閉じる適用
    document.addEventListener('DOMContentLoaded', function(){
      ['securityCheckModal','helpModal'].forEach(function(id){
        var m = document.getElementById(id);
        if (!m) return;
        m.addEventListener('mousedown', function(e){
          if(e.target === m){
            try{ closeModal(m); }catch(_){ m.classList.remove('show'); }
          }
        });
      });
    });
  })();
</script>
<!-- END: js-help-security-handlers -->

<!-- START: js-term-tips -->
<script>
  (function(){
    if (typeof window.showTermTip !== 'function'){
      window.showTermTip = function(key){
        var msg = '';
        switch(String(key||'')){
          case '免責':
            msg = '免責（自己負担額）：事故のときにご自身で負担いただく金額のことです。免責を大きくすると保険料は下がる傾向があります。';
            break;
          case '約款':
            msg = '約款（ご契約のしおり）：保険の大切なルールをまとめた文書です。Webまたは書面でお受け取りいただけます。';
            break;
          case '保険証券':
            msg = '保険証券：ご契約の証明書です。Web（電子）または書面のどちらでもお選びいただけます。';
            break;
          case '更新案内':
            msg = '更新案内：次回更新時にお知らせするご案内です。Web（電子）または書面で受け取れます。';
            break;
          case '申込書控えPDF':
            msg = '申込書控え（PDF）：今回のお申込内容をPDFでお送りする控えです。必要に応じてメールで送付します。';
            break;
          case '人身傷害':
            msg = '人身傷害保険：自動車事故の際にご契約車両を運転されている方や同乗者の方が死亡、またはケガをされた場合に、治療費や休業損害などを補償する保険です。示談交渉を待たずに総損害額が支払われます。';
            break;
          default:
            msg = '用語の説明をご用意しています。詳しい解説は重要事項やヘルプからもご覧いただけます。';
        }
        try{
          if (typeof openNotice === 'function') openNotice(msg);
          else alert(msg);
        }catch(e){}
      };
    } else {
      // 既存がある場合は「人身傷害」を追記して差し替え
      const orig = window.showTermTip;
      window.showTermTip = function(key){
        if (String(key||'') === '人身傷害'){
          const msg = '人身傷害保険：自動車事故の際にご契約車両を運転されている方や同乗者の方が死亡、またはケガをされた場合に、治療費や休業損害などを補償する保険です。示談交渉を待たずに総損害額が支払われます。';
          try{ if (typeof openNotice === 'function') openNotice(msg); else alert(msg); }catch(e){}
          return;
        }
        try{ orig(key); }catch(e){}
      };
    }
  })();
</script>
<!-- END: js-term-tips -->

<!-- START: js-license-color-helper -->
<script>
  (function(){
    function safeFocus(id){
      try{
        const el = document.getElementById(id);
        if (el && el.offsetParent && typeof el.focus === 'function'){
          setTimeout(()=>{ try{ el.focus(); }catch(e){} }, 0);
        }
      }catch(e){}
    }

    if (typeof window.selectColor !== 'function'){
      window.selectColor = function(name, el){
        // ボタンのactive切り替え
        try{
          document.querySelectorAll('.colorBtn').forEach(function(b){ b.classList.remove('active'); });
          if (el && el.classList) el.classList.add('active');
        }catch(e){}

        // 可能ならトースト通知（未定義時は無視）
        try{ if (typeof showToast === 'function') showToast(name + 'を選択しました'); }catch(e){}

        // フォーカス移動：免許証の色選択後 → 有効期限の年
        safeFocus('licenseYear');
      };
    } else {
      // 既存 selectColor がある場合は、終了時にフォーカスだけ追加
      const orig = window.selectColor;
      window.selectColor = function(name, el){
        try{ orig(name, el); }catch(e){}
        safeFocus('licenseYear');
      };
    }
  })();
</script>
<!-- END: js-license-color-helper -->

<!-- START: js-vehicle-handlers -->
<script>
(function(){
  function safeFocus(id){
    try{
      const el = document.getElementById(id);
      if (el && el.offsetParent && typeof el.focus === 'function'){
        setTimeout(()=>{ try{ el.focus({preventScroll:true}); }catch(e){ try{ el.focus(); }catch(_){}} }, 0);
      }
    }catch(e){}
  }

  // select向けの安定フォーカス（iOSでの一瞬のピッカー開閉→フォーカス消失を抑止）
  function focusSelectSafely(id){
    try{
      const el = document.getElementById(id);
      if (!el || !el.offsetParent) return;

      // 直前のアクティブ要素を確実にblurしてから実行
      try{
        if (document.activeElement && typeof document.activeElement.blur === 'function'){
          document.activeElement.blur();
        }
      }catch(e){}

      // ネイティブドロップダウンの自動オープン抑止のため、一時的にpointer-eventsを無効化
      const prevPointerEvents = el.style.pointerEvents;
      el.style.pointerEvents = 'none';

      // レイアウト確定後に2段階でフォーカス（タイミング依存の端末で安定化）
      requestAnimationFrame(()=>{
        requestAnimationFrame(()=>{
          setTimeout(()=>{
            try{
              el.focus({preventScroll:true});
            }catch(e){
              try{ el.focus(); }catch(_){}
            }
            // 短時間の猶予後にpointer-eventsを戻す
            setTimeout(()=>{ el.style.pointerEvents = prevPointerEvents || ''; }, 160);
          }, 40);
        });
      });
    }catch(e){}
  }

  if (typeof window.onMakerChange !== 'function') {
    window.onMakerChange = function(){
      try{
        const maker = document.getElementById('maker')?.value || '';
        const modelField = document.getElementById('modelField');
        const typeField  = document.getElementById('typeField');
        if (modelField) modelField.style.display = 'block';
        if (typeField)  typeField.style.display  = 'block';
        const modelSel = document.getElementById('model');
        const typeSel  = document.getElementById('type');
        if (!maker){
          if (modelSel) modelSel.value = '';
          if (typeSel)  typeSel.value  = '';
        }
        // フォーカス移動：メーカー選択後 → 車名（安定版）
        if (maker){ focusSelectSafely('model'); }
      }catch(e){}
    };
  } else {
    // 既存がある場合は上書き（安定版フォーカスに差し替え）
    const orig = window.onMakerChange;
    window.onMakerChange = function(){
      try{ orig(); }catch(e){}
      try{
        const maker = document.getElementById('maker')?.value || '';
        if (maker){ focusSelectSafely('model'); }
      }catch(e){}
    };
  }

  if (typeof window.onModelChange !== 'function') {
    window.onModelChange = function(){
      try{
        const model = document.getElementById('model')?.value || '';
        const typeField = document.getElementById('typeField');
        if (typeField) typeField.style.display = 'block';
        const typeSel = document.getElementById('type');
        if (typeSel && model === 'prius' && !typeSel.value){
          typeSel.value = 'ZVW50';
        }
        // フォーカス移動：車名選択後 → 型式（安定版）
        if (model){ focusSelectSafely('type'); }
      }catch(e){}
    };
  } else {
    const orig2 = window.onModelChange;
    window.onModelChange = function(){
      try{ orig2(); }catch(e){}
      try{
        const model = document.getElementById('model')?.value || '';
        if (model){ focusSelectSafely('type'); }
      }catch(e){}
    };
  }

  // 住所補完（お客様）：上書き・重複なし
  if (typeof window.mockZipToAddress !== 'function') {
    window.mockZipToAddress = function(zip){
      try{
        const z = String(zip || '').replace(/[^\d]/g,'');
        if (z.length === 7){
          const addr = document.getElementById('addr');
          if (addr) addr.value = '東京都港区赤坂';
        }
      }catch(e){}
    };
  }

  if (typeof window.validateFirstRegSelect !== 'function') {
    window.validateFirstRegSelect = function(){
      try{
        const y = document.getElementById('firstRegYear')?.value || '';
        const m = document.getElementById('firstRegMonth')?.value || '';
        if (!y || !m){
          if (typeof openNotice === 'function') openNotice('初度登録年月を「年・月」から選んでください');
          return false;
        }
        const now = new Date();
        const sel = new Date(Number(y), Number(m)-1, 1);
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        if (sel > thisMonth){
          if (typeof openNotice === 'function') openNotice('初度登録年月は未来を選べません');
          return false;
        }
        return true;
      }catch(e){
        if (typeof openNotice === 'function') openNotice('初度登録年月の確認でエラーが発生しました。再度お試しください。');
        return false;
      }
    };
  }

  if (typeof window.validateVIN !== 'function') {
    window.validateVIN = function(){
      try{
        const vin     = (document.getElementById('vin')?.value || '').trim();
        const plateEl = document.getElementById('plate');
        const plate   = plateEl?.value?.trim() || '';
        if (vin.length < 8){
          if (typeof openNotice === 'function') openNotice('車台番号を入力してください（例：ZVW50-1234567）');
          return false;
        }
        const digits = plate.replace(/[^\d]/g,'').slice(-4);
        if (digits.length < 4){
          if (typeof openNotice === 'function') openNotice('ナンバー（数字4桁）を入力してください（例：12-34）');
          return false;
        }
        if (plateEl){
          plateEl.value = digits.slice(0,2) + '-' + digits.slice(2);
        }
        return true;
      }catch(e){
        if (typeof openNotice === 'function') openNotice('入力内容の確認でエラーが発生しました。再度お試しください。');
        return false;
      }
    };
  }

  // 型式選択 → 初度登録年 へフォーカス（安定版）
  document.addEventListener('DOMContentLoaded', function(){
    try{
      const typeSel = document.getElementById('type');
      if (typeSel){
        typeSel.addEventListener('change', function(){
          if (typeSel.value){ focusSelectSafely('firstRegYear'); }
        });
      }
    }catch(e){}
  });
})();
</script>
<!-- END: js-vehicle-handlers -->

<!-- START: js-choice-toggles -->
<script>
(function(){
  const groups = [
    {keys:['contact_email','contact_sms'], label:'連絡方法'},
    {keys:['terms_web','terms_paper'],   label:'約款'},
    {keys:['cert_web','cert_paper'],     label:'保険証券'},
    {keys:['notice_web','notice_paper'], label:'次回更新案内'},
    {keys:['pdf_yes','pdf_no'],          label:'申込書控えPDF送付'}
  ];

  function safeFocus(id){
    try{
      const el = document.getElementById(id);
      if (el && el.offsetParent && typeof el.focus === 'function'){
        setTimeout(()=>{ try{ el.focus(); }catch(e){} }, 0);
      }
    }catch(e){}
  }

  function initA11y(){
    document.querySelectorAll('.choiceRow').forEach(row=>{
      const btns = row.querySelectorAll('.choiceToggle');
      const isImportantRow = btns[0]?.id?.startsWith('imp_choice_');
      if (!isImportantRow){
        row.setAttribute('role','radiogroup');
        if(!row.getAttribute('aria-label')){
          const prevLabel = row.closest('.field')?.querySelector('.label');
          if(prevLabel) row.setAttribute('aria-label', prevLabel.textContent.trim());
        }
        btns.forEach((b,idx)=>{
          b.setAttribute('role','radio');
          b.setAttribute('tabindex', idx===0 ? '0' : '-1');
          b.setAttribute('aria-checked', b.classList.contains('active') ? 'true' : 'false');
          b.addEventListener('keydown', e=>{
            const keys = ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'];
            if(!keys.includes(e.key)) return;
            e.preventDefault();
            const list = Array.from(row.querySelectorAll('.choiceToggle'));
            const curIndex = list.indexOf(b);
            let nextIndex = curIndex;
            if(e.key==='ArrowRight' || e.key==='ArrowDown'){
              nextIndex = (curIndex + 1) % list.length;
            }else{
              nextIndex = (curIndex - 1 + list.length) % list.length;
            }
            const nextBtn = list[nextIndex];
            if(nextBtn){
              nextBtn.click();
              nextBtn.focus();
            }
          });
        });
      } else {
        row.setAttribute('role','group');
        btns.forEach(b=>{
          b.setAttribute('role','button');
          b.setAttribute('tabindex', '0');
        });
      }
    });
  }

  function pairKey(key){
    if (key==='contact_email') return 'contact_sms';
    if (key==='contact_sms')   return 'contact_email';
    if (key==='terms_web')     return 'terms_paper';
    if (key==='terms_paper')   return 'terms_web';
    if (key==='cert_web')      return 'cert_paper';
    if (key==='cert_paper')    return 'cert_web';
    if (key==='notice_web')    return 'notice_paper';
    if (key==='notice_paper')  return 'notice_web';
    if (key==='pdf_yes')       return 'pdf_no';
    if (key==='pdf_no')        return 'pdf_yes';
    if (key==='gender_m')      return 'gender_f';
    if (key==='gender_f')      return 'gender_m';
    if (key==='gender_m2')     return 'gender_f2';
    if (key==='gender_f2')     return 'gender_m2';
    return '';
  }

  window.toggleChoice = function(key){
    try{
      const btn = document.getElementById('choice_'+key);
      if(!btn) return;
      const willActivate = !btn.classList.contains('active');
      btn.classList.toggle('active', willActivate);
      const otherKey = pairKey(key);
      if (willActivate && otherKey){
        const other = document.getElementById('choice_'+otherKey);
        if (other) other.classList.remove('active');
      }
      const row = btn.closest('.choiceRow');
      if(row){
        const list = row.querySelectorAll('.choiceToggle');
        list.forEach((b)=>{
          const isOn = b.classList.contains('active');
          b.setAttribute('aria-checked', isOn ? 'true' : 'false');
          b.setAttribute('tabindex', isOn ? '0' : '-1');
        });
      }

      // 性別選択完了後に郵便番号へフォーカス
      if (willActivate){
        if (key === 'gender_m' || key === 'gender_f'){
          safeFocus('zip');
        } else if (key === 'gender_m2' || key === 'gender_f2'){
          safeFocus('md_zip');
        }
      }
    }catch(e){}
  };

  window.toggleMultiChoice = function(key){
    try{
      const id = key==='imp_full' ? 'imp_choice_full' : (key==='imp_pdf' ? 'imp_choice_pdf' : '');
      const btn = document.getElementById(id);
      if(!btn) return;

      const willActivate = !btn.classList.contains('active');
      btn.classList.toggle('active');

      if (willActivate && typeof openNotice === 'function') {
        if (key === 'imp_full') {
          openNotice('本番では全文表示画面に推移します');
        } else if (key === 'imp_pdf') {
          openNotice('本番ではPDFをメールで送信する画面に推移します');
        }
      }
    }catch(e){}
  };

  window.finishContactChoice = function(){
    try{
      const email = document.getElementById('choice_contact_email');
      const sms   = document.getElementById('choice_contact_sms');
      const selected = (email && email.classList.contains('active')) || (sms && sms.classList.contains('active'));
      if(!selected){
        const msg = '連絡方法を1つ選んでください';
        if (typeof openNotice === 'function') openNotice(msg); else alert(msg);
        return;
      }
      if (typeof goToTitle === 'function') goToTitle('受け取り方法を選ぶ');
    }catch(e){}
  };

  window.finishReceiveMethod = function(type){
    try{
      const setChoiceActive = (idSuffix, active)=>{
        const el = document.getElementById('choice_'+idSuffix);
        if(!el) return;
        el.classList.toggle('active', !!active);
        el.setAttribute('aria-checked', active ? 'true' : 'false');
        el.setAttribute('tabindex', active ? '0' : '-1');
      };

      const setAll = (isWeb)=>{
        setChoiceActive('terms_web',  isWeb);
        setChoiceActive('terms_paper',!isWeb);
        setChoiceActive('cert_web',   isWeb);
        setChoiceActive('cert_paper', !isWeb);
        setChoiceActive('notice_web', isWeb);
        setChoiceActive('notice_paper',!isWeb);
        setChoiceActive('pdf_no',     isWeb);
        setChoiceActive('pdf_yes',    !isWeb);
        window.choiceState = window.choiceState || {};
        ['terms_web','terms_paper','cert_web','cert_paper','notice_web','notice_paper','pdf_yes','pdf_no'].forEach(k=>{
          const el = document.getElementById('choice_'+k);
          window.choiceState[k] = !!(el && el.classList.contains('active'));
        });
      };

      if (type === 'paper'){
        setAll(false);
        goToTitle && goToTitle('同意と申込');
      }else if (type === 'web'){
        setAll(true);
        goToTitle && goToTitle('同意と申込');
      }else{
        goToTitle && goToTitle('受け取り方法を選ぶ');
      }
    }catch(e){}
  };

  window.finishWebPaper = function(){
    try{
      const groups = [
        {keys:['terms_web','terms_paper'],   label:'約款'},
        {keys:['cert_web','cert_paper'],     label:'保険証券'},
        {keys:['notice_web','notice_paper'], label:'次回更新案内'},
        {keys:['pdf_yes','pdf_no'],          label:'申込書控えPDF送付'}
      ];
      const missing = [];
      groups.forEach(g=>{
        const a = document.getElementById('choice_'+g.keys[0]);
        const b = document.getElementById('choice_'+g.keys[1]);
        const selected = (a && a.classList.contains('active')) || (b && b.classList.contains('active'));
        if(!selected) missing.push(g.label);
      });

      if(missing.length){
        const msg = missing.map(m=> `${m}を1つ選んでください`).join('\n');
        if (typeof openNotice === 'function') openNotice(msg); else alert(msg);
        return;
      }

      try{
        window.choiceState = window.choiceState || {};
        ['terms_web','terms_paper','cert_web','cert_paper','notice_web','notice_paper','pdf_yes','pdf_no'].forEach(k=>{
          const el = document.getElementById('choice_'+k);
          window.choiceState[k] = !!(el && el.classList.contains('active'));
        });
      }catch(e){}

      goToTitle && goToTitle('同意と申込');
    }catch(e){}
  };

  window.finishImportantNext = function(){
    try{
      const full = document.getElementById('imp_choice_full')?.classList.contains('active');
      const pdf  = document.getElementById('imp_choice_pdf')?.classList.contains('active');
      if(!full && !pdf){
        const msg = '全文を表示するかPDFで受け取る（メール送付）のどちらかを選んでください';
        if (typeof openNotice === 'function') openNotice(msg); else alert(msg);
        return;
      }
      try{ window.flagSendPdf = !!pdf; }catch(e){}
      goToTitle && goToTitle('連絡方法を選ぶ');
    }catch(e){}
  };

  document.addEventListener('DOMContentLoaded', initA11y);
})();
</script>
<!-- END: js-choice-toggles -->

<!-- START: js-ai-choice -->
<script>
(function(){
  window.openAiChoice = function(){
    var m = document.getElementById('aiChoiceModal');
    if (m && typeof openModal === 'function') {
      openModal(m);
    } else {
      if (typeof openNotice === 'function') {
        openNotice('本番ではAIとの自然言語もしくはチャットでの対話画面に推移します。');
      }
    }
  };

  window.aiChoiceSelect = function(type){
    try{
      var voice = document.getElementById('ai_choice_voice');
      var chat  = document.getElementById('ai_choice_chat');
      if (voice && chat) {
        voice.classList.toggle('active', type==='voice');
        chat.classList.toggle('active',  type==='chat');
      }

      var m = document.getElementById('aiChoiceModal');
      if (m && typeof closeModal === 'function') closeModal(m);

      if (typeof openNotice === 'function') {
        openNotice('本番ではAIとの自然言語もしくはチャットでの対話画面に推移します。');
      } else {
        alert('本番ではAIとの自然言語もしくはチャットでの対話画面に推移します。');
      }
    }catch(e){}
  };
})();
</script>
<!-- END: js-ai-choice -->

<!-- START: js-voice-input -->
<script>
(function(){
  // 拡張版 音声入力：氏名/住所/電話/郵便/勤務先/VINに対応
  // ミニインジケーター表示＋終了時フェードアウト、入力後の自動フォーカス（郵便→住所→電話→生年月日の年）を復活
  let recognition = null;
  let recognizing = false;
  let supported = false;
  let targetFieldId = null;
  let modeDigitsOnly = false;
  let lastFinalTranscript = '';
  let hideStatusTid = null;

  function getEl(id){ try{ return document.getElementById(id); }catch(e){ return null; } }
  function isActiveField(fieldId){
    try{
      const el = getEl(fieldId);
      if (!el) return false;
      if (!el.offsetParent) return false;
      const scr = el.closest('.screen');
      return !!(scr && scr.classList.contains('active'));
    }catch(e){ return false; }
  }

  // フッター音声ステータス
  function showVoiceStatus(){
    try{ const s=getEl('voiceStatus'); if(s) s.style.display=''; }catch(e){}
  }
  function setStatus(text){
    const s = getEl('voiceStatus');
    if (s){ s.textContent = String(text || ''); showVoiceStatus(); }
  }
  function applyShrinkThenHide(el){
    try{
      if (!el) return;
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReduced){
        el.style.display = 'none';
        el.classList.remove('fadeShrink');
        return;
      }
      el.classList.add('fadeShrink');
      setTimeout(()=>{ el.style.display = 'none'; el.classList.remove('fadeShrink'); }, 250);
    }catch(e){}
  }
  function hideVoiceStatusDelayed(ms){
    try{
      clearTimeout(hideStatusTid);
      hideStatusTid = setTimeout(()=>{
        const s=getEl('voiceStatus');
        if(s) applyShrinkThenHide(s);
      }, ms||0);
    }catch(e){}
  }

  // ミニインジケーター（フィールド近傍）
  function ensureIndicatorHost(fieldId){
    const inp = getEl(fieldId); if(!inp) return null;
    if (!inp.__voiceIndicator){
      const ind = document.createElement('div');
      ind.className = 'voiceIndicator ready';
      ind.innerHTML = '<span class="dot"></span><span class="text">音声の準備中…</span>';
      inp.insertAdjacentElement('afterend', ind);
      inp.__voiceIndicator = ind;
    }
    return inp.__voiceIndicator;
  }
  function setIndicator(fieldId, stateText, stateClass){
    try{
      const ind = ensureIndicatorHost(fieldId);
      if (!ind) return;
      ind.style.display = '';
      ind.classList.remove('ready','recording','recognizing','fadeShrink');
      ind.classList.add(stateClass || 'ready');
      const t = ind.querySelector('.text');
      if (t) t.textContent = stateText || '音声の準備中…';
    }catch(e){}
  }
  function hideIndicator(fieldId){
    try{
      const inp = getEl(fieldId);
      const ind = inp && inp.__voiceIndicator;
      if (ind){ applyShrinkThenHide(ind); return; }
      if (fieldId){
        const fallback = document.querySelector('#'+CSS.escape(fieldId)+' + .voiceIndicator');
        if (fallback){ applyShrinkThenHide(fallback); return; }
      }
    }catch(e){}
  }

  // 入力後の自動フォーカス（郵便→住所→電話→生年月日の年）
  function focusNextForField(fid){
    try{
      const map = {
        'zip':        'addr',
        'addr':       'cust_phone',
        'cust_phone': 'dobYear',
        'md_zip':     'md_addr',
        'md_addr':    'md_phone',
        'md_phone':   'md_dobYear'
      };
      const nextId = map[fid];
      if (!nextId) return;
      const nextEl = getEl(nextId);
      if (nextEl && isActiveField(nextId) && typeof nextEl.focus === 'function'){
        setTimeout(()=>{ try{ nextEl.focus(); }catch(e){} }, 0);
      }
    }catch(e){}
  }

  // 正規化ヘルパー
  function normalizeDashesAndSpaces(s){
    let t = String(s || '');
    t = t.replace(/ー|−|―|‐|–|—/g, '-');
    t = t.replace(/ハイフン|ダッシュ|まいなす|マイナス|minus/gi, '-');
    t = t.replace(/スペース|空白|ブランク/gi, ' ');
    return t;
  }
  function normalizeDigitsJa(s){
    if (!s) return '';
    let t = normalizeDashesAndSpaces(s);
    t = t.replace(/の|ノ|ー/g, '');
    t = t.replace(/[、。.,\s]/g, '');
    const map = [
      {re:/ゼロ|れい|レイ|零|〇|○/gi, rep:'0'},
      {re:/いち|イチ|一/gi, rep:'1'},
      {re:/に|ニ|二/gi, rep:'2'},
      {re:/さん|サン|三/gi, rep:'3'},
      {re:/よん|ヨン|四/gi, rep:'4'},
      {re:/ご|ゴ|五/gi, rep:'5'},
      {re:/ろく|ロク|六/gi, rep:'6'},
      {re:/なな|ナナ|七/gi, rep:'7'},
      {re:/はち|ハチ|八/gi, rep:'8'},
      {re:/きゅう|キュウ|九/gi, rep:'9'}
    ];
    map.forEach(m => { t = t.replace(m.re, m.rep); });
    t = t.replace(/[０-９]/g, d=> String.fromCharCode(d.charCodeAt(0)-0xFEE0));
    t = t.replace(/[^\d]/g, '');
    return t;
  }
  function normalizeVinSpeech(s){
    if (!s) return '';
    let t = normalizeDashesAndSpaces(s);
    t = t.replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch=> String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    t = t.replace(/[、。.,\s]/g, '');
    t = t.replace(/[^A-Za-z0-9-]/g, '');
    t = t.replace(/-+/g, '-');
    return t.toUpperCase();
  }
  function formatPhoneDisplay(d){
    const p = String(d || '');
    if (p.length === 11) return `${p.slice(0,3)}-${p.slice(3,7)}-${p.slice(7)}`;
    if (p.length === 10) return `${p.slice(0,3)}-${p.slice(3,6)}-${p.slice(6)}`;
    return p;
  }
  function formatZipDisplay(d){
    const z = String(d || '');
    if (z.length === 7) return `${z.slice(0,3)}-${z.slice(3)}`;
    return z;
  }

  function putValue(fieldId, valueText){
    if (!isActiveField(fieldId)) return;
    const inp = getEl(fieldId);
    if(!inp) return;
    let v = String(valueText||'').trim();

    if (fieldId === 'cust_phone' || fieldId === 'md_phone'){
      v = formatPhoneDisplay(normalizeDigitsJa(v));
    } else if (fieldId === 'zip' || fieldId === 'md_zip'){
      v = formatZipDisplay(normalizeDigitsJa(v));
    } else if (fieldId === 'vin'){
      v = normalizeVinSpeech(v);
    } else {
      v = normalizeDashesAndSpaces(v);
      v = v.replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch=> String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
    }

    inp.value = v;

    // 住所補完（郵便7桁時のみ、未入力のとき一度だけ実行）
    try{
      if (fieldId === 'zip'){
        const addrEl = getEl('addr');
        const zipDigits = v.replace(/[^\d]/g,'');
        if (addrEl && !addrEl.value && typeof window.mockZipToAddress === 'function' && zipDigits.length === 7){
          window.mockZipToAddress(zipDigits);
        }
      }
      if (fieldId === 'md_zip'){
        const addrEl = getEl('md_addr');
        const zipDigits = v.replace(/[^\d]/g,'');
        if (addrEl && !addrEl.value && typeof window.mdZipToAddress === 'function' && zipDigits.length === 7){
          window.mdZipToAddress(zipDigits);
        }
      }
    }catch(e){}

    // 入力後：次フィールドへ自動移動
    focusNextForField(fieldId);
  }

  // 未対応端末ガイド
  function softFallbackGuide(){
    if (targetFieldId && isActiveField(targetFieldId)){
      try{
        const el = getEl(targetFieldId);
        if (el && typeof el.focus === 'function') el.focus();
        setStatus('この端末ではブラウザの音声認識が未対応です。キーボードのマイクをご利用ください。');
        if (typeof showToast === 'function') showToast('音声認識は未対応です。キーボードのマイクをご利用ください');
        setIndicator(targetFieldId, '未対応：キーボードのマイクをご利用ください', 'ready');
      }catch(e){}
    }
    recognizing = false;
    hideVoiceStatusDelayed(0);
    hideIndicator(targetFieldId);
    targetFieldId = null;
    modeDigitsOnly = false;
    lastFinalTranscript = '';
  }

  // 疑似入力（デモ用フォールバック）
  function fallbackMock(reasonText){
    try{ setStatus(reasonText || '音声認識で問題が発生しました'); }catch(e){}
    if (targetFieldId && isActiveField(targetFieldId)){
      switch (targetFieldId) {
        case 'cust_name':
        case 'mainDriverName': putValue(targetFieldId, '山田 花子'); break;
        case 'zip':
        case 'md_zip':         putValue(targetFieldId, '1050001'); break;
        case 'addr':
        case 'md_addr':        putValue(targetFieldId, '東京都港区赤坂'); break;
        case 'cust_phone':
        case 'md_phone':       putValue(targetFieldId, '09012345678'); break;
        case 'company':
        case 'md_company':     putValue(targetFieldId, 'ABC株式会社'); break;
        case 'vin':            putValue(targetFieldId, 'ZVW50-1234567'); break;
        default: break;
      }
    }
    recognizing = false;
    hideVoiceStatusDelayed(0);
    hideIndicator(targetFieldId);
    targetFieldId = null;
    modeDigitsOnly = false;
    lastFinalTranscript = '';
  }

  function initRecognizer(){
    try{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ supported = false; return; }
      recognition = new SR();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = true;

      recognition.onstart = function(){
        recognizing = true;
        lastFinalTranscript = '';
        setStatus('録音中です。お話しください…');
        if (targetFieldId) setIndicator(targetFieldId, '録音中…', 'recording');
      };
      recognition.onerror = function(evt){
        recognizing = false;
        if(evt && evt.error === 'not-allowed'){
          setStatus('マイク権限が拒否されました。権限を許可してください。');
          setIndicator(targetFieldId, '権限が必要です', 'ready');
          fallbackMock('マイク権限が拒否されました。');
        }else{
          setStatus('音声認識でエラーが発生しました。');
          setIndicator(targetFieldId, 'エラーが発生しました', 'ready');
          fallbackMock('音声認識でエラーが発生しました。');
        }
      };
      recognition.onend = function(){
        recognizing = false;

        if (targetFieldId && isActiveField(targetFieldId)){
          const buf = String(lastFinalTranscript || '').trim();
          if (modeDigitsOnly){
            if (buf){ putValue(targetFieldId, normalizeDigitsJa(buf)); }
            else if (!getEl(targetFieldId)?.value){ fallbackMock('入力が確認できませんでした。'); }
          }else{
            if (!getEl(targetFieldId)?.value){ fallbackMock('入力が確認できませんでした。'); }
          }
        }

        // 認識完了後：すぐフェードアウト
        const fid = targetFieldId;
        setIndicator(fid, '認識完了', 'recognizing');
        hideVoiceStatusDelayed(0);
        hideIndicator(fid);

        targetFieldId = null;
        modeDigitsOnly = false;
        lastFinalTranscript = '';
      };
      recognition.onresult = function(evt){
        try{
          let finalChunk='', interimAccum='';
          for(let i=evt.resultIndex;i<evt.results.length;i++){
            const res=evt.results[i]; const text=res[0]?.transcript||'';
            if(res.isFinal) finalChunk+=text; else interimAccum+=text;
          }
          if (finalChunk) lastFinalTranscript = finalChunk;

          if (modeDigitsOnly){
            if (finalChunk){
              const normalized = normalizeDigitsJa(finalChunk);
              if (targetFieldId && isActiveField(targetFieldId)) putValue(targetFieldId, normalized);
            }
            setStatus('認識中…');
            if (targetFieldId) setIndicator(targetFieldId, '認識中…', 'recognizing');
          } else {
            const raw = (finalChunk || interimAccum);
            const normalized = normalizeDashesAndSpaces(raw).replace(/[、。.,]/g, ' ').replace(/\s+/g, ' ').trim();
            if (targetFieldId && isActiveField(targetFieldId)) putValue(targetFieldId, normalized);
            setStatus('認識中…');
            if (targetFieldId) setIndicator(targetFieldId, '認識中…', 'recognizing');
          }
        }catch(e){
          setStatus('認識結果の処理に失敗しました。');
          setIndicator(targetFieldId, '処理に失敗しました', 'ready');
          fallbackMock('認識結果の処理に失敗しました。');
        }
      };

      supported = true;
    }catch(e){ supported = false; }
  }

  // 公開API
  window.cancelVoiceInput = function(){
    try{ if(recognizing && recognition){ recognition.stop(); } }catch(e){}
    recognizing = false;
    setStatus('停止しました。');
    if (targetFieldId) setIndicator(targetFieldId, '停止しました', 'ready');
    const fid = targetFieldId;
    hideVoiceStatusDelayed(0);
    hideIndicator(fid);
    targetFieldId = null;
    modeDigitsOnly = false;
    lastFinalTranscript = '';
  };

  window.startVoiceForField = function(fieldId, mode){
    targetFieldId = fieldId;
    modeDigitsOnly = (mode === 'digits');
    lastFinalTranscript = '';
    setStatus('録音の準備をしています…');
    setIndicator(fieldId, '準備中…', 'ready');

    if(recognition === null) initRecognizer();
    if (!supported || !recognition){
      softFallbackGuide();
      return;
    }
    try{ recognition.interimResults = true; }catch(e){}
    try{
      recognition.start();
      setStatus('録音中です。お話しください…');
      setIndicator(fieldId, '録音中…', 'recording');
    }catch(e){
      setStatus('音声認識の開始に失敗しました。');
      setIndicator(fieldId, '開始に失敗しました', 'ready');
      fallbackMock('音声認識の開始に失敗しました。');
    }
  };

  // VIN（車台番号）専用
  window.startVoiceForVin = function(){
    targetFieldId = 'vin';
    modeDigitsOnly = false;
    lastFinalTranscript='';
    setStatus('録音です。車台番号（例：ZVW50-1234567）をお話しください…');

    if(recognition === null) initRecognizer();
    if (!supported || !recognition){
      softFallbackGuide();
      return;
    }
    try{ recognition.interimResults = true; }catch(e){}
    try{ recognition.start(); setIndicator('vin','録音中…','recording'); }
    catch(e){ setStatus('音声認識の開始に失敗しました。'); setIndicator('vin','開始に失敗しました','ready'); }
  };
})();
</script>
<!-- END: js-voice-input -->

<!-- START: js-voice-input-extend -->
<script>
(function(){
  // 既存の next-field チェーンを補完（通常入力チェーンは js-core 側に依存）
  // 本拡張では、モード完了後の追加フォーカス連携（メーカー→車名→型式→初度登録年、色→有効期限年、性別→郵便、誕生日→勤務先）を維持
  // 上位ブロックで reflect/focus を済ませているため、ここでは保守用のユーティリティのみ提供

  // 互換案内（未対応端末／トースト）
  window.voiceGuideHint = function(msg){
    try{
      if (typeof showToast === 'function') showToast(msg || 'キーボードのマイクをご利用ください');
      else alert(msg || 'キーボードのマイクをご利用ください');
    }catch(e){}
  };

  // 追加フォーカスの安全呼び出し（必要箇所で利用）
  window.safeFocus = function(id){
    try{
      const el = document.getElementById(id);
      if (el && el.offsetParent && typeof el.focus === 'function'){
        setTimeout(()=>{ try{ el.focus(); }catch(e){} }, 0);
      }
    }catch(e){}
  };
})();
</script>
<!-- END: js-voice-input-extend -->

<!-- START: js-md-zip-helper -->
<script>
(function(){
  // ② 主運転者の住所補完（上書き・重複なし）
  window.mdZipToAddress = function(zip){
    try{
      const z = String(zip || '').replace(/[^\d]/g,'');
      if (z.length === 7){
        const addr = document.getElementById('md_addr');
        if (addr) addr.value = '東京都港区赤坂';
      }
    }catch(e){}
  };
})();
</script>
<!-- END: js-md-zip-helper -->

<!-- START: js-large-label-override -->
<script>
  (function(){
    window.applyLarge = function(on){
      document.body.classList.toggle('large', !!on);
      var l = document.getElementById('lblLarge');
      if (l) l.textContent = on ? '文字縮小' : '文字拡大';
    };
    window.toggleLarge = function(){
      applyLarge(!document.body.classList.contains('large'));
    };
    document.addEventListener('DOMContentLoaded', function(){
      var l = document.getElementById('lblLarge');
      if (l) l.textContent = document.body.classList.contains('large') ? '文字縮小' : '文字拡大';
    });
  })();
</script>
<!-- END: js-large-label-override -->

<!-- START: js-guided-voice-override -->
<script>
  (function(){
    // 既存のstopGuidedVoiceを安全に上書きし、ガイド用キューも確実に止める
    var origStop = window.stopGuidedVoice;
    window.stopGuidedVoice = function(){
      // 1) キュー側の進行フラグを停止（speakQueue内のcancelledをtrueにする）
      try{
        if (typeof guidedCancelFn === 'function') guidedCancelFn();
      }catch(e){}

      // 2) ブラウザの読み上げも停止
      try{
        if ('speechSynthesis' in window) speechSynthesis.cancel();
      }catch(e){}

      // 3) 状態フラグとボタン表示を更新
      try{ guidedSpeaking = false; }catch(e){}
      try{ if (typeof setGuidedBtn === 'function') setGuidedBtn(); }catch(e){}

      // 4) 元の停止処理があれば呼び出し（冪等）
      if (typeof origStop === 'function'){
        try{ origStop(); }catch(e){}
      }
    };
  })();
</script>
<!-- END: js-guided-voice-override -->

</html>
